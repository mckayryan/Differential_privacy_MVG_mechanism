<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CSVExporter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">synthea</a> &gt; <a href="index.source.html" class="el_package">org.mitre.synthea.export</a> &gt; <span class="el_source">CSVExporter.java</span></div><h1>CSVExporter.java</h1><pre class="source lang-java linenums">package org.mitre.synthea.export;

import static org.mitre.synthea.export.ExportHelper.dateFromTimestamp;
import static org.mitre.synthea.export.ExportHelper.iso8601Timestamp;

import com.google.common.collect.Table;
import com.google.gson.JsonObject;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.math.BigDecimal;
import java.math.RoundingMode;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.Locale;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.atomic.AtomicInteger;

import org.mitre.synthea.engine.Event;
import org.mitre.synthea.helpers.Config;
import org.mitre.synthea.helpers.Utilities;
import org.mitre.synthea.world.agents.Clinician;
import org.mitre.synthea.world.agents.Person;
import org.mitre.synthea.world.agents.Provider;
import org.mitre.synthea.world.concepts.HealthRecord;
import org.mitre.synthea.world.concepts.HealthRecord.CarePlan;
import org.mitre.synthea.world.concepts.HealthRecord.Code;
import org.mitre.synthea.world.concepts.HealthRecord.Encounter;
import org.mitre.synthea.world.concepts.HealthRecord.Entry;
import org.mitre.synthea.world.concepts.HealthRecord.ImagingStudy;
import org.mitre.synthea.world.concepts.HealthRecord.Medication;
import org.mitre.synthea.world.concepts.HealthRecord.Observation;
import org.mitre.synthea.world.concepts.HealthRecord.Procedure;

/**
 * Researchers have requested a simple table-based format
 * that could easily be imported into any database for analysis.
 * Unlike other formats which export a single record per patient,
 * this format generates 9 total files,
 * and adds lines to each based on the clinical events for each patient.
 * These files are intended to be analogous to database tables,
 * with the patient UUID being a foreign key.
 * Files include:
 * patients.csv, encounters.csv, allergies.csv,
 * medications.csv, conditions.csv, careplans.csv,
 * observations.csv, procedures.csv, and immunizations.csv.
 */
public class CSVExporter {
  /**
   * Writer for patients.csv.
   */
  private FileWriter patients;
  /**
   * Writer for allergies.csv.
   */
  private FileWriter allergies;
  /**
   * Writer for medications.csv.
   */
  private FileWriter medications;
  /**
   * Writer for conditions.csv.
   */
  private FileWriter conditions;
  /**
   * Writer for careplans.csv.
   */
  private FileWriter careplans;
  /**
   * Writer for observations.csv.
   */
  private FileWriter observations;
  /**
   * Writer for procedures.csv.
   */
  private FileWriter procedures;
  /**
   * Writer for immunizations.csv.
   */
  private FileWriter immunizations;
  /**
   * Writer for encounters.csv.
   */
  private FileWriter encounters;
  /**
   * Writer for imaging_studies.csv
   */
  private FileWriter imagingStudies;
  /**
   * Writer for organizations.csv
   */
  private FileWriter organizations;
  /**
   * Writer for providers.csv
   */
  private FileWriter providers;

  /**
   * System-dependent string for a line break. (\n on Mac, *nix, \r\n on Windows)
   */
<span class="fc" id="L103">  private static final String NEWLINE = System.lineSeparator();</span>

  /**
   * Constructor for the CSVExporter -
   *  initialize the 9 specified files and store the writers in fields.
   */
<span class="fc" id="L109">  private CSVExporter() {</span>
    try {
<span class="fc" id="L111">      File output = Exporter.getOutputFolder(&quot;csv&quot;, null);</span>
<span class="fc" id="L112">      output.mkdirs();</span>
<span class="fc" id="L113">      Path outputDirectory = output.toPath();</span>

<span class="pc bpc" id="L115" title="1 of 2 branches missed.">      if (Boolean.parseBoolean(Config.get(&quot;exporter.csv.folder_per_run&quot;))) {</span>
        // we want a folder per run, so name it based on the timestamp
        // TODO: do we want to consider names based on the current generation options?
<span class="nc" id="L118">        String timestamp = ExportHelper.iso8601Timestamp(System.currentTimeMillis());</span>
<span class="nc" id="L119">        String subfolderName = timestamp.replaceAll(&quot;\\W+&quot;, &quot;_&quot;); // make sure it's filename-safe</span>
<span class="nc" id="L120">        outputDirectory = outputDirectory.resolve(subfolderName);</span>
<span class="nc" id="L121">        outputDirectory.toFile().mkdirs();</span>
      }

<span class="fc" id="L124">      File patientsFile = outputDirectory.resolve(&quot;patients.csv&quot;).toFile();</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">      boolean append = patientsFile.exists()</span>
<span class="pc bnc" id="L126" title="All 2 branches missed.">          &amp;&amp; Boolean.parseBoolean(Config.get(&quot;exporter.csv.append_mode&quot;));</span>

<span class="fc" id="L128">      File allergiesFile = outputDirectory.resolve(&quot;allergies.csv&quot;).toFile();</span>
<span class="fc" id="L129">      File medicationsFile = outputDirectory.resolve(&quot;medications.csv&quot;).toFile();</span>
<span class="fc" id="L130">      File conditionsFile = outputDirectory.resolve(&quot;conditions.csv&quot;).toFile();</span>
<span class="fc" id="L131">      File careplansFile = outputDirectory.resolve(&quot;careplans.csv&quot;).toFile();</span>
<span class="fc" id="L132">      File observationsFile = outputDirectory.resolve(&quot;observations.csv&quot;).toFile();</span>
<span class="fc" id="L133">      File proceduresFile = outputDirectory.resolve(&quot;procedures.csv&quot;).toFile();</span>
<span class="fc" id="L134">      File immunizationsFile = outputDirectory.resolve(&quot;immunizations.csv&quot;).toFile();</span>
<span class="fc" id="L135">      File encountersFile = outputDirectory.resolve(&quot;encounters.csv&quot;).toFile();</span>
<span class="fc" id="L136">      File imagingStudiesFile = outputDirectory.resolve(&quot;imaging_studies.csv&quot;).toFile();</span>

<span class="fc" id="L138">      patients = new FileWriter(patientsFile, append);</span>
<span class="fc" id="L139">      allergies = new FileWriter(allergiesFile, append);</span>
<span class="fc" id="L140">      medications = new FileWriter(medicationsFile, append);</span>
<span class="fc" id="L141">      conditions = new FileWriter(conditionsFile, append);</span>
<span class="fc" id="L142">      careplans = new FileWriter(careplansFile, append);</span>
<span class="fc" id="L143">      observations = new FileWriter(observationsFile, append);</span>
<span class="fc" id="L144">      procedures = new FileWriter(proceduresFile, append);</span>
<span class="fc" id="L145">      immunizations = new FileWriter(immunizationsFile, append);</span>
<span class="fc" id="L146">      encounters = new FileWriter(encountersFile, append);</span>
<span class="fc" id="L147">      imagingStudies = new FileWriter(imagingStudiesFile, append);</span>

<span class="fc" id="L149">      File organizationsFile = outputDirectory.resolve(&quot;organizations.csv&quot;).toFile();</span>
<span class="fc" id="L150">      File providersFile = outputDirectory.resolve(&quot;providers.csv&quot;).toFile();</span>
<span class="fc" id="L151">      organizations = new FileWriter(organizationsFile, append);</span>
<span class="fc" id="L152">      providers = new FileWriter(providersFile, append);</span>

<span class="pc bpc" id="L154" title="1 of 2 branches missed.">      if (!append) {</span>
<span class="fc" id="L155">        writeCSVHeaders();</span>
      }
<span class="nc" id="L157">    } catch (IOException e) {</span>
      // wrap the exception in a runtime exception.
      // the singleton pattern below doesn't work if the constructor can throw
      // and if these do throw ioexceptions there's nothing we can do anyway
<span class="nc" id="L161">      throw new RuntimeException(e);</span>
<span class="fc" id="L162">    }</span>
<span class="fc" id="L163">  }</span>

  /**
   * Write the headers to each of the CSV files.
   * @throws IOException if any IO error occurs
   */
  private void writeCSVHeaders() throws IOException {
<span class="fc" id="L170">    patients.write(&quot;Id,BIRTHDATE,DEATHDATE,SSN,DRIVERS,PASSPORT,&quot;</span>
        + &quot;PREFIX,FIRST,LAST,SUFFIX,MAIDEN,MARITAL,RACE,ETHNICITY,GENDER,BIRTHPLACE,&quot;
        + &quot;ADDRESS,CITY,STATE,ZIP&quot;);
<span class="fc" id="L173">    patients.write(NEWLINE);</span>
<span class="fc" id="L174">    allergies.write(&quot;START,STOP,PATIENT,ENCOUNTER,CODE,DESCRIPTION&quot;);</span>
<span class="fc" id="L175">    allergies.write(NEWLINE);</span>
<span class="fc" id="L176">    medications.write(</span>
        &quot;START,STOP,PATIENT,ENCOUNTER,CODE,DESCRIPTION,COST,DISPENSES,TOTALCOST,&quot;
        + &quot;REASONCODE,REASONDESCRIPTION&quot;
    );
<span class="fc" id="L180">    medications.write(NEWLINE);</span>
<span class="fc" id="L181">    conditions.write(&quot;START,STOP,PATIENT,ENCOUNTER,CODE,DESCRIPTION&quot;);</span>
<span class="fc" id="L182">    conditions.write(NEWLINE);</span>
<span class="fc" id="L183">    careplans.write(</span>
        &quot;Id,START,STOP,PATIENT,ENCOUNTER,CODE,DESCRIPTION,REASONCODE,REASONDESCRIPTION&quot;);
<span class="fc" id="L185">    careplans.write(NEWLINE);</span>
<span class="fc" id="L186">    observations.write(&quot;DATE,PATIENT,ENCOUNTER,CODE,DESCRIPTION,VALUE,UNITS,TYPE&quot;);</span>
<span class="fc" id="L187">    observations.write(NEWLINE);</span>
<span class="fc" id="L188">    procedures.write(&quot;DATE,PATIENT,ENCOUNTER,CODE,DESCRIPTION,COST,REASONCODE,REASONDESCRIPTION&quot;);</span>
<span class="fc" id="L189">    procedures.write(NEWLINE);</span>
<span class="fc" id="L190">    immunizations.write(&quot;DATE,PATIENT,ENCOUNTER,CODE,DESCRIPTION,COST&quot;);</span>
<span class="fc" id="L191">    immunizations.write(NEWLINE);</span>
<span class="fc" id="L192">    encounters.write(&quot;Id,START,STOP,PATIENT,PROVIDER,ENCOUNTERCLASS,CODE,DESCRIPTION,COST,&quot;</span>
        + &quot;REASONCODE,REASONDESCRIPTION&quot;);
<span class="fc" id="L194">    encounters.write(NEWLINE);</span>
<span class="fc" id="L195">    imagingStudies.write(&quot;Id,DATE,PATIENT,ENCOUNTER,BODYSITE_CODE,BODYSITE_DESCRIPTION,&quot;</span>
        + &quot;MODALITY_CODE,MODALITY_DESCRIPTION,SOP_CODE,SOP_DESCRIPTION&quot;);
<span class="fc" id="L197">    imagingStudies.write(NEWLINE);</span>
<span class="fc" id="L198">    organizations.write(&quot;Id,NAME,ADDRESS,CITY,STATE,ZIP,PHONE,UTILIZATION&quot;);</span>
<span class="fc" id="L199">    organizations.write(NEWLINE);</span>
<span class="fc" id="L200">    providers.write(&quot;Id,ORGANIZATION,NAME,GENDER,SPECIALITY,ADDRESS,CITY,STATE,ZIP,UTILIZATION&quot;);</span>
<span class="fc" id="L201">    providers.write(NEWLINE);</span>
<span class="fc" id="L202">  }</span>

  /**
   *  Thread safe singleton pattern adopted from
   *  https://stackoverflow.com/questions/7048198/thread-safe-singletons-in-java
   */
  private static class SingletonHolder {
    /**
     * Singleton instance of the CSVExporter.
     */
<span class="fc" id="L212">    private static final CSVExporter instance = new CSVExporter();</span>
  }

  /**
   * Get the current instance of the CSVExporter.
   * @return the current instance of the CSVExporter.
   */
  public static CSVExporter getInstance() {
<span class="fc" id="L220">    return SingletonHolder.instance;</span>
  }

  /**
   * Export the organizations.csv and providers.csv files. This method should be
   * called once after all the Patient records have been exported using the
   * export(Person,long) method.
   * @throws IOException if any IO errors occur.
   */
  public void exportOrganizationsAndProviders() throws IOException {
<span class="fc bfc" id="L230" title="All 2 branches covered.">    for (Provider org: Provider.getProviderList()) {</span>
      // Check utilization for hospital before we export
<span class="fc" id="L232">      Table&lt;Integer, String, AtomicInteger&gt; utilization = org.getUtilization();</span>
<span class="fc" id="L233">      int totalEncounters = utilization.column(Provider.ENCOUNTERS).values().stream()</span>
<span class="fc" id="L234">              .mapToInt(ai -&gt; ai.get()).sum();</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">      if (totalEncounters &gt; 0) {</span>
<span class="fc" id="L236">        organization(org, totalEncounters);</span>
<span class="fc" id="L237">        Map&lt;String, ArrayList&lt;Clinician&gt;&gt; providers = org.clinicianMap;</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">        for (String speciality: providers.keySet()) {</span>
<span class="fc" id="L239">          ArrayList&lt;Clinician&gt; clinicians = providers.get(speciality);</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">          for (Clinician clinician: clinicians) {</span>
<span class="fc" id="L241">            provider(clinician, org.getResourceID());</span>
<span class="fc" id="L242">          }</span>
<span class="fc" id="L243">        }</span>
      }
<span class="fc" id="L245">      organizations.flush();</span>
<span class="fc" id="L246">      providers.flush();</span>
<span class="fc" id="L247">    }</span>
<span class="fc" id="L248">  }</span>

  /**
   * Add a single Person's health record info to the CSV records.
   * @param person Person to write record data for
   * @param time Time the simulation ended
   * @throws IOException if any IO error occurs
   */
  public void export(Person person, long time) throws IOException {
<span class="fc" id="L257">    String personID = patient(person, time);</span>

<span class="fc bfc" id="L259" title="All 2 branches covered.">    for (Encounter encounter : person.record.encounters) {</span>
<span class="fc" id="L260">      String encounterID = encounter(personID, encounter);</span>

<span class="fc bfc" id="L262" title="All 2 branches covered.">      for (HealthRecord.Entry condition : encounter.conditions) {</span>
<span class="fc" id="L263">        condition(personID, encounterID, condition);</span>
<span class="fc" id="L264">      }</span>

<span class="pc bpc" id="L266" title="1 of 2 branches missed.">      for (HealthRecord.Entry allergy : encounter.allergies) {</span>
<span class="nc" id="L267">        allergy(personID, encounterID, allergy);</span>
<span class="nc" id="L268">      }</span>

<span class="fc bfc" id="L270" title="All 2 branches covered.">      for (Observation observation : encounter.observations) {</span>
<span class="fc" id="L271">        observation(personID, encounterID, observation);</span>
<span class="fc" id="L272">      }</span>

<span class="fc bfc" id="L274" title="All 2 branches covered.">      for (Procedure procedure : encounter.procedures) {</span>
<span class="fc" id="L275">        procedure(personID, encounterID, procedure);</span>
<span class="fc" id="L276">      }</span>

<span class="fc bfc" id="L278" title="All 2 branches covered.">      for (Medication medication : encounter.medications) {</span>
<span class="fc" id="L279">        medication(personID, encounterID, medication, time);</span>
<span class="fc" id="L280">      }</span>

<span class="fc bfc" id="L282" title="All 2 branches covered.">      for (HealthRecord.Entry immunization : encounter.immunizations) {</span>
<span class="fc" id="L283">        immunization(personID, encounterID, immunization);</span>
<span class="fc" id="L284">      }</span>

<span class="fc bfc" id="L286" title="All 2 branches covered.">      for (CarePlan careplan : encounter.careplans) {</span>
<span class="fc" id="L287">        careplan(personID, encounterID, careplan);</span>
<span class="fc" id="L288">      }</span>

<span class="fc bfc" id="L290" title="All 2 branches covered.">      for (ImagingStudy imagingStudy : encounter.imagingStudies) {</span>
<span class="fc" id="L291">        imagingStudy(personID, encounterID, imagingStudy);</span>
<span class="fc" id="L292">      }</span>
<span class="fc" id="L293">    }</span>

<span class="fc" id="L295">    patients.flush();</span>
<span class="fc" id="L296">    encounters.flush();</span>
<span class="fc" id="L297">    conditions.flush();</span>
<span class="fc" id="L298">    allergies.flush();</span>
<span class="fc" id="L299">    medications.flush();</span>
<span class="fc" id="L300">    careplans.flush();</span>
<span class="fc" id="L301">    observations.flush();</span>
<span class="fc" id="L302">    procedures.flush();</span>
<span class="fc" id="L303">    immunizations.flush();</span>
<span class="fc" id="L304">    imagingStudies.flush();</span>
<span class="fc" id="L305">  }</span>

  /**
   * Write a single Patient line, to patients.csv.
   *
   * @param person Person to write data for
   * @param time Time the simulation ended, to calculate age/deceased status
   * @return the patient's ID, to be referenced as a &quot;foreign key&quot; if necessary
   * @throws IOException if any IO error occurs
   */
  private String patient(Person person, long time) throws IOException {
    // Id,BIRTHDATE,DEATHDATE,SSN,DRIVERS,PASSPORT,PREFIX,
    // FIRST,LAST,SUFFIX,MAIDEN,MARITAL,RACE,ETHNICITY,GENDER,BIRTHPLACE,ADDRESS
<span class="fc" id="L318">    String personID = (String) person.attributes.get(Person.ID);</span>

    // check if we've already exported this patient demographic data yet,
    // otherwise the &quot;split record&quot; feature could add a duplicate entry.
<span class="pc bpc" id="L322" title="1 of 2 branches missed.">    if (person.attributes.containsKey(&quot;exported_to_csv&quot;)) {</span>
<span class="nc" id="L323">      return personID;</span>
    } else {
<span class="fc" id="L325">      person.attributes.put(&quot;exported_to_csv&quot;, personID);</span>
    }

<span class="fc" id="L328">    StringBuilder s = new StringBuilder();</span>
<span class="fc" id="L329">    s.append(personID).append(',');</span>
<span class="fc" id="L330">    s.append(dateFromTimestamp((long)person.attributes.get(Person.BIRTHDATE))).append(',');</span>
<span class="fc bfc" id="L331" title="All 2 branches covered.">    if (!person.alive(time)) {</span>
<span class="fc" id="L332">      s.append(dateFromTimestamp(person.events.event(Event.DEATH).time));</span>
    }

<span class="fc bfc" id="L335" title="All 2 branches covered.">    for (String attribute : new String[] {</span>
        Person.IDENTIFIER_SSN,
        Person.IDENTIFIER_DRIVERS,
        Person.IDENTIFIER_PASSPORT,
        Person.NAME_PREFIX,
        Person.FIRST_NAME,
        Person.LAST_NAME,
        Person.NAME_SUFFIX,
        Person.MAIDEN_NAME,
        Person.MARITAL_STATUS,
        Person.RACE,
        Person.ETHNICITY,
        Person.GENDER,
        Person.BIRTHPLACE,
        Person.ADDRESS,
        Person.CITY,
        Person.STATE,
        Person.ZIP
    }) {
<span class="fc" id="L354">      String value = (String) person.attributes.getOrDefault(attribute, &quot;&quot;);</span>
<span class="fc" id="L355">      s.append(',').append(clean(value));</span>
    }

<span class="fc" id="L358">    s.append(NEWLINE);</span>
<span class="fc" id="L359">    write(s.toString(), patients);</span>

<span class="fc" id="L361">    return personID;</span>
  }

  /**
   * Write a single Encounter line to encounters.csv.
   *
   * @param personID The ID of the person that had this encounter
   * @param encounter The encounter itself
   * @return The encounter ID, to be referenced as a &quot;foreign key&quot; if necessary
   * @throws IOException if any IO error occurs
   */
  private String encounter(String personID, Encounter encounter) throws IOException {
    // Id,START,STOP,PATIENT,PROVIDER,ENCOUNTERCLASS,CODE,DESCRIPTION,COST,
    // REASONCODE,REASONDESCRIPTION
<span class="fc" id="L375">    StringBuilder s = new StringBuilder();</span>

<span class="fc" id="L377">    String encounterID = UUID.randomUUID().toString();</span>
    //ID
<span class="fc" id="L379">    s.append(encounterID).append(',');</span>
    //START
<span class="fc" id="L381">    s.append(iso8601Timestamp(encounter.start)).append(',');</span>
    //STOP
<span class="pc bpc" id="L383" title="1 of 2 branches missed.">    if (encounter.stop != 0L) {</span>
<span class="fc" id="L384">      s.append(iso8601Timestamp(encounter.stop)).append(',');</span>
    } else {
<span class="nc" id="L386">      s.append(',');</span>
    }
    //PATIENT
<span class="fc" id="L389">    s.append(personID).append(',');</span>

    //PROVIDER
<span class="fc bfc" id="L392" title="All 2 branches covered.">    if (encounter.provider != null) {</span>
<span class="fc" id="L393">      s.append(encounter.provider.getResourceID()).append(',');</span>
    } else {
<span class="fc" id="L395">      s.append(',');</span>
    }

    //ENCOUNTERCLASS
<span class="pc bpc" id="L399" title="1 of 2 branches missed.">    if (encounter.type != null) {</span>
<span class="fc" id="L400">      s.append(encounter.type.toLowerCase()).append(',');</span>
    } else {
<span class="nc" id="L402">      s.append(',');</span>
    }
    //CODE
<span class="fc" id="L405">    Code coding = encounter.codes.get(0);</span>
<span class="fc" id="L406">    s.append(coding.code).append(',');</span>
    //DESCRIPTION
<span class="fc" id="L408">    s.append(clean(coding.display)).append(',');</span>
    //COST
<span class="fc" id="L410">    s.append(String.format(Locale.US, &quot;%.2f&quot;, encounter.cost())).append(',');</span>
    //REASONCODE &amp; REASONDESCRIPTION
<span class="fc bfc" id="L412" title="All 2 branches covered.">    if (encounter.reason == null) {</span>
<span class="fc" id="L413">      s.append(&quot;,&quot;);</span>
    } else {
<span class="fc" id="L415">      s.append(encounter.reason.code).append(',');</span>
<span class="fc" id="L416">      s.append(clean(encounter.reason.display));</span>
    }

<span class="fc" id="L419">    s.append(NEWLINE);</span>
<span class="fc" id="L420">    write(s.toString(), encounters);</span>

<span class="fc" id="L422">    return encounterID;</span>
  }

  /**
   * Write a single Condition to conditions.csv.
   *
   * @param personID ID of the person that has the condition.
   * @param encounterID ID of the encounter where the condition was diagnosed
   * @param condition The condition itself
   * @throws IOException if any IO error occurs
   */
  private void condition(String personID, String encounterID,
      Entry condition) throws IOException {
    // START,STOP,PATIENT,ENCOUNTER,CODE,DESCRIPTION
<span class="fc" id="L436">    StringBuilder s = new StringBuilder();</span>

<span class="fc" id="L438">    s.append(dateFromTimestamp(condition.start)).append(',');</span>
<span class="fc bfc" id="L439" title="All 2 branches covered.">    if (condition.stop != 0L) {</span>
<span class="fc" id="L440">      s.append(dateFromTimestamp(condition.stop));</span>
    }
<span class="fc" id="L442">    s.append(',');</span>
<span class="fc" id="L443">    s.append(personID).append(',');</span>
<span class="fc" id="L444">    s.append(encounterID).append(',');</span>

<span class="fc" id="L446">    Code coding = condition.codes.get(0);</span>

<span class="fc" id="L448">    s.append(coding.code).append(',');</span>
<span class="fc" id="L449">    s.append(clean(coding.display));</span>

<span class="fc" id="L451">    s.append(NEWLINE);</span>
<span class="fc" id="L452">    write(s.toString(), conditions);</span>
<span class="fc" id="L453">  }</span>

  /**
   * Write a single Allergy to allergies.csv.
   *
   * @param personID ID of the person that has the allergy.
   * @param encounterID ID of the encounter where the allergy was diagnosed
   * @param allergy The allergy itself
   * @throws IOException if any IO error occurs
   */
  private void allergy(String personID, String encounterID,
      Entry allergy) throws IOException {
    // START,STOP,PATIENT,ENCOUNTER,CODE,DESCRIPTION
<span class="nc" id="L466">    StringBuilder s = new StringBuilder();</span>

<span class="nc" id="L468">    s.append(dateFromTimestamp(allergy.start)).append(',');</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">    if (allergy.stop != 0L) {</span>
<span class="nc" id="L470">      s.append(dateFromTimestamp(allergy.stop));</span>
    }
<span class="nc" id="L472">    s.append(',');</span>
<span class="nc" id="L473">    s.append(personID).append(',');</span>
<span class="nc" id="L474">    s.append(encounterID).append(',');</span>

<span class="nc" id="L476">    Code coding = allergy.codes.get(0);</span>

<span class="nc" id="L478">    s.append(coding.code).append(',');</span>
<span class="nc" id="L479">    s.append(clean(coding.display));</span>

<span class="nc" id="L481">    s.append(NEWLINE);</span>
<span class="nc" id="L482">    write(s.toString(), allergies);</span>
<span class="nc" id="L483">  }</span>

  /**
   * Write a single Observation to observations.csv.
   *
   * @param personID ID of the person to whom the observation applies.
   * @param encounterID ID of the encounter where the observation was taken
   * @param observation The observation itself
   * @throws IOException if any IO error occurs
   */
  private void observation(String personID, String encounterID,
      Observation observation) throws IOException {

<span class="fc bfc" id="L496" title="All 2 branches covered.">    if (observation.value == null) {</span>
<span class="pc bpc" id="L497" title="2 of 4 branches missed.">      if (observation.observations != null &amp;&amp; !observation.observations.isEmpty()) {</span>
        // just loop through the child observations

<span class="fc bfc" id="L500" title="All 2 branches covered.">        for (Observation subObs : observation.observations) {</span>
<span class="fc" id="L501">          observation(personID, encounterID, subObs);</span>
<span class="fc" id="L502">        }</span>
      }

      // no value so nothing more to report here
<span class="fc" id="L506">      return;</span>
    }

    // DATE,PATIENT,ENCOUNTER,CODE,DESCRIPTION,VALUE,UNITS
<span class="fc" id="L510">    StringBuilder s = new StringBuilder();</span>

<span class="fc" id="L512">    s.append(dateFromTimestamp(observation.start)).append(',');</span>
<span class="fc" id="L513">    s.append(personID).append(',');</span>
<span class="fc" id="L514">    s.append(encounterID).append(',');</span>

<span class="fc" id="L516">    Code coding = observation.codes.get(0);</span>

<span class="fc" id="L518">    s.append(coding.code).append(',');</span>
<span class="fc" id="L519">    s.append(clean(coding.display)).append(',');</span>

<span class="fc" id="L521">    String value = ExportHelper.getObservationValue(observation);</span>
<span class="fc" id="L522">    String type = ExportHelper.getObservationType(observation);</span>
<span class="fc" id="L523">    s.append(value).append(',');</span>
<span class="fc" id="L524">    s.append(observation.unit).append(',');</span>
<span class="fc" id="L525">    s.append(type);</span>

<span class="fc" id="L527">    s.append(NEWLINE);</span>
<span class="fc" id="L528">    write(s.toString(), observations);</span>
<span class="fc" id="L529">  }</span>

  /**
   * Write a single Procedure to procedures.csv.
   *
   * @param personID ID of the person on whom the procedure was performed.
   * @param encounterID ID of the encounter where the procedure was performed
   * @param procedure The procedure itself
   * @throws IOException if any IO error occurs
   */
  private void procedure(String personID, String encounterID,
      Procedure procedure) throws IOException {
    // DATE,PATIENT,ENCOUNTER,CODE,DESCRIPTION,COST,REASONCODE,REASONDESCRIPTION
<span class="fc" id="L542">    StringBuilder s = new StringBuilder();</span>

<span class="fc" id="L544">    s.append(dateFromTimestamp(procedure.start)).append(',');</span>
<span class="fc" id="L545">    s.append(personID).append(',');</span>
<span class="fc" id="L546">    s.append(encounterID).append(',');</span>

<span class="fc" id="L548">    Code coding = procedure.codes.get(0);</span>

<span class="fc" id="L550">    s.append(coding.code).append(',');</span>
<span class="fc" id="L551">    s.append(clean(coding.display)).append(',');</span>

<span class="fc" id="L553">    s.append(String.format(Locale.US, &quot;%.2f&quot;, procedure.cost())).append(',');</span>

<span class="fc bfc" id="L555" title="All 2 branches covered.">    if (procedure.reasons.isEmpty()) {</span>
<span class="fc" id="L556">      s.append(','); // reason code &amp; desc</span>
    } else {
<span class="fc" id="L558">      Code reason = procedure.reasons.get(0);</span>
<span class="fc" id="L559">      s.append(reason.code).append(',');</span>
<span class="fc" id="L560">      s.append(clean(reason.display));</span>
    }

<span class="fc" id="L563">    s.append(NEWLINE);</span>
<span class="fc" id="L564">    write(s.toString(), procedures);</span>
<span class="fc" id="L565">  }</span>

  /**
   * Write a single Medication to medications.csv.
   *
   * @param personID ID of the person prescribed the medication.
   * @param encounterID ID of the encounter where the medication was prescribed
   * @param medication The medication itself
   * @param stopTime End time
   * @throws IOException if any IO error occurs
   */
  private void medication(String personID, String encounterID,
      Medication medication, long stopTime) throws IOException {
    // START,STOP,PATIENT,ENCOUNTER,CODE,DESCRIPTION,
    // COST,DISPENSES,TOTALCOST,REASONCODE,REASONDESCRIPTION
<span class="fc" id="L580">    StringBuilder s = new StringBuilder();</span>

<span class="fc" id="L582">    s.append(dateFromTimestamp(medication.start)).append(',');</span>
<span class="fc bfc" id="L583" title="All 2 branches covered.">    if (medication.stop != 0L) {</span>
<span class="fc" id="L584">      s.append(dateFromTimestamp(medication.stop));</span>
    }
<span class="fc" id="L586">    s.append(',');</span>
<span class="fc" id="L587">    s.append(personID).append(',');</span>
<span class="fc" id="L588">    s.append(encounterID).append(',');</span>

<span class="fc" id="L590">    Code coding = medication.codes.get(0);</span>

<span class="fc" id="L592">    s.append(coding.code).append(',');</span>
<span class="fc" id="L593">    s.append(clean(coding.display)).append(',');</span>

<span class="fc" id="L595">    BigDecimal cost = medication.cost();</span>
<span class="fc" id="L596">    s.append(String.format(Locale.US, &quot;%.2f&quot;, cost)).append(',');</span>
<span class="fc" id="L597">    long dispenses = 1; // dispenses = refills + original</span>
    // makes the math cleaner and more explicit. dispenses * unit cost = total cost

<span class="fc" id="L600">    long stop = medication.stop;</span>
<span class="fc bfc" id="L601" title="All 2 branches covered.">    if (stop == 0L) {</span>
<span class="fc" id="L602">      stop = stopTime;</span>
    }
<span class="fc" id="L604">    long medDuration = stop - medication.start;</span>

<span class="fc bfc" id="L606" title="All 2 branches covered.">    if (medication.prescriptionDetails != null</span>
<span class="fc bfc" id="L607" title="All 2 branches covered.">        &amp;&amp; medication.prescriptionDetails.has(&quot;refills&quot;)) {</span>
<span class="fc" id="L608">      dispenses = medication.prescriptionDetails.get(&quot;refills&quot;).getAsInt();</span>
<span class="fc bfc" id="L609" title="All 2 branches covered.">    } else if (medication.prescriptionDetails != null</span>
<span class="fc bfc" id="L610" title="All 2 branches covered.">        &amp;&amp; medication.prescriptionDetails.has(&quot;duration&quot;)) {</span>
<span class="fc" id="L611">      JsonObject duration = medication.prescriptionDetails.getAsJsonObject(&quot;duration&quot;);</span>

<span class="fc" id="L613">      long quantity = duration.get(&quot;quantity&quot;).getAsLong();</span>
<span class="fc" id="L614">      String unit = duration.get(&quot;unit&quot;).getAsString();</span>
<span class="fc" id="L615">      long durationMs = Utilities.convertTime(unit, quantity);</span>
<span class="fc" id="L616">      dispenses = medDuration / durationMs;</span>
<span class="fc" id="L617">    } else {</span>
      // assume 1 refill / month
<span class="fc" id="L619">      long durationMs = Utilities.convertTime(&quot;months&quot;, 1);</span>
<span class="fc" id="L620">      dispenses = medDuration / durationMs;</span>
    }

<span class="fc bfc" id="L623" title="All 2 branches covered.">    if (dispenses &lt; 1) {</span>
      // integer division could leave us with 0,
      // ex. if the active time (start-&gt;stop) is less than the provided duration
      // or less than a month if no duration provided
<span class="fc" id="L627">      dispenses = 1;</span>
    }

<span class="fc" id="L630">    s.append(dispenses).append(',');</span>
<span class="fc" id="L631">    BigDecimal totalCost = cost</span>
<span class="fc" id="L632">        .multiply(BigDecimal.valueOf(dispenses))</span>
<span class="fc" id="L633">        .setScale(2, RoundingMode.DOWN); // truncate to 2 decimal places</span>
<span class="fc" id="L634">    s.append(String.format(Locale.US, &quot;%.2f&quot;, totalCost)).append(',');</span>

<span class="fc bfc" id="L636" title="All 2 branches covered.">    if (medication.reasons.isEmpty()) {</span>
<span class="fc" id="L637">      s.append(','); // reason code &amp; desc</span>
    } else {
<span class="fc" id="L639">      Code reason = medication.reasons.get(0);</span>
<span class="fc" id="L640">      s.append(reason.code).append(',');</span>
<span class="fc" id="L641">      s.append(clean(reason.display));</span>
    }

<span class="fc" id="L644">    s.append(NEWLINE);</span>
<span class="fc" id="L645">    write(s.toString(), medications);</span>
<span class="fc" id="L646">  }</span>

  /**
   * Write a single Immunization to immunizations.csv.
   *
   * @param personID ID of the person on whom the immunization was performed.
   * @param encounterID ID of the encounter where the immunization was performed
   * @param immunization The immunization itself
   * @throws IOException if any IO error occurs
   */
  private void immunization(String personID, String encounterID,
      Entry immunization) throws IOException  {
    // DATE,PATIENT,ENCOUNTER,CODE,DESCRIPTION,COST
<span class="fc" id="L659">    StringBuilder s = new StringBuilder();</span>

<span class="fc" id="L661">    s.append(dateFromTimestamp(immunization.start)).append(',');</span>
<span class="fc" id="L662">    s.append(personID).append(',');</span>
<span class="fc" id="L663">    s.append(encounterID).append(',');</span>

<span class="fc" id="L665">    Code coding = immunization.codes.get(0);</span>

<span class="fc" id="L667">    s.append(coding.code).append(',');</span>
<span class="fc" id="L668">    s.append(clean(coding.display)).append(',');</span>

<span class="fc" id="L670">    s.append(String.format(Locale.US, &quot;%.2f&quot;, immunization.cost()));</span>

<span class="fc" id="L672">    s.append(NEWLINE);</span>
<span class="fc" id="L673">    write(s.toString(), immunizations);</span>
<span class="fc" id="L674">  }</span>

  /**
   * Write a single CarePlan to careplans.csv.
   *
   * @param personID ID of the person prescribed the careplan.
   * @param encounterID ID of the encounter where the careplan was prescribed
   * @param careplan The careplan itself
   * @throws IOException if any IO error occurs
   */
  private String careplan(String personID, String encounterID,
      CarePlan careplan) throws IOException {
    // Id,START,STOP,PATIENT,ENCOUNTER,CODE,DESCRIPTION,REASONCODE,REASONDESCRIPTION
<span class="fc" id="L687">    StringBuilder s = new StringBuilder();</span>

<span class="fc" id="L689">    String careplanID = UUID.randomUUID().toString();</span>
<span class="fc" id="L690">    s.append(careplanID).append(',');</span>
<span class="fc" id="L691">    s.append(dateFromTimestamp(careplan.start)).append(',');</span>
<span class="fc bfc" id="L692" title="All 2 branches covered.">    if (careplan.stop != 0L) {</span>
<span class="fc" id="L693">      s.append(dateFromTimestamp(careplan.stop));</span>
    }
<span class="fc" id="L695">    s.append(',');</span>
<span class="fc" id="L696">    s.append(personID).append(',');</span>
<span class="fc" id="L697">    s.append(encounterID).append(',');</span>

<span class="fc" id="L699">    Code coding = careplan.codes.get(0);</span>

<span class="fc" id="L701">    s.append(coding.code).append(',');</span>
<span class="fc" id="L702">    s.append(coding.display).append(',');</span>

<span class="fc bfc" id="L704" title="All 2 branches covered.">    if (careplan.reasons.isEmpty()) {</span>
<span class="fc" id="L705">      s.append(','); // reason code &amp; desc</span>
    } else {
<span class="fc" id="L707">      Code reason = careplan.reasons.get(0);</span>
<span class="fc" id="L708">      s.append(reason.code).append(',');</span>
<span class="fc" id="L709">      s.append(clean(reason.display));</span>
    }
<span class="fc" id="L711">    s.append(NEWLINE);</span>

<span class="fc" id="L713">    write(s.toString(), careplans);</span>

<span class="fc" id="L715">    return careplanID;</span>
  }

  /**
   * Write a single ImagingStudy to imaging_studies.csv.
   *
   * @param personID ID of the person the ImagingStudy was taken of.
   * @param encounterID ID of the encounter where the ImagingStudy was performed
   * @param imagingStudy The ImagingStudy itself
   * @throws IOException if any IO error occurs
   */
  private String imagingStudy(String personID, String encounterID,
      ImagingStudy imagingStudy) throws IOException {
    // Id,DATE,PATIENT,ENCOUNTER,BODYSITE_CODE,BODYSITE_DESCRIPTION,
    // MODALITY_CODE,MODALITY_DESCRIPTION,SOP_CODE,SOP_DESCRIPTION
<span class="fc" id="L730">    StringBuilder s = new StringBuilder();</span>

<span class="fc" id="L732">    String studyID = UUID.randomUUID().toString();</span>
<span class="fc" id="L733">    s.append(studyID).append(',');</span>
<span class="fc" id="L734">    s.append(dateFromTimestamp(imagingStudy.start)).append(',');</span>
<span class="fc" id="L735">    s.append(personID).append(',');</span>
<span class="fc" id="L736">    s.append(encounterID).append(',');</span>

<span class="fc" id="L738">    ImagingStudy.Series series1 = imagingStudy.series.get(0);</span>
<span class="fc" id="L739">    ImagingStudy.Instance instance1 = series1.instances.get(0);</span>

<span class="fc" id="L741">    Code bodySite = series1.bodySite;</span>
<span class="fc" id="L742">    Code modality = series1.modality;</span>
<span class="fc" id="L743">    Code sopClass = instance1.sopClass;</span>

<span class="fc" id="L745">    s.append(bodySite.code).append(',');</span>
<span class="fc" id="L746">    s.append(bodySite.display).append(',');</span>

<span class="fc" id="L748">    s.append(modality.code).append(',');</span>
<span class="fc" id="L749">    s.append(modality.display).append(',');</span>

<span class="fc" id="L751">    s.append(sopClass.code).append(',');</span>
<span class="fc" id="L752">    s.append(sopClass.display);</span>

<span class="fc" id="L754">    s.append(NEWLINE);</span>

<span class="fc" id="L756">    write(s.toString(), imagingStudies);</span>

<span class="fc" id="L758">    return studyID;</span>
  }

  /**
   * Write a single organization to organizations.csv
   * @param org The organization to be written
   * @param utilization The total number of encounters for the org
   * @throws IOException if any IO error occurs
   */
  private void organization(Provider org, int utilization) throws IOException {
    // Id,NAME,ADDRESS,CITY,STATE,ZIP,PHONE,UTILIZATION
<span class="fc" id="L769">    StringBuilder s = new StringBuilder();</span>
<span class="fc" id="L770">    s.append(org.getResourceID()).append(',');</span>
<span class="fc" id="L771">    s.append(clean(org.name)).append(',');</span>
<span class="fc" id="L772">    s.append(clean(org.address)).append(',');</span>
<span class="fc" id="L773">    s.append(org.city).append(',');</span>
<span class="fc" id="L774">    s.append(org.state).append(',');</span>
<span class="fc" id="L775">    s.append(org.zip).append(',');</span>
<span class="fc" id="L776">    s.append(org.phone).append(',');</span>
<span class="fc" id="L777">    s.append(utilization);</span>
<span class="fc" id="L778">    s.append(NEWLINE);</span>

<span class="fc" id="L780">    write(s.toString(), organizations);</span>
<span class="fc" id="L781">  }</span>

  /**
   * Write a single clinician to providers.csv
   * @param provider The provider information to be written
   * @param orgId ID of the organization the provider belongs to
   * @throws IOException if any IO error occurs
   */
  private void provider(Clinician provider, String orgId) throws IOException {
    // Id,ORGANIZATION,NAME,GENDER,SPECIALITY,ADDRESS,CITY,STATE,ZIP,UTILIZATION

<span class="fc" id="L792">    StringBuilder s = new StringBuilder();</span>
<span class="fc" id="L793">    s.append(provider.getResourceID()).append(',');</span>
<span class="fc" id="L794">    s.append(orgId).append(',');</span>
<span class="fc bfc" id="L795" title="All 2 branches covered.">    for (String attribute: new String[] {</span>
        Clinician.NAME,
        Clinician.GENDER,
        Clinician.SPECIALTY,
        Clinician.ADDRESS,
        Clinician.CITY,
        Clinician.STATE,
        Clinician.ZIP
    }) {
<span class="fc" id="L804">      String value = (String) provider.attributes.getOrDefault(attribute, &quot;&quot;);</span>
<span class="fc" id="L805">      s.append(clean(value)).append(',');</span>
    }
<span class="fc" id="L807">    s.append(provider.getEncounterCount()).append(',');</span>

<span class="fc" id="L809">    s.append(NEWLINE);</span>

<span class="fc" id="L811">    write(s.toString(), providers);</span>

<span class="fc" id="L813">  }</span>

  /**
   * Replaces commas and line breaks in the source string with a single space.
   * Null is replaced with the empty string.
   */
  private static String clean(String src) {
<span class="pc bpc" id="L820" title="1 of 2 branches missed.">    if (src == null) {</span>
<span class="nc" id="L821">      return &quot;&quot;;</span>
    } else {
<span class="fc" id="L823">      return src.replaceAll(&quot;\\r\\n|\\r|\\n|,&quot;, &quot; &quot;).trim();</span>
    }
  }

  /**
   * Helper method to write a line to a File.
   * Extracted to a separate method here to make it a little easier to replace implementations.
   *
   * @param line The line to write
   * @param writer The place to write it
   * @throws IOException if an I/O error occurs
   */
  private static void write(String line, FileWriter writer) throws IOException {
<span class="fc" id="L836">    synchronized (writer) {</span>
<span class="fc" id="L837">      writer.write(line);</span>
<span class="fc" id="L838">    }</span>
<span class="fc" id="L839">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>