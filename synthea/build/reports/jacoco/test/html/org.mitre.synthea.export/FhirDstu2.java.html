<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FhirDstu2.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">synthea</a> &gt; <a href="index.source.html" class="el_package">org.mitre.synthea.export</a> &gt; <span class="el_source">FhirDstu2.java</span></div><h1>FhirDstu2.java</h1><pre class="source lang-java linenums">package org.mitre.synthea.export;

import ca.uhn.fhir.context.FhirContext;
import ca.uhn.fhir.model.api.ExtensionDt;
import ca.uhn.fhir.model.api.IDatatype;
import ca.uhn.fhir.model.dstu2.composite.AddressDt;
import ca.uhn.fhir.model.dstu2.composite.CodeableConceptDt;
import ca.uhn.fhir.model.dstu2.composite.CodingDt;
import ca.uhn.fhir.model.dstu2.composite.ContactPointDt;
import ca.uhn.fhir.model.dstu2.composite.HumanNameDt;
import ca.uhn.fhir.model.dstu2.composite.MoneyDt;
import ca.uhn.fhir.model.dstu2.composite.NarrativeDt;
import ca.uhn.fhir.model.dstu2.composite.PeriodDt;
import ca.uhn.fhir.model.dstu2.composite.QuantityDt;
import ca.uhn.fhir.model.dstu2.composite.ResourceReferenceDt;
import ca.uhn.fhir.model.dstu2.composite.SimpleQuantityDt;
import ca.uhn.fhir.model.dstu2.composite.TimingDt;
import ca.uhn.fhir.model.dstu2.composite.TimingDt.Repeat;
import ca.uhn.fhir.model.dstu2.resource.AllergyIntolerance;
import ca.uhn.fhir.model.dstu2.resource.BaseResource;
import ca.uhn.fhir.model.dstu2.resource.Bundle;
import ca.uhn.fhir.model.dstu2.resource.Bundle.Entry;
import ca.uhn.fhir.model.dstu2.resource.Bundle.EntryRequest;
import ca.uhn.fhir.model.dstu2.resource.CarePlan.Activity;
import ca.uhn.fhir.model.dstu2.resource.CarePlan.ActivityDetail;
import ca.uhn.fhir.model.dstu2.resource.Condition;
import ca.uhn.fhir.model.dstu2.resource.DiagnosticReport;
import ca.uhn.fhir.model.dstu2.resource.Encounter.Hospitalization;
import ca.uhn.fhir.model.dstu2.resource.ImagingStudy.Series;
import ca.uhn.fhir.model.dstu2.resource.ImagingStudy.SeriesInstance;
import ca.uhn.fhir.model.dstu2.resource.Immunization;
import ca.uhn.fhir.model.dstu2.resource.MedicationOrder;
import ca.uhn.fhir.model.dstu2.resource.MedicationOrder.DosageInstruction;
import ca.uhn.fhir.model.dstu2.resource.Observation.Component;
import ca.uhn.fhir.model.dstu2.resource.Organization;
import ca.uhn.fhir.model.dstu2.resource.Patient;
import ca.uhn.fhir.model.dstu2.resource.Patient.Communication;
import ca.uhn.fhir.model.dstu2.resource.Practitioner;
import ca.uhn.fhir.model.dstu2.valueset.AdministrativeGenderEnum;
import ca.uhn.fhir.model.dstu2.valueset.AllergyIntoleranceCategoryEnum;
import ca.uhn.fhir.model.dstu2.valueset.AllergyIntoleranceCriticalityEnum;
import ca.uhn.fhir.model.dstu2.valueset.AllergyIntoleranceStatusEnum;
import ca.uhn.fhir.model.dstu2.valueset.AllergyIntoleranceTypeEnum;
import ca.uhn.fhir.model.dstu2.valueset.BundleTypeEnum;
import ca.uhn.fhir.model.dstu2.valueset.CarePlanActivityStatusEnum;
import ca.uhn.fhir.model.dstu2.valueset.CarePlanStatusEnum;
import ca.uhn.fhir.model.dstu2.valueset.ClaimTypeEnum;
import ca.uhn.fhir.model.dstu2.valueset.ConditionCategoryCodesEnum;
import ca.uhn.fhir.model.dstu2.valueset.ConditionClinicalStatusCodesEnum;
import ca.uhn.fhir.model.dstu2.valueset.ConditionVerificationStatusEnum;
import ca.uhn.fhir.model.dstu2.valueset.ContactPointSystemEnum;
import ca.uhn.fhir.model.dstu2.valueset.ContactPointUseEnum;
import ca.uhn.fhir.model.dstu2.valueset.DiagnosticReportStatusEnum;
import ca.uhn.fhir.model.dstu2.valueset.EncounterClassEnum;
import ca.uhn.fhir.model.dstu2.valueset.EncounterStateEnum;
import ca.uhn.fhir.model.dstu2.valueset.GoalStatusEnum;
import ca.uhn.fhir.model.dstu2.valueset.HTTPVerbEnum;
import ca.uhn.fhir.model.dstu2.valueset.IdentifierTypeCodesEnum;
import ca.uhn.fhir.model.dstu2.valueset.InstanceAvailabilityEnum;
import ca.uhn.fhir.model.dstu2.valueset.MaritalStatusCodesEnum;
import ca.uhn.fhir.model.dstu2.valueset.MedicationOrderStatusEnum;
import ca.uhn.fhir.model.dstu2.valueset.NameUseEnum;
import ca.uhn.fhir.model.dstu2.valueset.NarrativeStatusEnum;
import ca.uhn.fhir.model.dstu2.valueset.ObservationStatusEnum;
import ca.uhn.fhir.model.dstu2.valueset.ProcedureStatusEnum;
import ca.uhn.fhir.model.dstu2.valueset.UnitsOfTimeEnum;
import ca.uhn.fhir.model.dstu2.valueset.UseEnum;
import ca.uhn.fhir.model.primitive.BooleanDt;
import ca.uhn.fhir.model.primitive.CodeDt;
import ca.uhn.fhir.model.primitive.DateDt;
import ca.uhn.fhir.model.primitive.DateTimeDt;
import ca.uhn.fhir.model.primitive.DecimalDt;
import ca.uhn.fhir.model.primitive.InstantDt;
import ca.uhn.fhir.model.primitive.IntegerDt;
import ca.uhn.fhir.model.primitive.OidDt;
import ca.uhn.fhir.model.primitive.PositiveIntDt;
import ca.uhn.fhir.model.primitive.StringDt;
import ca.uhn.fhir.model.primitive.UnsignedIntDt;
import ca.uhn.fhir.model.primitive.XhtmlDt;

import com.google.gson.Gson;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

import org.apache.sis.geometry.DirectPosition2D;
import org.mitre.synthea.engine.Event;
import org.mitre.synthea.helpers.Config;
import org.mitre.synthea.helpers.Utilities;
import org.mitre.synthea.world.agents.Clinician;
import org.mitre.synthea.world.agents.Person;
import org.mitre.synthea.world.agents.Provider;
import org.mitre.synthea.world.concepts.Costs;
import org.mitre.synthea.world.concepts.HealthRecord;
import org.mitre.synthea.world.concepts.HealthRecord.CarePlan;
import org.mitre.synthea.world.concepts.HealthRecord.Claim;
import org.mitre.synthea.world.concepts.HealthRecord.Code;
import org.mitre.synthea.world.concepts.HealthRecord.Encounter;
import org.mitre.synthea.world.concepts.HealthRecord.EncounterType;
import org.mitre.synthea.world.concepts.HealthRecord.ImagingStudy;
import org.mitre.synthea.world.concepts.HealthRecord.Medication;
import org.mitre.synthea.world.concepts.HealthRecord.Observation;
import org.mitre.synthea.world.concepts.HealthRecord.Procedure;
import org.mitre.synthea.world.concepts.HealthRecord.Report;

<span class="nc" id="L112">public class FhirDstu2 {</span>
  // HAPI FHIR warns that the context creation is expensive, and should be performed
  // per-application, not per-record
<span class="fc" id="L115">  private static final FhirContext FHIR_CTX = FhirContext.forDstu2();</span>

  private static final String SNOMED_URI = &quot;http://snomed.info/sct&quot;;
  private static final String LOINC_URI = &quot;http://loinc.org&quot;;
  private static final String RXNORM_URI = &quot;http://www.nlm.nih.gov/research/umls/rxnorm&quot;;
  private static final String CVX_URI = &quot;http://hl7.org/fhir/sid/cvx&quot;;
  private static final String DISCHARGE_URI = &quot;http://www.nubc.org/patient-discharge&quot;;
  private static final String SYNTHEA_EXT = &quot;http://synthetichealth.github.io/synthea/&quot;;
  private static final String DICOM_DCM_URI = &quot;http://dicom.nema.org/resources/ontology/DCM&quot;;

  @SuppressWarnings(&quot;rawtypes&quot;)
<span class="fc" id="L126">  private static final Map raceEthnicityCodes = loadRaceEthnicityCodes();</span>
  @SuppressWarnings(&quot;rawtypes&quot;)
<span class="fc" id="L128">  private static final Map languageLookup = loadLanguageLookup();</span>

<span class="fc" id="L130">  protected static boolean TRANSACTION_BUNDLE =</span>
<span class="fc" id="L131">      Boolean.parseBoolean(Config.get(&quot;exporter.fhir.transaction_bundle&quot;));</span>

<span class="fc" id="L133">  private static final String COUNTRY_CODE = Config.get(&quot;generate.geography.country_code&quot;);</span>

  @SuppressWarnings(&quot;rawtypes&quot;)
  private static Map loadRaceEthnicityCodes() {
<span class="fc" id="L137">    String filename = &quot;race_ethnicity_codes.json&quot;;</span>
    try {
<span class="fc" id="L139">      String json = Utilities.readResource(filename);</span>
<span class="fc" id="L140">      Gson g = new Gson();</span>
<span class="fc" id="L141">      return g.fromJson(json, HashMap.class);</span>
<span class="nc" id="L142">    } catch (Exception e) {</span>
<span class="nc" id="L143">      System.err.println(&quot;ERROR: unable to load json: &quot; + filename);</span>
<span class="nc" id="L144">      e.printStackTrace();</span>
<span class="nc" id="L145">      throw new ExceptionInInitializerError(e);</span>
    }
  }

  @SuppressWarnings(&quot;rawtypes&quot;)
  private static Map loadLanguageLookup() {
<span class="fc" id="L151">    String filename = &quot;language_lookup.json&quot;;</span>
    try {
<span class="fc" id="L153">      String json = Utilities.readResource(filename);</span>
<span class="fc" id="L154">      Gson g = new Gson();</span>
<span class="fc" id="L155">      return g.fromJson(json, HashMap.class);</span>
<span class="nc" id="L156">    } catch (Exception e) {</span>
<span class="nc" id="L157">      System.err.println(&quot;ERROR: unable to load json: &quot; + filename);</span>
<span class="nc" id="L158">      e.printStackTrace();</span>
<span class="nc" id="L159">      throw new ExceptionInInitializerError(e);</span>
    }
  }

  /**
   * Convert the given Person into a FHIR Bundle with the Patient and the
   * associated entries from their health record.
   *
   * @param person Person to generate the FHIR Bundle
   * @param stopTime Time the simulation ended
   * @return String containing a FHIR Bundle containing the Person's health record
   */
  public static Bundle convertToFHIR(Person person, long stopTime) {
<span class="fc" id="L172">    Bundle bundle = new Bundle();</span>
<span class="fc bfc" id="L173" title="All 2 branches covered.">    if (TRANSACTION_BUNDLE) {</span>
<span class="fc" id="L174">      bundle.setType(BundleTypeEnum.TRANSACTION);</span>
    } else {
<span class="fc" id="L176">      bundle.setType(BundleTypeEnum.COLLECTION);</span>
    }

<span class="fc" id="L179">    Entry personEntry = basicInfo(person, bundle, stopTime);</span>

<span class="fc bfc" id="L181" title="All 2 branches covered.">    for (Encounter encounter : person.record.encounters) {</span>
<span class="fc" id="L182">      Entry encounterEntry = encounter(person, personEntry, bundle, encounter);</span>

<span class="fc bfc" id="L184" title="All 2 branches covered.">      for (HealthRecord.Entry condition : encounter.conditions) {</span>
<span class="fc" id="L185">        condition(personEntry, bundle, encounterEntry, condition);</span>
<span class="fc" id="L186">      }</span>

<span class="fc bfc" id="L188" title="All 2 branches covered.">      for (HealthRecord.Entry allergy : encounter.allergies) {</span>
<span class="fc" id="L189">        allergy(personEntry, bundle, encounterEntry, allergy);</span>
<span class="fc" id="L190">      }</span>

<span class="fc bfc" id="L192" title="All 2 branches covered.">      for (Observation observation : encounter.observations) {</span>
<span class="fc" id="L193">        observation(personEntry, bundle, encounterEntry, observation);</span>
<span class="fc" id="L194">      }</span>

<span class="fc bfc" id="L196" title="All 2 branches covered.">      for (Procedure procedure : encounter.procedures) {</span>
<span class="fc" id="L197">        procedure(personEntry, bundle, encounterEntry, procedure);</span>
<span class="fc" id="L198">      }</span>

<span class="fc bfc" id="L200" title="All 2 branches covered.">      for (Medication medication : encounter.medications) {</span>
<span class="fc" id="L201">        medication(personEntry, bundle, encounterEntry, medication);</span>
<span class="fc" id="L202">      }</span>

<span class="fc bfc" id="L204" title="All 2 branches covered.">      for (HealthRecord.Entry immunization : encounter.immunizations) {</span>
<span class="fc" id="L205">        immunization(personEntry, bundle, encounterEntry, immunization);</span>
<span class="fc" id="L206">      }</span>

<span class="fc bfc" id="L208" title="All 2 branches covered.">      for (Report report : encounter.reports) {</span>
<span class="fc" id="L209">        report(personEntry, bundle, encounterEntry, report);</span>
<span class="fc" id="L210">      }</span>

<span class="fc bfc" id="L212" title="All 2 branches covered.">      for (CarePlan careplan : encounter.careplans) {</span>
<span class="fc" id="L213">        careplan(personEntry, bundle, encounterEntry, careplan);</span>
<span class="fc" id="L214">      }</span>

<span class="fc bfc" id="L216" title="All 2 branches covered.">      for (ImagingStudy imagingStudy : encounter.imagingStudies) {</span>
<span class="fc" id="L217">        imagingStudy(personEntry, bundle, encounterEntry, imagingStudy);</span>
<span class="fc" id="L218">      }</span>

      // one claim per encounter
<span class="fc" id="L221">      encounterClaim(personEntry, bundle, encounterEntry, encounter.claim);</span>
<span class="fc" id="L222">    }</span>
<span class="fc" id="L223">    return bundle;</span>
  }

  /**
   * Convert the given Person into a JSON String, containing a FHIR Bundle of the Person and the
   * associated entries from their health record.
   *
   * @param person
   *          Person to generate the FHIR JSON for
   * @param stopTime
   *          Time the simulation ended
   * @return String containing a JSON representation of a FHIR Bundle containing the Person's health
   *         record
   */
  public static String convertToFHIRJson(Person person, long stopTime) {
<span class="fc" id="L238">    Bundle bundle = convertToFHIR(person, stopTime);</span>
<span class="fc" id="L239">    String bundleJson = FHIR_CTX.newJsonParser().setPrettyPrint(true)</span>
<span class="fc" id="L240">        .encodeResourceToString(bundle);</span>
<span class="fc" id="L241">    return bundleJson;</span>
  }

  /**
   * Map the given Person to a FHIR Patient resource, and add it to the given Bundle.
   *
   * @param person
   *          The Person
   * @param bundle
   *          The Bundle to add to
   * @param stopTime
   *          Time the simulation ended
   * @return The created Entry
   */
  @SuppressWarnings(&quot;rawtypes&quot;)
  private static Entry basicInfo(Person person, Bundle bundle, long stopTime) {
<span class="fc" id="L257">    Patient patientResource = new Patient();</span>

<span class="fc" id="L259">    patientResource.addIdentifier().setSystem(&quot;https://github.com/synthetichealth/synthea&quot;)</span>
<span class="fc" id="L260">        .setValue((String) person.attributes.get(Person.ID));</span>

<span class="fc" id="L262">    patientResource.addIdentifier()</span>
<span class="fc" id="L263">        .setType(IdentifierTypeCodesEnum.MR)</span>
<span class="fc" id="L264">        .setSystem(&quot;http://hospital.smarthealthit.org&quot;)</span>
<span class="fc" id="L265">        .setValue((String) person.attributes.get(Person.ID));</span>

<span class="fc" id="L267">    patientResource.addIdentifier()</span>
<span class="fc" id="L268">        .setType(IdentifierTypeCodesEnum.SOCIAL_BENEFICIARY_IDENTIFIER)</span>
<span class="fc" id="L269">        .setSystem(&quot;http://hl7.org/fhir/sid/us-ssn&quot;)</span>
<span class="fc" id="L270">        .setValue((String) person.attributes.get(Person.IDENTIFIER_SSN));</span>

<span class="fc bfc" id="L272" title="All 2 branches covered.">    if (person.attributes.get(Person.IDENTIFIER_DRIVERS) != null) {</span>
<span class="fc" id="L273">      patientResource.addIdentifier()</span>
<span class="fc" id="L274">          .setType(IdentifierTypeCodesEnum.DL)</span>
<span class="fc" id="L275">          .setSystem(&quot;urn:oid:2.16.840.1.113883.4.3.25&quot;)</span>
<span class="fc" id="L276">          .setValue((String) person.attributes.get(Person.IDENTIFIER_DRIVERS));</span>
    }

<span class="fc" id="L279">    ExtensionDt raceExtension = new ExtensionDt();</span>
<span class="fc" id="L280">    raceExtension.setUrl(&quot;http://hl7.org/fhir/StructureDefinition/us-core-race&quot;);</span>
<span class="fc" id="L281">    String race = (String) person.attributes.get(Person.RACE);</span>

<span class="fc" id="L283">    ExtensionDt ethnicityExtension = new ExtensionDt();</span>
<span class="fc" id="L284">    ethnicityExtension.setUrl(&quot;http://hl7.org/fhir/StructureDefinition/us-core-ethnicity&quot;);</span>
<span class="fc" id="L285">    String ethnicity = (String) person.attributes.get(Person.ETHNICITY);</span>

<span class="pc bpc" id="L287" title="1 of 2 branches missed.">    if (race.equals(&quot;hispanic&quot;)) {</span>
<span class="nc" id="L288">      race = &quot;other&quot;;</span>
<span class="nc" id="L289">      ethnicity = &quot;hispanic&quot;;</span>
    } else {
<span class="fc" id="L291">      ethnicity = &quot;nonhispanic&quot;;</span>
    }

    String raceDisplay;
<span class="pc bpc" id="L295" title="2 of 5 branches missed.">    switch (race) {</span>
      case &quot;white&quot;:
<span class="fc" id="L297">        raceDisplay = &quot;White&quot;;</span>
<span class="fc" id="L298">        break;</span>
      case &quot;black&quot;:
<span class="fc" id="L300">        raceDisplay = &quot;Black or African American&quot;;</span>
<span class="fc" id="L301">        break;</span>
      case &quot;asian&quot;:
<span class="fc" id="L303">        raceDisplay = &quot;Asian&quot;;</span>
<span class="fc" id="L304">        break;</span>
      case &quot;native&quot;:
<span class="nc" id="L306">        raceDisplay = &quot;American Indian or Alaska Native&quot;;</span>
<span class="nc" id="L307">        break;</span>
      default: // Hispanic or Other (Put Hawaiian and Pacific Islander here for now)
<span class="nc" id="L309">        raceDisplay = &quot;Other&quot;;</span>
        break;
    }

    String ethnicityDisplay;
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">    if (ethnicity.equals(&quot;hispanic&quot;)) {</span>
<span class="nc" id="L315">      ethnicityDisplay = &quot;Hispanic or Latino&quot;;</span>
    } else {
<span class="fc" id="L317">      ethnicityDisplay = &quot;Not Hispanic or Latino&quot;;</span>
    }

<span class="fc" id="L320">    Code raceCode = new Code(</span>
        &quot;http://hl7.org/fhir/v3/Race&quot;,
<span class="fc" id="L322">        (String) raceEthnicityCodes.get(race),</span>
        raceDisplay);

<span class="fc" id="L325">    Code ethnicityCode = new Code(</span>
        &quot;http://hl7.org/fhir/v3/Ethnicity&quot;,
<span class="fc" id="L327">        (String) raceEthnicityCodes.get(ethnicity),</span>
        ethnicityDisplay);

<span class="fc" id="L330">    raceExtension.setValue(mapCodeToCodeableConcept(raceCode, &quot;http://hl7.org/fhir/v3/Race&quot;));</span>
<span class="fc" id="L331">    ethnicityExtension.setValue(mapCodeToCodeableConcept(ethnicityCode, &quot;http://hl7.org/fhir/v3/Ethnicity&quot;));</span>

<span class="fc" id="L333">    patientResource.addUndeclaredExtension(raceExtension);</span>
<span class="fc" id="L334">    patientResource.addUndeclaredExtension(ethnicityExtension);</span>

<span class="fc" id="L336">    String firstLanguage = (String) person.attributes.get(Person.FIRST_LANGUAGE);</span>
<span class="fc" id="L337">    Map languageMap = (Map) languageLookup.get(firstLanguage);</span>
<span class="fc" id="L338">    Code languageCode = new Code((String) languageMap.get(&quot;system&quot;),</span>
<span class="fc" id="L339">        (String) languageMap.get(&quot;code&quot;), (String) languageMap.get(&quot;display&quot;));</span>
<span class="fc" id="L340">    List&lt;Communication&gt; communication = new ArrayList&lt;Communication&gt;();</span>
<span class="fc" id="L341">    Communication language = new Communication();</span>
<span class="fc" id="L342">    language</span>
<span class="fc" id="L343">        .setLanguage(mapCodeToCodeableConcept(languageCode, (String) languageMap.get(&quot;system&quot;)));</span>
<span class="fc" id="L344">    communication.add(language);</span>
<span class="fc" id="L345">    patientResource.setCommunication(communication);</span>

<span class="fc" id="L347">    HumanNameDt name = patientResource.addName();</span>
<span class="fc" id="L348">    name.setUse(NameUseEnum.OFFICIAL);</span>
<span class="fc" id="L349">    name.addGiven((String) person.attributes.get(Person.FIRST_NAME));</span>
<span class="fc" id="L350">    List&lt;StringDt&gt; officialFamilyNames = new ArrayList&lt;StringDt&gt;();</span>
<span class="fc" id="L351">    officialFamilyNames.add(new StringDt((String) person.attributes.get(Person.LAST_NAME)));</span>
<span class="fc" id="L352">    name.setFamily(officialFamilyNames);</span>
<span class="fc bfc" id="L353" title="All 2 branches covered.">    if (person.attributes.get(Person.NAME_PREFIX) != null) {</span>
<span class="fc" id="L354">      name.addPrefix((String) person.attributes.get(Person.NAME_PREFIX));</span>
    }
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">    if (person.attributes.get(Person.NAME_SUFFIX) != null) {</span>
<span class="nc" id="L357">      name.addSuffix((String) person.attributes.get(Person.NAME_SUFFIX));</span>
    }
<span class="fc bfc" id="L359" title="All 2 branches covered.">    if (person.attributes.get(Person.MAIDEN_NAME) != null) {</span>
<span class="fc" id="L360">      HumanNameDt maidenName = patientResource.addName();</span>
<span class="fc" id="L361">      maidenName.setUse(NameUseEnum.MAIDEN);</span>
<span class="fc" id="L362">      maidenName.addGiven((String) person.attributes.get(Person.FIRST_NAME));</span>
<span class="fc" id="L363">      List&lt;StringDt&gt; maidenFamilyNames = new ArrayList&lt;StringDt&gt;();</span>
<span class="fc" id="L364">      maidenFamilyNames.add(new StringDt((String) person.attributes.get(Person.MAIDEN_NAME)));</span>
<span class="fc" id="L365">      maidenName.setFamily(maidenFamilyNames);</span>
<span class="pc bpc" id="L366" title="1 of 2 branches missed.">      if (person.attributes.get(Person.NAME_PREFIX) != null) {</span>
<span class="fc" id="L367">        maidenName.addPrefix((String) person.attributes.get(Person.NAME_PREFIX));</span>
      }
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">      if (person.attributes.get(Person.NAME_SUFFIX) != null) {</span>
<span class="nc" id="L370">        maidenName.addSuffix((String) person.attributes.get(Person.NAME_SUFFIX));</span>
      }
    }

<span class="fc" id="L374">    ExtensionDt mothersMaidenNameExtension = new ExtensionDt();</span>
<span class="fc" id="L375">    mothersMaidenNameExtension</span>
<span class="fc" id="L376">        .setUrl(&quot;http://hl7.org/fhir/StructureDefinition/patient-mothersMaidenName&quot;);</span>
<span class="fc" id="L377">    String mothersMaidenName = (String) person.attributes.get(Person.NAME_MOTHER);</span>
<span class="fc" id="L378">    mothersMaidenNameExtension.setValue(new StringDt(mothersMaidenName));</span>
<span class="fc" id="L379">    patientResource.addUndeclaredExtension(mothersMaidenNameExtension);</span>

<span class="fc" id="L381">    long birthdate = (long) person.attributes.get(Person.BIRTHDATE);</span>
<span class="fc" id="L382">    patientResource.setBirthDate(new DateDt(new Date(birthdate)));</span>

<span class="fc" id="L384">    ExtensionDt birthSexExtension = new ExtensionDt();</span>
<span class="fc" id="L385">    birthSexExtension.setUrl(&quot;http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex&quot;);</span>
<span class="fc bfc" id="L386" title="All 2 branches covered.">    if (person.attributes.get(Person.GENDER).equals(&quot;M&quot;)) {</span>
<span class="fc" id="L387">      patientResource.setGender(AdministrativeGenderEnum.MALE);</span>
<span class="fc" id="L388">      birthSexExtension.setValue(new CodeDt(&quot;M&quot;));</span>
<span class="pc bpc" id="L389" title="1 of 2 branches missed.">    } else if (person.attributes.get(Person.GENDER).equals(&quot;F&quot;)) {</span>
<span class="fc" id="L390">      patientResource.setGender(AdministrativeGenderEnum.FEMALE);</span>
<span class="fc" id="L391">      birthSexExtension.setValue(new CodeDt(&quot;F&quot;));</span>
    }
<span class="fc" id="L393">    patientResource.addUndeclaredExtension(birthSexExtension);</span>

<span class="fc" id="L395">    String state = (String) person.attributes.get(Person.STATE);</span>

<span class="fc" id="L397">    AddressDt addrResource = patientResource.addAddress();</span>
<span class="fc" id="L398">    addrResource.addLine((String) person.attributes.get(Person.ADDRESS))</span>
<span class="fc" id="L399">        .setCity((String) person.attributes.get(Person.CITY))</span>
<span class="fc" id="L400">        .setPostalCode((String) person.attributes.get(Person.ZIP))</span>
<span class="fc" id="L401">        .setState(state);</span>
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">    if (COUNTRY_CODE != null) {</span>
<span class="fc" id="L403">      addrResource.setCountry(COUNTRY_CODE);</span>
    }

<span class="fc" id="L406">    DirectPosition2D coord = person.getLatLon();</span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">    if (coord != null) {</span>
<span class="fc" id="L408">      ExtensionDt geolocationExtension = new ExtensionDt();</span>
<span class="fc" id="L409">      geolocationExtension.setUrl(&quot;http://hl7.org/fhir/StructureDefinition/geolocation&quot;);</span>
<span class="fc" id="L410">      ExtensionDt latitudeExtension = new ExtensionDt();</span>
<span class="fc" id="L411">      ExtensionDt longitudeExtension = new ExtensionDt();</span>
<span class="fc" id="L412">      latitudeExtension.setUrl(&quot;latitude&quot;);</span>
<span class="fc" id="L413">      longitudeExtension.setUrl(&quot;longitude&quot;);</span>
<span class="fc" id="L414">      latitudeExtension.setValue(new DecimalDt(coord.getY()));</span>
<span class="fc" id="L415">      longitudeExtension.setValue(new DecimalDt(coord.getX()));</span>
<span class="fc" id="L416">      geolocationExtension.addUndeclaredExtension(latitudeExtension);</span>
<span class="fc" id="L417">      geolocationExtension.addUndeclaredExtension(longitudeExtension);</span>
<span class="fc" id="L418">      addrResource.addUndeclaredExtension(geolocationExtension);</span>
    }

<span class="fc" id="L421">    AddressDt birthplace = new AddressDt();</span>
<span class="fc" id="L422">    birthplace.setCity((String) person.attributes.get(Person.BIRTH_CITY))</span>
<span class="fc" id="L423">            .setState((String) person.attributes.get(Person.BIRTH_STATE))</span>
<span class="fc" id="L424">            .setCountry((String) person.attributes.get(Person.BIRTH_COUNTRY));</span>

<span class="fc" id="L426">    ExtensionDt birthplaceExtension = new ExtensionDt();</span>
<span class="fc" id="L427">    birthplaceExtension.setUrl(&quot;http://hl7.org/fhir/StructureDefinition/birthPlace&quot;);</span>
<span class="fc" id="L428">    birthplaceExtension.setValue(birthplace);</span>
<span class="fc" id="L429">    patientResource.addUndeclaredExtension(birthplaceExtension);</span>

<span class="pc bpc" id="L431" title="1 of 2 branches missed.">    if (person.attributes.get(Person.MULTIPLE_BIRTH_STATUS) != null) {</span>
<span class="nc" id="L432">      patientResource.setMultipleBirth(</span>
<span class="nc" id="L433">          new IntegerDt((int) person.attributes.get(Person.MULTIPLE_BIRTH_STATUS)));</span>
    } else {
<span class="fc" id="L435">      patientResource.setMultipleBirth(new BooleanDt(false));</span>
    }

<span class="fc" id="L438">    patientResource.addTelecom().setSystem(ContactPointSystemEnum.PHONE)</span>
<span class="fc" id="L439">        .setUse(ContactPointUseEnum.HOME).setValue((String) person.attributes.get(Person.TELECOM));</span>

<span class="fc" id="L441">    String maritalStatus = ((String) person.attributes.get(Person.MARITAL_STATUS));</span>
<span class="fc bfc" id="L442" title="All 2 branches covered.">    if (maritalStatus != null) {</span>
<span class="fc" id="L443">      patientResource.setMaritalStatus(MaritalStatusCodesEnum.forCode(maritalStatus.toUpperCase()));</span>
    } else {
<span class="fc" id="L445">      patientResource.setMaritalStatus(MaritalStatusCodesEnum.S);</span>
    }

<span class="pc bpc" id="L448" title="1 of 2 branches missed.">    if (!person.alive(stopTime)) {</span>
<span class="nc" id="L449">      patientResource.setDeceased(</span>
<span class="nc" id="L450">          convertFhirDateTime(person.events.event(Event.DEATH).time, true));</span>
    }

<span class="fc" id="L453">    String generatedBySynthea = &quot;Generated by &lt;a href=\&quot;https://github.com/synthetichealth/synthea\&quot;&gt;Synthea&lt;/a&gt;.&quot;</span>
        + &quot;Version identifier: &quot; + Utilities.SYNTHEA_VERSION + &quot; . &quot;
        + &quot;  Person seed: &quot; + person.seed
        + &quot;  Population seed: &quot; + person.populationSeed;

<span class="fc" id="L458">    patientResource.setText(new NarrativeDt(</span>
        new XhtmlDt(generatedBySynthea), NarrativeStatusEnum.GENERATED));

    // DALY and QALY values
    // we only write the last(current) one to the patient record
<span class="fc" id="L463">    Double dalyValue = (Double) person.attributes.get(&quot;most-recent-daly&quot;);</span>
<span class="fc" id="L464">    Double qalyValue = (Double) person.attributes.get(&quot;most-recent-qaly&quot;);</span>
<span class="pc bpc" id="L465" title="1 of 2 branches missed.">    if (dalyValue != null) {</span>
<span class="fc" id="L466">      ExtensionDt dalyExtension = new ExtensionDt();</span>
<span class="fc" id="L467">      dalyExtension.setUrl(SYNTHEA_EXT + &quot;disability-adjusted-life-years&quot;);</span>
<span class="fc" id="L468">      DecimalDt daly = new DecimalDt(dalyValue);</span>
<span class="fc" id="L469">      dalyExtension.setValue(daly);</span>
<span class="fc" id="L470">      patientResource.addUndeclaredExtension(dalyExtension);</span>

<span class="fc" id="L472">      ExtensionDt qalyExtension = new ExtensionDt();</span>
<span class="fc" id="L473">      qalyExtension.setUrl(SYNTHEA_EXT + &quot;quality-adjusted-life-years&quot;);</span>
<span class="fc" id="L474">      DecimalDt qaly = new DecimalDt(qalyValue);</span>
<span class="fc" id="L475">      qalyExtension.setValue(qaly);</span>
<span class="fc" id="L476">      patientResource.addUndeclaredExtension(qalyExtension);</span>
    }

<span class="fc" id="L479">    return newEntry(bundle, patientResource);</span>
  }

  /**
   * Map the given Encounter into a FHIR Encounter resource, and add it to the given Bundle.
   *
   * @param person
   *          Patient at the encounter.
   * @param personEntry
   *          Entry for the Person
   * @param bundle
   *          The Bundle to add to
   * @param encounter
   *          The current Encounter
   * @return The added Entry
   */
  private static Entry encounter(Person person, Entry personEntry,
      Bundle bundle, Encounter encounter) {

<span class="fc" id="L498">    ca.uhn.fhir.model.dstu2.resource.Encounter encounterResource =</span>
        new ca.uhn.fhir.model.dstu2.resource.Encounter();

<span class="fc" id="L501">    encounterResource.setPatient(new ResourceReferenceDt(personEntry.getFullUrl()));</span>
<span class="fc" id="L502">    encounterResource.setStatus(EncounterStateEnum.FINISHED);</span>
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">    if (encounter.codes.isEmpty()) {</span>
      // wellness encounter
<span class="nc" id="L505">      encounterResource.addType().addCoding().setCode(&quot;185349003&quot;)</span>
<span class="nc" id="L506">          .setDisplay(&quot;Encounter for check up&quot;).setSystem(SNOMED_URI);</span>
    } else {
<span class="fc" id="L508">      Code code = encounter.codes.get(0);</span>
<span class="fc" id="L509">      encounterResource.addType(mapCodeToCodeableConcept(code, SNOMED_URI));</span>
    }

<span class="fc" id="L512">    encounterResource.setClassElement(EncounterClassEnum.forCode(encounter.type));</span>
<span class="fc" id="L513">    encounterResource.setPeriod(new PeriodDt()</span>
<span class="fc" id="L514">        .setStart(new DateTimeDt(new Date(encounter.start)))</span>
<span class="fc" id="L515">        .setEnd(new DateTimeDt(new Date(encounter.stop))));</span>

<span class="fc bfc" id="L517" title="All 2 branches covered.">    if (encounter.reason != null) {</span>
<span class="fc" id="L518">      encounterResource.addReason().addCoding().setCode(encounter.reason.code)</span>
<span class="fc" id="L519">          .setDisplay(encounter.reason.display).setSystem(SNOMED_URI);</span>
    }

<span class="pc bpc" id="L522" title="1 of 2 branches missed.">    if (encounter.provider != null) {</span>
<span class="fc" id="L523">      String providerFullUrl = findProviderUrl(encounter.provider, bundle);</span>

<span class="fc bfc" id="L525" title="All 2 branches covered.">      if (providerFullUrl != null) {</span>
<span class="fc" id="L526">        encounterResource.setServiceProvider(new ResourceReferenceDt(providerFullUrl));</span>
      } else {
<span class="fc" id="L528">        Entry providerOrganization = provider(bundle, encounter.provider);</span>
<span class="fc" id="L529">        encounterResource</span>
<span class="fc" id="L530">            .setServiceProvider(new ResourceReferenceDt(providerOrganization.getFullUrl()));</span>
      }
<span class="fc" id="L532">    } else { // no associated provider, patient goes to ambulatory provider</span>
<span class="nc" id="L533">      Provider provider = person.getProvider(EncounterType.AMBULATORY, encounter.start);</span>
<span class="nc" id="L534">      String providerFullUrl = findProviderUrl(provider, bundle);</span>

<span class="nc bnc" id="L536" title="All 2 branches missed.">      if (providerFullUrl != null) {</span>
<span class="nc" id="L537">        encounterResource.setServiceProvider(new ResourceReferenceDt(providerFullUrl));</span>
      } else {
<span class="nc" id="L539">        Entry providerOrganization = provider(bundle, provider);</span>
<span class="nc" id="L540">        encounterResource</span>
<span class="nc" id="L541">            .setServiceProvider(new ResourceReferenceDt(providerOrganization.getFullUrl()));</span>
      }
    }

<span class="pc bpc" id="L545" title="1 of 2 branches missed.">    if (encounter.clinician != null) {</span>
<span class="fc" id="L546">      String practitionerFullUrl = findPractitioner(encounter.clinician, bundle);</span>

<span class="fc bfc" id="L548" title="All 2 branches covered.">      if (practitionerFullUrl != null) {</span>
<span class="fc" id="L549">        encounterResource.addParticipant().setIndividual(</span>
            new ResourceReferenceDt(practitionerFullUrl));
      } else {
<span class="fc" id="L552">        Entry practitioner = practitioner(bundle, encounter.clinician);</span>
<span class="fc" id="L553">        encounterResource.addParticipant().setIndividual(</span>
<span class="fc" id="L554">            new ResourceReferenceDt(practitioner.getFullUrl()));</span>
      }
    }

<span class="pc bpc" id="L558" title="1 of 2 branches missed.">    if (encounter.discharge != null) {</span>
<span class="nc" id="L559">      Hospitalization hospitalization = new Hospitalization();</span>
<span class="nc" id="L560">      Code dischargeDisposition = new Code(DISCHARGE_URI, encounter.discharge.code,</span>
          encounter.discharge.display);
<span class="nc" id="L562">      hospitalization</span>
<span class="nc" id="L563">          .setDischargeDisposition(mapCodeToCodeableConcept(dischargeDisposition, DISCHARGE_URI));</span>
<span class="nc" id="L564">      encounterResource.setHospitalization(hospitalization);</span>
    }

<span class="fc" id="L567">    return newEntry(bundle, encounterResource);</span>
  }

  /**
   * Find the provider entry in this bundle, and return the associated &quot;fullUrl&quot; attribute.
   * @param provider A given provider.
   * @param bundle The current bundle being generated.
   * @return Provider.fullUrl if found, otherwise null.
   */
  private static String findProviderUrl(Provider provider, Bundle bundle) {
<span class="fc bfc" id="L577" title="All 2 branches covered.">    for (Entry entry : bundle.getEntry()) {</span>
<span class="fc bfc" id="L578" title="All 2 branches covered.">      if (entry.getResource().getResourceName().equals(&quot;Organization&quot;)) {</span>
<span class="fc" id="L579">        Organization org = (Organization) entry.getResource();</span>
<span class="fc bfc" id="L580" title="All 2 branches covered.">        if (org.getIdentifierFirstRep().getValue().equals(provider.getResourceID())) {</span>
<span class="fc" id="L581">          return entry.getFullUrl();</span>
        }
      }
<span class="fc" id="L584">    }</span>
<span class="fc" id="L585">    return null;</span>
  }

  /**
   * Find the Practitioner entry in this bundle, and return the associated &quot;fullUrl&quot;
   * attribute.
   * @param clinician A given clinician.
   * @param bundle The current bundle being generated.
   * @return Practitioner.fullUrl if found, otherwise null.
   */
  private static String findPractitioner(Clinician clinician, Bundle bundle) {
<span class="fc bfc" id="L596" title="All 2 branches covered.">    for (Entry entry : bundle.getEntry()) {</span>
<span class="fc bfc" id="L597" title="All 2 branches covered.">      if (entry.getResource().getResourceName().equals(&quot;Practitioner&quot;)) {</span>
<span class="fc" id="L598">        Practitioner doc = (Practitioner) entry.getResource();</span>
<span class="fc bfc" id="L599" title="All 2 branches covered.">        if (doc.getIdentifierFirstRep().getValue().equals(&quot;&quot; + clinician.seed)) {</span>
<span class="fc" id="L600">          return entry.getFullUrl();</span>
        }
      }
<span class="fc" id="L603">    }</span>
<span class="fc" id="L604">    return null;</span>
  }

  /**
   * Create an entry for the given Claim, which references a Medication.
   *
   * @param personEntry
   *          Entry for the person
   * @param bundle
   *          The Bundle to add to
   * @param encounterEntry
   *          The current Encounter
   * @param claim
   *          the Claim object
   * @param medicationEntry
   *          The Entry for the Medication object, previously created
   * @return the added Entry
   */
  private static Entry medicationClaim(Entry personEntry, Bundle bundle, Entry encounterEntry,
      Claim claim, Entry medicationEntry) {
<span class="fc" id="L624">    ca.uhn.fhir.model.dstu2.resource.Claim claimResource =</span>
        new ca.uhn.fhir.model.dstu2.resource.Claim();
<span class="fc" id="L626">    ca.uhn.fhir.model.dstu2.resource.Encounter encounterResource =</span>
        (ca.uhn.fhir.model.dstu2.resource.Encounter) encounterEntry
<span class="fc" id="L628">        .getResource();</span>

    // assume institutional claim
<span class="fc" id="L631">    claimResource.setType(ClaimTypeEnum.INSTITUTIONAL); // TODO review claim type</span>

<span class="fc" id="L633">    claimResource.setUse(UseEnum.COMPLETE);</span>

<span class="fc" id="L635">    claimResource.setPatient(new ResourceReferenceDt(personEntry.getFullUrl()));</span>
<span class="fc" id="L636">    claimResource.setOrganization(encounterResource.getServiceProvider());</span>

    // add prescription.
<span class="fc" id="L639">    claimResource.setPrescription(new ResourceReferenceDt(medicationEntry.getFullUrl()));</span>

<span class="fc" id="L641">    return newEntry(bundle, claimResource);</span>
  }

  /**
   * Create an entry for the given Claim, associated to an Encounter.
   *
   * @param personEntry
   *          Entry for the person
   * @param bundle
   *          The Bundle to add to
   * @param encounterEntry
   *          The current Encounter
   * @param claim
   *          the Claim object
   * @return the added Entry
   */
  private static Entry encounterClaim(Entry personEntry, Bundle bundle, Entry encounterEntry,
      Claim claim) {
<span class="fc" id="L659">    ca.uhn.fhir.model.dstu2.resource.Claim claimResource =</span>
        new ca.uhn.fhir.model.dstu2.resource.Claim();
<span class="fc" id="L661">    ca.uhn.fhir.model.dstu2.resource.Encounter encounterResource =</span>
        (ca.uhn.fhir.model.dstu2.resource.Encounter) encounterEntry
<span class="fc" id="L663">        .getResource();</span>

    // assume institutional claim
<span class="fc" id="L666">    claimResource.setType(ClaimTypeEnum.INSTITUTIONAL);</span>

<span class="fc" id="L668">    claimResource.setUse(UseEnum.COMPLETE);</span>

<span class="fc" id="L670">    claimResource.setPatient(new ResourceReferenceDt(personEntry.getFullUrl()));</span>
<span class="fc" id="L671">    claimResource.setOrganization(encounterResource.getServiceProvider());</span>

    // Add data for the encounter
<span class="fc" id="L674">    ca.uhn.fhir.model.dstu2.resource.Claim.Item encounterItem =</span>
        new ca.uhn.fhir.model.dstu2.resource.Claim.Item();
<span class="fc" id="L676">    encounterItem.setSequence(new PositiveIntDt(1));</span>

    // assume item type is clinical service invoice
<span class="fc" id="L679">    CodingDt itemType = new CodingDt();</span>
<span class="fc" id="L680">    itemType.setSystem(&quot;http://hl7.org/fhir/v3/ActCode&quot;)</span>
<span class="fc" id="L681">        .setCode(&quot;CSINV&quot;)</span>
<span class="fc" id="L682">        .setDisplay(&quot;clinical service invoice&quot;);</span>
<span class="fc" id="L683">    encounterItem.setType(itemType);</span>
<span class="fc" id="L684">    CodingDt itemService = new CodingDt();</span>
<span class="fc" id="L685">    ca.uhn.fhir.model.dstu2.resource.Encounter encounter =</span>
<span class="fc" id="L686">        (ca.uhn.fhir.model.dstu2.resource.Encounter) encounterEntry.getResource();</span>
<span class="fc" id="L687">    itemService.setSystem(encounter.getTypeFirstRep().getCodingFirstRep().getSystem())</span>
<span class="fc" id="L688">        .setCode(encounter.getTypeFirstRep().getCodingFirstRep().getCode())</span>
<span class="fc" id="L689">        .setDisplay(encounter.getTypeFirstRep().getCodingFirstRep().getDisplay());</span>
<span class="fc" id="L690">    encounterItem.setService(itemService);</span>
<span class="fc" id="L691">    claimResource.addItem(encounterItem);</span>

<span class="fc" id="L693">    int itemSequence = 2;</span>
<span class="fc" id="L694">    int conditionSequence = 1;</span>
<span class="fc bfc" id="L695" title="All 2 branches covered.">    for (HealthRecord.Entry item : claim.items) {</span>
<span class="fc bfc" id="L696" title="All 2 branches covered.">      if (Costs.hasCost(item)) {</span>
        // update claimItems list
<span class="fc" id="L698">        ca.uhn.fhir.model.dstu2.resource.Claim.Item procedureItem =</span>
            new ca.uhn.fhir.model.dstu2.resource.Claim.Item();
<span class="fc" id="L700">        procedureItem.setSequence(new PositiveIntDt(itemSequence));</span>

        // calculate the cost of the procedure
<span class="fc" id="L703">        MoneyDt moneyResource = new MoneyDt();</span>
<span class="fc" id="L704">        moneyResource.setCode(&quot;USD&quot;);</span>
<span class="fc" id="L705">        moneyResource.setSystem(&quot;urn:iso:std:iso:4217&quot;);</span>
<span class="fc" id="L706">        moneyResource.setValue(item.cost());</span>
<span class="fc" id="L707">        procedureItem.setNet(moneyResource);</span>

        // assume item type is clinical service invoice
<span class="fc" id="L710">        itemType = new CodingDt();</span>
<span class="fc" id="L711">        itemType.setSystem(&quot;http://hl7.org/fhir/v3/ActCode&quot;)</span>
<span class="fc" id="L712">            .setCode(&quot;CSINV&quot;)</span>
<span class="fc" id="L713">            .setDisplay(&quot;clinical service invoice&quot;);</span>
<span class="fc" id="L714">        procedureItem.setType(itemType);</span>

        // item service should match the entry code
<span class="fc" id="L717">        itemService = new CodingDt();</span>
<span class="fc" id="L718">        itemService.setSystem(item.codes.get(0).system)</span>
<span class="fc" id="L719">            .setCode(item.codes.get(0).code)</span>
<span class="fc" id="L720">            .setDisplay(item.codes.get(0).display);</span>
<span class="fc" id="L721">        procedureItem.setService(itemService);</span>

<span class="fc" id="L723">        claimResource.addItem(procedureItem);</span>
<span class="fc" id="L724">      } else {</span>
        // assume it's a Condition, we don't have a Condition class specifically
        // add diagnosisComponent to claim
<span class="fc" id="L727">        ca.uhn.fhir.model.dstu2.resource.Claim.Diagnosis diagnosisComponent =</span>
            new ca.uhn.fhir.model.dstu2.resource.Claim.Diagnosis();
<span class="fc" id="L729">        diagnosisComponent.setSequence(new PositiveIntDt(conditionSequence));</span>
<span class="pc bpc" id="L730" title="1 of 2 branches missed.">        if (item.codes.size() &gt; 0) {</span>
          // use first code
<span class="fc" id="L732">          diagnosisComponent.setDiagnosis(</span>
<span class="fc" id="L733">              new CodingDt(item.codes.get(0).system, item.codes.get(0).code));</span>
        }
<span class="fc" id="L735">        claimResource.addDiagnosis(diagnosisComponent);</span>
<span class="fc" id="L736">        conditionSequence++;</span>
      }
<span class="fc" id="L738">      itemSequence++;</span>
<span class="fc" id="L739">    }</span>

<span class="fc" id="L741">    return newEntry(bundle, claimResource);</span>
  }

  /**
   * Map the Condition into a FHIR Condition resource, and add it to the given Bundle.
   *
   * @param personEntry
   *          The Entry for the Person
   * @param bundle
   *          The Bundle to add to
   * @param encounterEntry
   *          The current Encounter entry
   * @param condition
   *          The Condition
   * @return The added Entry
   */
  private static Entry condition(Entry personEntry, Bundle bundle, Entry encounterEntry,
      HealthRecord.Entry condition) {
<span class="fc" id="L759">    Condition conditionResource = new Condition();</span>

<span class="fc" id="L761">    conditionResource.setPatient(new ResourceReferenceDt(personEntry.getFullUrl()));</span>
<span class="fc" id="L762">    conditionResource.setEncounter(new ResourceReferenceDt(encounterEntry.getFullUrl()));</span>

<span class="fc" id="L764">    Code code = condition.codes.get(0);</span>
<span class="fc" id="L765">    conditionResource.setCode(mapCodeToCodeableConcept(code, SNOMED_URI));</span>
<span class="fc" id="L766">    conditionResource.setCategory(ConditionCategoryCodesEnum.DIAGNOSIS);</span>
<span class="fc" id="L767">    conditionResource.setVerificationStatus(ConditionVerificationStatusEnum.CONFIRMED);</span>
<span class="fc" id="L768">    conditionResource.setClinicalStatus(ConditionClinicalStatusCodesEnum.ACTIVE);</span>

<span class="fc" id="L770">    conditionResource.setOnset(convertFhirDateTime(condition.start, true));</span>
<span class="fc" id="L771">    conditionResource.setDateRecorded(new DateDt(new Date(condition.start)));</span>

<span class="fc bfc" id="L773" title="All 2 branches covered.">    if (condition.stop != 0) {</span>
<span class="fc" id="L774">      conditionResource.setAbatement(convertFhirDateTime(condition.stop, true));</span>
<span class="fc" id="L775">      conditionResource.setClinicalStatus(ConditionClinicalStatusCodesEnum.RESOLVED);</span>
    }

<span class="fc" id="L778">    Entry conditionEntry = newEntry(bundle, conditionResource);</span>

<span class="fc" id="L780">    condition.fullUrl = conditionEntry.getFullUrl();</span>

<span class="fc" id="L782">    return conditionEntry;</span>
  }

  /**
   * Map the Condition into a FHIR AllergyIntolerance resource, and add it to the given Bundle.
   *
   * @param personEntry
   *          The Entry for the Person
   * @param bundle
   *          The Bundle to add to
   * @param encounterEntry
   *          The current Encounter entry
   * @param allergy
   *          The Allergy Entry
   * @return The added Entry
   */
  private static Entry allergy(Entry personEntry, Bundle bundle,
      Entry encounterEntry, HealthRecord.Entry allergy) {

<span class="fc" id="L801">    AllergyIntolerance allergyResource = new AllergyIntolerance();</span>

<span class="fc" id="L803">    allergyResource.setOnset((DateTimeDt)convertFhirDateTime(allergy.start, true));</span>

<span class="pc bpc" id="L805" title="1 of 2 branches missed.">    if (allergy.stop == 0) {</span>
<span class="fc" id="L806">      allergyResource.setStatus(AllergyIntoleranceStatusEnum.ACTIVE);</span>
    } else {
<span class="nc" id="L808">      allergyResource.setStatus(AllergyIntoleranceStatusEnum.INACTIVE);</span>
    }

<span class="fc" id="L811">    allergyResource.setType(AllergyIntoleranceTypeEnum.ALLERGY);</span>
<span class="fc" id="L812">    AllergyIntoleranceCategoryEnum category = AllergyIntoleranceCategoryEnum.FOOD;</span>
<span class="fc" id="L813">    allergyResource.setCategory(category); // TODO: allergy categories in GMF</span>
<span class="fc" id="L814">    allergyResource.setCriticality(AllergyIntoleranceCriticalityEnum.LOW_RISK);</span>
<span class="fc" id="L815">    allergyResource.setPatient(new ResourceReferenceDt(personEntry.getFullUrl()));</span>
<span class="fc" id="L816">    Code code = allergy.codes.get(0);</span>
<span class="fc" id="L817">    allergyResource.setSubstance(mapCodeToCodeableConcept(code, SNOMED_URI));</span>

<span class="fc" id="L819">    Entry allergyEntry = newEntry(bundle, allergyResource);</span>
<span class="fc" id="L820">    allergy.fullUrl = allergyEntry.getFullUrl();</span>
<span class="fc" id="L821">    return allergyEntry;</span>
  }

  /**
   * Map the given Observation into a FHIR Observation resource, and add it to the given Bundle.
   *
   * @param personEntry
   *          The Person Entry
   * @param bundle
   *          The Bundle to add to
   * @param encounterEntry
   *          The current Encounter entry
   * @param observation
   *          The Observation
   * @return The added Entry
   */
  private static Entry observation(Entry personEntry, Bundle bundle, Entry encounterEntry,
      Observation observation) {
<span class="fc" id="L839">    ca.uhn.fhir.model.dstu2.resource.Observation observationResource =</span>
        new ca.uhn.fhir.model.dstu2.resource.Observation();

<span class="fc" id="L842">    observationResource.setSubject(new ResourceReferenceDt(personEntry.getFullUrl()));</span>
<span class="fc" id="L843">    observationResource.setEncounter(new ResourceReferenceDt(encounterEntry.getFullUrl()));</span>

<span class="fc" id="L845">    observationResource.setStatus(ObservationStatusEnum.FINAL);</span>

<span class="fc" id="L847">    Code code = observation.codes.get(0);</span>
<span class="fc" id="L848">    observationResource.setCode(mapCodeToCodeableConcept(code, LOINC_URI));</span>

<span class="fc" id="L850">    Code category = new Code(&quot;http://hl7.org/fhir/observation-category&quot;, observation.category,</span>
        observation.category);
<span class="fc" id="L852">    observationResource.setCategory(</span>
<span class="fc" id="L853">        mapCodeToCodeableConcept(category, &quot;http://hl7.org/fhir/observation-category&quot;));</span>

<span class="fc bfc" id="L855" title="All 2 branches covered.">    if (observation.value != null) {</span>
<span class="fc" id="L856">      IDatatype value = mapValueToFHIRType(observation.value, observation.unit);</span>
<span class="fc" id="L857">      observationResource.setValue(value);</span>
<span class="pc bpc" id="L858" title="2 of 4 branches missed.">    } else if (observation.observations != null &amp;&amp; !observation.observations.isEmpty()) {</span>
      // multi-observation (ex blood pressure)
<span class="fc bfc" id="L860" title="All 2 branches covered.">      for (Observation subObs : observation.observations) {</span>
<span class="fc" id="L861">        Component comp = new Component();</span>
<span class="fc" id="L862">        comp.setCode(mapCodeToCodeableConcept(subObs.codes.get(0), LOINC_URI));</span>
<span class="fc" id="L863">        IDatatype value = mapValueToFHIRType(subObs.value, subObs.unit);</span>
<span class="fc" id="L864">        comp.setValue(value);</span>
<span class="fc" id="L865">        observationResource.addComponent(comp);</span>
<span class="fc" id="L866">      }</span>
    }

<span class="fc" id="L869">    observationResource.setEffective(convertFhirDateTime(observation.start, true));</span>
<span class="fc" id="L870">    observationResource.setIssued(new InstantDt(new Date(observation.start)));</span>

<span class="fc" id="L872">    Entry entry = newEntry(bundle, observationResource);</span>
<span class="fc" id="L873">    observation.fullUrl = entry.getFullUrl();</span>
<span class="fc" id="L874">    return entry;</span>
  }

  private static IDatatype mapValueToFHIRType(Object value, String unit) {
<span class="pc bpc" id="L878" title="1 of 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L879">      return null;</span>

<span class="pc bpc" id="L881" title="1 of 2 branches missed.">    } else if (value instanceof Condition) {</span>
<span class="nc" id="L882">      Code conditionCode = ((HealthRecord.Entry) value).codes.get(0);</span>
<span class="nc" id="L883">      return mapCodeToCodeableConcept(conditionCode, SNOMED_URI);</span>

<span class="fc bfc" id="L885" title="All 2 branches covered.">    } else if (value instanceof Code) {</span>
<span class="fc" id="L886">      return mapCodeToCodeableConcept((Code) value, SNOMED_URI);</span>

<span class="pc bpc" id="L888" title="1 of 2 branches missed.">    } else if (value instanceof String) {</span>
<span class="nc" id="L889">      return new StringDt((String) value);</span>

<span class="pc bpc" id="L891" title="1 of 2 branches missed.">    } else if (value instanceof Number) {</span>
<span class="fc" id="L892">      return new QuantityDt().setValue(((Number) value).doubleValue())</span>
<span class="fc" id="L893">          .setCode(unit).setSystem(&quot;http://unitsofmeasure.org&quot;)</span>
<span class="fc" id="L894">          .setUnit(unit);</span>

    } else {
<span class="nc" id="L897">      throw new IllegalArgumentException(&quot;unexpected observation value class: &quot;</span>
<span class="nc" id="L898">          + value.getClass().toString() + &quot;; &quot; + value);</span>
    }
  }

  /**
   * Map the given Procedure into a FHIR Procedure resource, and add it to the given Bundle.
   *
   * @param personEntry
   *          The Person entry
   * @param bundle
   *          Bundle to add to
   * @param encounterEntry
   *          The current Encounter entry
   * @param procedure
   *          The Procedure
   * @return The added Entry
   */
  private static Entry procedure(Entry personEntry, Bundle bundle, Entry encounterEntry,
      Procedure procedure) {
<span class="fc" id="L917">    ca.uhn.fhir.model.dstu2.resource.Procedure procedureResource =</span>
        new ca.uhn.fhir.model.dstu2.resource.Procedure();

<span class="fc" id="L920">    procedureResource.setStatus(ProcedureStatusEnum.COMPLETED);</span>
<span class="fc" id="L921">    procedureResource.setSubject(new ResourceReferenceDt(personEntry.getFullUrl()));</span>
<span class="fc" id="L922">    procedureResource.setEncounter(new ResourceReferenceDt(encounterEntry.getFullUrl()));</span>

<span class="fc" id="L924">    Code code = procedure.codes.get(0);</span>
<span class="fc" id="L925">    procedureResource.setCode(mapCodeToCodeableConcept(code, SNOMED_URI));</span>

<span class="pc bpc" id="L927" title="1 of 2 branches missed.">    if (procedure.stop != 0L) {</span>
<span class="fc" id="L928">      Date startDate = new Date(procedure.start);</span>
<span class="fc" id="L929">      Date endDate = new Date(procedure.stop);</span>
<span class="fc" id="L930">      procedureResource.setPerformed(</span>
<span class="fc" id="L931">          new PeriodDt().setStart(new DateTimeDt(startDate)).setEnd(new DateTimeDt(endDate)));</span>
<span class="fc" id="L932">    } else {</span>
<span class="nc" id="L933">      procedureResource.setPerformed(convertFhirDateTime(procedure.start, true));</span>
    }

<span class="fc bfc" id="L936" title="All 2 branches covered.">    if (!procedure.reasons.isEmpty()) {</span>
<span class="fc" id="L937">      Code reason = procedure.reasons.get(0); // Only one element in list</span>
<span class="fc bfc" id="L938" title="All 2 branches covered.">      for (Entry entry : bundle.getEntry()) {</span>
<span class="fc bfc" id="L939" title="All 2 branches covered.">        if (entry.getResource().getResourceName().equals(&quot;Condition&quot;)) {</span>
<span class="fc" id="L940">          Condition condition = (Condition) entry.getResource();</span>
<span class="fc" id="L941">          CodingDt coding = condition.getCode().getCoding().get(0); // Only one element in list</span>
<span class="fc bfc" id="L942" title="All 2 branches covered.">          if (reason.code.equals(coding.getCode())) {</span>
<span class="fc" id="L943">            procedureResource.setReason(new ResourceReferenceDt(entry.getFullUrl()));</span>
          }
        }
<span class="fc" id="L946">      }</span>
    }

<span class="fc" id="L949">    Entry procedureEntry = newEntry(bundle, procedureResource);</span>
<span class="fc" id="L950">    procedure.fullUrl = procedureEntry.getFullUrl();</span>

<span class="fc" id="L952">    return procedureEntry;</span>
  }

  private static Entry immunization(Entry personEntry, Bundle bundle, Entry encounterEntry,
      HealthRecord.Entry immunization) {
<span class="fc" id="L957">    Immunization immResource = new Immunization();</span>
<span class="fc" id="L958">    immResource.setStatus(&quot;completed&quot;);</span>
<span class="fc" id="L959">    immResource.setDate(new DateTimeDt(new Date(immunization.start)));</span>
<span class="fc" id="L960">    immResource.setVaccineCode(mapCodeToCodeableConcept(immunization.codes.get(0), CVX_URI));</span>
<span class="fc" id="L961">    immResource.setReported(new BooleanDt(false));</span>
<span class="fc" id="L962">    immResource.setWasNotGiven(false);</span>
<span class="fc" id="L963">    immResource.setPatient(new ResourceReferenceDt(personEntry.getFullUrl()));</span>
<span class="fc" id="L964">    immResource.setEncounter(new ResourceReferenceDt(encounterEntry.getFullUrl()));</span>
<span class="fc" id="L965">    Entry immunizationEntry = newEntry(bundle, immResource);</span>
<span class="fc" id="L966">    immunization.fullUrl = immunizationEntry.getFullUrl();</span>

<span class="fc" id="L968">    return immunizationEntry;</span>
  }

  /**
   * Map the given Medication to a FHIR MedicationRequest resource, and add it to the given Bundle.
   *
   * @param personEntry
   *          The Entry for the Person
   * @param bundle
   *          Bundle to add the Medication to
   * @param encounterEntry
   *          Current Encounter entry
   * @param medication
   *          The Medication
   * @return The added Entry
   */
  private static Entry medication(Entry personEntry, Bundle bundle, Entry encounterEntry,
      Medication medication) {
<span class="fc" id="L986">    MedicationOrder medicationResource = new MedicationOrder();</span>

<span class="fc" id="L988">    medicationResource.setPatient(new ResourceReferenceDt(personEntry.getFullUrl()));</span>
<span class="fc" id="L989">    medicationResource.setEncounter(new ResourceReferenceDt(encounterEntry.getFullUrl()));</span>
<span class="fc" id="L990">    ca.uhn.fhir.model.dstu2.resource.Encounter encounter =</span>
<span class="fc" id="L991">        (ca.uhn.fhir.model.dstu2.resource.Encounter) encounterEntry.getResource();</span>
<span class="fc" id="L992">    medicationResource.setPrescriber(encounter.getParticipantFirstRep().getIndividual());</span>
<span class="fc" id="L993">    medicationResource.setMedication(mapCodeToCodeableConcept(medication.codes.get(0), RXNORM_URI));</span>

<span class="fc" id="L995">    medicationResource.setDateWritten(new DateTimeDt(new Date(medication.start)));</span>
<span class="fc bfc" id="L996" title="All 2 branches covered.">    if (medication.stop != 0L) {</span>
<span class="fc" id="L997">      medicationResource.setStatus(MedicationOrderStatusEnum.STOPPED);</span>
    } else {
<span class="fc" id="L999">      medicationResource.setStatus(MedicationOrderStatusEnum.ACTIVE);</span>
    }

<span class="fc bfc" id="L1002" title="All 2 branches covered.">    if (!medication.reasons.isEmpty()) {</span>
      // Only one element in list
<span class="fc" id="L1004">      Code reason = medication.reasons.get(0);</span>
<span class="fc bfc" id="L1005" title="All 2 branches covered.">      for (Entry entry : bundle.getEntry()) {</span>
<span class="fc bfc" id="L1006" title="All 2 branches covered.">        if (entry.getResource().getResourceName().equals(&quot;Condition&quot;)) {</span>
<span class="fc" id="L1007">          Condition condition = (Condition) entry.getResource();</span>
          // Only one element in list
<span class="fc" id="L1009">          CodingDt coding = condition.getCode().getCoding().get(0);</span>
<span class="fc bfc" id="L1010" title="All 2 branches covered.">          if (reason.code.equals(coding.getCode())) {</span>
<span class="fc" id="L1011">            medicationResource.setReason(new ResourceReferenceDt(entry.getFullUrl()));</span>
          }
        }
<span class="fc" id="L1014">      }</span>
    }

<span class="fc bfc" id="L1017" title="All 2 branches covered.">    if (medication.prescriptionDetails != null) {</span>
<span class="fc" id="L1018">      JsonObject rxInfo = medication.prescriptionDetails;</span>
<span class="fc" id="L1019">      DosageInstruction dosage = new DosageInstruction();</span>

      // as_needed is true if present
<span class="fc" id="L1022">      dosage.setAsNeeded(new BooleanDt(rxInfo.has(&quot;as_needed&quot;)));</span>

      // as_needed is true if present
<span class="pc bpc" id="L1025" title="1 of 4 branches missed.">      if ((rxInfo.has(&quot;dosage&quot;)) &amp;&amp; (!rxInfo.has(&quot;as_needed&quot;))) {</span>
<span class="fc" id="L1026">        TimingDt timing = new TimingDt();</span>
<span class="fc" id="L1027">        Repeat timingRepeatComponent = new Repeat();</span>
<span class="fc" id="L1028">        timingRepeatComponent</span>
<span class="fc" id="L1029">            .setFrequency(rxInfo.get(&quot;dosage&quot;).getAsJsonObject().get(&quot;frequency&quot;).getAsInt());</span>
<span class="fc" id="L1030">        timingRepeatComponent</span>
<span class="fc" id="L1031">            .setPeriod(rxInfo.get(&quot;dosage&quot;).getAsJsonObject().get(&quot;period&quot;).getAsDouble());</span>
<span class="fc" id="L1032">        timingRepeatComponent.setPeriodUnits(</span>
<span class="fc" id="L1033">            convertUcumCode(rxInfo.get(&quot;dosage&quot;).getAsJsonObject().get(&quot;unit&quot;).getAsString()));</span>
<span class="fc" id="L1034">        timing.setRepeat(timingRepeatComponent);</span>
<span class="fc" id="L1035">        dosage.setTiming(timing);</span>

<span class="fc" id="L1037">        QuantityDt dose = new SimpleQuantityDt()</span>
<span class="fc" id="L1038">            .setValue(rxInfo.get(&quot;dosage&quot;).getAsJsonObject().get(&quot;amount&quot;).getAsDouble());</span>
<span class="fc" id="L1039">        dosage.setDose(dose);</span>

<span class="fc bfc" id="L1041" title="All 2 branches covered.">        if (rxInfo.has(&quot;instructions&quot;)) {</span>
<span class="fc bfc" id="L1042" title="All 2 branches covered.">          for (JsonElement instructionElement : rxInfo.get(&quot;instructions&quot;).getAsJsonArray()) {</span>
<span class="fc" id="L1043">            JsonObject instruction = instructionElement.getAsJsonObject();</span>
<span class="fc" id="L1044">            Code instructionCode = new Code(SNOMED_URI, instruction.get(&quot;code&quot;).getAsString(),</span>
<span class="fc" id="L1045">                instruction.get(&quot;display&quot;).getAsString());</span>

<span class="fc" id="L1047">            dosage.setAdditionalInstructions(mapCodeToCodeableConcept(instructionCode, SNOMED_URI));</span>
<span class="fc" id="L1048">          }</span>
        }
      }

<span class="fc" id="L1052">      List&lt;DosageInstruction&gt; dosageInstruction = new ArrayList&lt;DosageInstruction&gt;();</span>
<span class="fc" id="L1053">      dosageInstruction.add(dosage);</span>
<span class="fc" id="L1054">      medicationResource.setDosageInstruction(dosageInstruction);</span>
    }

<span class="fc" id="L1057">    Entry medicationEntry = newEntry(bundle, medicationResource);</span>
    // create new claim for medication
<span class="fc" id="L1059">    medicationClaim(personEntry, bundle, encounterEntry, medication.claim, medicationEntry);</span>

<span class="fc" id="L1061">    return medicationEntry;</span>
  }

  /**
   * Map the given Report to a FHIR DiagnosticReport resource, and add it to the given Bundle.
   *
   * @param personEntry
   *          The Entry for the Person
   * @param bundle
   *          Bundle to add the Report to
   * @param encounterEntry
   *          Current Encounter entry
   * @param report
   *          The Report
   * @return The added Entry
   */
  private static Entry report(Entry personEntry, Bundle bundle, Entry encounterEntry,
      Report report) {
<span class="fc" id="L1079">    DiagnosticReport reportResource = new DiagnosticReport();</span>
<span class="fc" id="L1080">    reportResource.setStatus(DiagnosticReportStatusEnum.FINAL);</span>
    /*
     * Technically, the CodeableConcept system should be &quot;http://hl7.org/fhir/v2/0074&quot;
     * But the official Argonauts profiles incorrectly list the category pattern as
     * the ValueSet (which contains the above system) as
     * &quot;http://hl7.org/fhir/ValueSet/diagnostic-service-sections&quot;, so we repeat the
     * error here.
     */
<span class="fc" id="L1088">    CodeableConceptDt category =</span>
        new CodeableConceptDt(&quot;http://hl7.org/fhir/ValueSet/diagnostic-service-sections&quot;, &quot;LAB&quot;);
<span class="fc" id="L1090">    reportResource.setCategory(category);</span>
<span class="fc" id="L1091">    reportResource.setCode(mapCodeToCodeableConcept(report.codes.get(0), LOINC_URI));</span>
<span class="fc" id="L1092">    reportResource.setSubject(new ResourceReferenceDt(personEntry.getFullUrl()));</span>
<span class="fc" id="L1093">    reportResource.setEncounter(new ResourceReferenceDt(encounterEntry.getFullUrl()));</span>
<span class="fc" id="L1094">    reportResource.setEffective(convertFhirDateTime(report.start, true));</span>
<span class="fc" id="L1095">    reportResource.setIssued(new InstantDt(new Date(report.start)));</span>

<span class="fc" id="L1097">    ca.uhn.fhir.model.dstu2.resource.Encounter encounter =</span>
<span class="fc" id="L1098">        (ca.uhn.fhir.model.dstu2.resource.Encounter) encounterEntry.getResource();</span>
<span class="fc" id="L1099">    reportResource.setPerformer(encounter.getServiceProvider());</span>

<span class="fc bfc" id="L1101" title="All 2 branches covered.">    for (Observation observation : report.observations) {</span>
<span class="fc" id="L1102">      ResourceReferenceDt reference = new ResourceReferenceDt(observation.fullUrl);</span>
<span class="fc" id="L1103">      reference.setDisplay(observation.codes.get(0).display);</span>
<span class="fc" id="L1104">      List&lt;ResourceReferenceDt&gt; result = new ArrayList&lt;ResourceReferenceDt&gt;();</span>
<span class="fc" id="L1105">      result.add(reference);</span>
<span class="fc" id="L1106">      reportResource.setResult(result);</span>
<span class="fc" id="L1107">    }</span>

<span class="fc" id="L1109">    return newEntry(bundle, reportResource);</span>
  }

  /**
   * Map the given CarePlan to a FHIR CarePlan resource, and add it to the given Bundle.
   *
   * @param personEntry
   *          The Entry for the Person
   * @param bundle
   *          Bundle to add the CarePlan to
   * @param encounterEntry
   *          Current Encounter entry
   * @param carePlan
   *          The CarePlan to map to FHIR and add to the bundle
   * @return The added Entry
   */
  private static Entry careplan(Entry personEntry, Bundle bundle, Entry encounterEntry,
      CarePlan carePlan) {
<span class="fc" id="L1127">    ca.uhn.fhir.model.dstu2.resource.CarePlan careplanResource =</span>
        new ca.uhn.fhir.model.dstu2.resource.CarePlan();
<span class="fc" id="L1129">    careplanResource.setSubject(new ResourceReferenceDt(personEntry.getFullUrl()));</span>
<span class="fc" id="L1130">    careplanResource.setContext(new ResourceReferenceDt(encounterEntry.getFullUrl()));</span>

<span class="fc" id="L1132">    Code code = carePlan.codes.get(0);</span>
<span class="fc" id="L1133">    careplanResource.addCategory(mapCodeToCodeableConcept(code, SNOMED_URI));</span>

<span class="fc" id="L1135">    NarrativeDt narrative = new NarrativeDt();</span>
<span class="fc" id="L1136">    narrative.setStatus(NarrativeStatusEnum.GENERATED);</span>
<span class="fc" id="L1137">    narrative.setDiv(code.display);</span>
<span class="fc" id="L1138">    careplanResource.setText(narrative);</span>

    CarePlanActivityStatusEnum activityStatus;
    GoalStatusEnum goalStatus;

<span class="fc" id="L1143">    PeriodDt period = new PeriodDt().setStart(new DateTimeDt(new Date(carePlan.start)));</span>
<span class="fc" id="L1144">    careplanResource.setPeriod(period);</span>
<span class="fc bfc" id="L1145" title="All 2 branches covered.">    if (carePlan.stop != 0L) {</span>
<span class="fc" id="L1146">      period.setEnd(new DateTimeDt(new Date(carePlan.stop)));</span>
<span class="fc" id="L1147">      careplanResource.setStatus(CarePlanStatusEnum.COMPLETED);</span>
<span class="fc" id="L1148">      activityStatus = CarePlanActivityStatusEnum.COMPLETED;</span>
<span class="fc" id="L1149">      goalStatus = GoalStatusEnum.ACHIEVED;</span>
    } else {
<span class="fc" id="L1151">      careplanResource.setStatus(CarePlanStatusEnum.ACTIVE);</span>
<span class="fc" id="L1152">      activityStatus = CarePlanActivityStatusEnum.IN_PROGRESS;</span>
<span class="fc" id="L1153">      goalStatus = GoalStatusEnum.IN_PROGRESS;</span>
    }

<span class="pc bpc" id="L1156" title="1 of 2 branches missed.">    if (!carePlan.activities.isEmpty()) {</span>
<span class="fc bfc" id="L1157" title="All 2 branches covered.">      for (Code activity : carePlan.activities) {</span>
<span class="fc" id="L1158">        Activity activityComponent = new Activity();</span>
<span class="fc" id="L1159">        ActivityDetail activityDetailComponent = new ActivityDetail();</span>

<span class="fc" id="L1161">        activityDetailComponent.setStatus(activityStatus);</span>

<span class="fc" id="L1163">        activityDetailComponent.setCode(mapCodeToCodeableConcept(activity, SNOMED_URI));</span>
<span class="fc" id="L1164">        activityDetailComponent.setProhibited(new BooleanDt(false));</span>
<span class="fc" id="L1165">        activityComponent.setDetail(activityDetailComponent);</span>

<span class="fc" id="L1167">        careplanResource.addActivity(activityComponent);</span>
<span class="fc" id="L1168">      }</span>
    }

<span class="fc bfc" id="L1171" title="All 2 branches covered.">    if (!carePlan.reasons.isEmpty()) {</span>
      // Only one element in list
<span class="fc" id="L1173">      Code reason = carePlan.reasons.get(0);</span>
<span class="fc bfc" id="L1174" title="All 2 branches covered.">      for (Entry entry : bundle.getEntry()) {</span>
<span class="fc bfc" id="L1175" title="All 2 branches covered.">        if (entry.getResource().getResourceName().equals(&quot;Condition&quot;)) {</span>
<span class="fc" id="L1176">          Condition condition = (Condition) entry.getResource();</span>
          // Only one element in list
<span class="fc" id="L1178">          CodingDt coding = condition.getCode().getCoding().get(0);</span>
<span class="fc bfc" id="L1179" title="All 2 branches covered.">          if (reason.code.equals(coding.getCode())) {</span>
<span class="fc" id="L1180">            careplanResource.addAddresses().setReference(entry.getFullUrl());</span>
          }
        }
<span class="fc" id="L1183">      }</span>
    }

<span class="fc bfc" id="L1186" title="All 2 branches covered.">    for (JsonObject goal : carePlan.goals) {</span>
<span class="fc" id="L1187">      Entry goalEntry = caregoal(bundle, goalStatus, goal);</span>
<span class="fc" id="L1188">      careplanResource.addGoal().setReference(goalEntry.getFullUrl());</span>
<span class="fc" id="L1189">    }</span>

<span class="fc" id="L1191">    return newEntry(bundle, careplanResource);</span>
  }

  /**
   * Map the given ImagingStudy to a FHIR ImagingStudy resource, and add it to the given Bundle.
   *
   * @param personEntry
   *          The Entry for the Person
   * @param bundle
   *          Bundle to add the ImagingStudy to
   * @param encounterEntry
   *          Current Encounter entry
   * @param imagingStudy
   *          The ImagingStudy to map to FHIR and add to the bundle
   * @return The added Entry
   */
  private static Entry imagingStudy(Entry personEntry, Bundle bundle, Entry encounterEntry,
      ImagingStudy imagingStudy) {
<span class="fc" id="L1209">    ca.uhn.fhir.model.dstu2.resource.ImagingStudy imagingStudyResource =</span>
        new ca.uhn.fhir.model.dstu2.resource.ImagingStudy();

<span class="fc" id="L1212">    OidDt studyUid = new OidDt();</span>
<span class="fc" id="L1213">    studyUid.setValue(&quot;urn:oid:&quot; + imagingStudy.dicomUid);</span>
<span class="fc" id="L1214">    imagingStudyResource.setUid(studyUid);</span>

<span class="fc" id="L1216">    imagingStudyResource.setPatient(new ResourceReferenceDt(personEntry.getFullUrl()));</span>

<span class="fc" id="L1218">    DateTimeDt startDate = new DateTimeDt(new Date(imagingStudy.start));</span>
<span class="fc" id="L1219">    imagingStudyResource.setStarted(startDate);</span>

    // Convert the series into their FHIR equivalents
<span class="fc" id="L1222">    int numberOfSeries = imagingStudy.series.size();</span>
<span class="fc" id="L1223">    imagingStudyResource.setNumberOfSeries(new UnsignedIntDt(numberOfSeries));</span>

<span class="fc" id="L1225">    List&lt;Series&gt; seriesResourceList = new ArrayList&lt;Series&gt;();</span>

<span class="fc" id="L1227">    int totalNumberOfInstances = 0;</span>
<span class="fc" id="L1228">    int seriesNo = 1;</span>

<span class="fc bfc" id="L1230" title="All 2 branches covered.">    for (ImagingStudy.Series series : imagingStudy.series) {</span>
<span class="fc" id="L1231">      Series seriesResource = new Series();</span>

<span class="fc" id="L1233">      OidDt seriesUid = new OidDt();</span>
<span class="fc" id="L1234">      seriesUid.setValue(&quot;urn:oid:&quot; + series.dicomUid);</span>
<span class="fc" id="L1235">      seriesResource.setUid(seriesUid);</span>

<span class="fc" id="L1237">      seriesResource.setNumber(new UnsignedIntDt(seriesNo));</span>
<span class="fc" id="L1238">      seriesResource.setStarted(startDate);</span>
<span class="fc" id="L1239">      seriesResource.setAvailability(InstanceAvailabilityEnum.UNAVAILABLE);</span>

<span class="fc" id="L1241">      CodeableConceptDt modalityConcept = mapCodeToCodeableConcept(series.modality, DICOM_DCM_URI);</span>
<span class="fc" id="L1242">      seriesResource.setModality(modalityConcept.getCoding().get(0));</span>

<span class="fc" id="L1244">      CodeableConceptDt bodySiteConcept = mapCodeToCodeableConcept(series.bodySite, SNOMED_URI);</span>
<span class="fc" id="L1245">      seriesResource.setBodySite(bodySiteConcept.getCoding().get(0));</span>

      // Convert the images in each series into their FHIR equivalents
<span class="fc" id="L1248">      int numberOfInstances = series.instances.size();</span>
<span class="fc" id="L1249">      seriesResource.setNumberOfInstances(new UnsignedIntDt(numberOfInstances));</span>
<span class="fc" id="L1250">      totalNumberOfInstances += numberOfInstances;</span>

<span class="fc" id="L1252">      List&lt;SeriesInstance&gt; instanceResourceList = new ArrayList&lt;SeriesInstance&gt;();</span>

<span class="fc" id="L1254">      int instanceNo = 1;</span>

<span class="fc bfc" id="L1256" title="All 2 branches covered.">      for (ImagingStudy.Instance instance : series.instances) {</span>
<span class="fc" id="L1257">        SeriesInstance instanceResource = new SeriesInstance();</span>

<span class="fc" id="L1259">        OidDt instanceUid = new OidDt();</span>
<span class="fc" id="L1260">        instanceUid.setValue(&quot;urn:oid:&quot; + instance.dicomUid);</span>
<span class="fc" id="L1261">        instanceResource.setUid(instanceUid);</span>

<span class="fc" id="L1263">        instanceResource.setTitle(instance.title);</span>

<span class="fc" id="L1265">        OidDt sopOid = new OidDt();</span>
<span class="fc" id="L1266">        sopOid.setValue(&quot;urn:oid:&quot; + instance.sopClass.code);</span>
<span class="fc" id="L1267">        instanceResource.setSopClass(sopOid);</span>

<span class="fc" id="L1269">        instanceResource.setNumber(new UnsignedIntDt(instanceNo));</span>

<span class="fc" id="L1271">        instanceResourceList.add(instanceResource);</span>
<span class="fc" id="L1272">        instanceNo += 1;</span>
<span class="fc" id="L1273">      }</span>

<span class="fc" id="L1275">      seriesResource.setInstance(instanceResourceList);</span>
<span class="fc" id="L1276">      seriesResourceList.add(seriesResource);</span>
<span class="fc" id="L1277">      seriesNo += 1;</span>
<span class="fc" id="L1278">    }</span>

<span class="fc" id="L1280">    imagingStudyResource.setSeries(seriesResourceList);</span>
<span class="fc" id="L1281">    imagingStudyResource.setNumberOfInstances(totalNumberOfInstances);</span>

<span class="fc" id="L1283">    return newEntry(bundle, imagingStudyResource);</span>
  }

  /**
   * Map the Provider into a FHIR Organization resource, and add it to the given Bundle.
   *
   * @param bundle
   *          The Bundle to add to
   * @param provider
   *          The Provider
   * @return The added Entry
   */
  protected static Entry provider(Bundle bundle, Provider provider) {
<span class="fc" id="L1296">    ca.uhn.fhir.model.dstu2.resource.Organization organizationResource =</span>
        new ca.uhn.fhir.model.dstu2.resource.Organization();

<span class="fc" id="L1299">    CodeableConceptDt organizationType = mapCodeToCodeableConcept(</span>
        new Code(&quot;http://hl7.org/fhir/ValueSet/organization-type&quot;, &quot;prov&quot;, &quot;Healthcare Provider&quot;),
        &quot;Healthcare Provider&quot;);

<span class="fc" id="L1303">    organizationResource.addIdentifier().setSystem(&quot;https://github.com/synthetichealth/synthea&quot;)</span>
<span class="fc" id="L1304">    .setValue((String) provider.getResourceID());</span>

<span class="fc" id="L1306">    organizationResource.setName(provider.name);</span>
<span class="fc" id="L1307">    organizationResource.setType(organizationType);</span>

<span class="fc" id="L1309">    AddressDt address = new AddressDt()</span>
<span class="fc" id="L1310">        .addLine(provider.address)</span>
<span class="fc" id="L1311">        .setCity(provider.city)</span>
<span class="fc" id="L1312">        .setPostalCode(provider.zip)</span>
<span class="fc" id="L1313">        .setState(provider.state);</span>
<span class="pc bpc" id="L1314" title="1 of 2 branches missed.">    if (COUNTRY_CODE != null) {</span>
<span class="fc" id="L1315">      address.setCountry(COUNTRY_CODE);</span>
    }
<span class="fc" id="L1317">    organizationResource.addAddress(address);</span>

<span class="pc bpc" id="L1319" title="2 of 4 branches missed.">    if (provider.phone != null &amp;&amp; !provider.phone.isEmpty()) {</span>
<span class="fc" id="L1320">      ContactPointDt contactPoint = new ContactPointDt()</span>
<span class="fc" id="L1321">          .setSystem(ContactPointSystemEnum.PHONE)</span>
<span class="fc" id="L1322">          .setValue(provider.phone);</span>
<span class="fc" id="L1323">      organizationResource.addTelecom(contactPoint);</span>
    }

<span class="fc" id="L1326">    return newEntry(bundle, organizationResource, provider.getResourceID());</span>
  }

  /**
   * Map the clinician into a FHIR Practitioner resource, and add it to the given Bundle.
   * @param bundle The Bundle to add to
   * @param clinician The clinician
   * @return The added Entry
   */
  protected static Entry practitioner(Bundle bundle, Clinician clinician) {
<span class="fc" id="L1336">    Practitioner practitionerResource = new Practitioner();</span>

<span class="fc" id="L1338">    practitionerResource.addIdentifier().setSystem(&quot;http://hl7.org/fhir/sid/us-npi&quot;)</span>
<span class="fc" id="L1339">    .setValue(&quot;&quot; + clinician.seed);</span>
<span class="fc" id="L1340">    practitionerResource.setActive(true);</span>
<span class="fc" id="L1341">    practitionerResource.getName().addFamily(</span>
<span class="fc" id="L1342">        (String) clinician.attributes.get(Clinician.LAST_NAME))</span>
<span class="fc" id="L1343">      .addGiven((String) clinician.attributes.get(Clinician.FIRST_NAME))</span>
<span class="fc" id="L1344">      .addPrefix((String) clinician.attributes.get(Clinician.NAME_PREFIX));</span>

<span class="fc" id="L1346">    AddressDt address = new AddressDt()</span>
<span class="fc" id="L1347">        .addLine((String) clinician.attributes.get(Clinician.ADDRESS))</span>
<span class="fc" id="L1348">        .setCity((String) clinician.attributes.get(Clinician.CITY))</span>
<span class="fc" id="L1349">        .setPostalCode((String) clinician.attributes.get(Clinician.ZIP))</span>
<span class="fc" id="L1350">        .setState((String) clinician.attributes.get(Clinician.STATE));</span>
<span class="pc bpc" id="L1351" title="1 of 2 branches missed.">    if (COUNTRY_CODE != null) {</span>
<span class="fc" id="L1352">      address.setCountry(COUNTRY_CODE);</span>
    }
<span class="fc" id="L1354">    practitionerResource.addAddress(address);</span>

<span class="fc bfc" id="L1356" title="All 2 branches covered.">    if (clinician.attributes.get(Person.GENDER).equals(&quot;M&quot;)) {</span>
<span class="fc" id="L1357">      practitionerResource.setGender(AdministrativeGenderEnum.MALE);</span>
<span class="pc bpc" id="L1358" title="1 of 2 branches missed.">    } else if (clinician.attributes.get(Person.GENDER).equals(&quot;F&quot;)) {</span>
<span class="fc" id="L1359">      practitionerResource.setGender(AdministrativeGenderEnum.FEMALE);</span>
    }

<span class="fc" id="L1362">    return newEntry(bundle, practitionerResource, clinician.getResourceID());</span>
  }

  /**
   * Map the JsonObject into a FHIR Goal resource, and add it to the given Bundle.
   * @param bundle The Bundle to add to
   * @param goalStatus The GoalStatus
   * @param goal The JsonObject
   * @return The added Entry
   */
  private static Entry caregoal(Bundle bundle, GoalStatusEnum goalStatus, JsonObject goal) {

<span class="fc" id="L1374">    ca.uhn.fhir.model.dstu2.resource.Goal goalResource =</span>
        new ca.uhn.fhir.model.dstu2.resource.Goal();
<span class="fc" id="L1376">    goalResource.setStatus(goalStatus);</span>

<span class="fc bfc" id="L1378" title="All 2 branches covered.">    if (goal.has(&quot;text&quot;)) {</span>
<span class="fc" id="L1379">      goalResource.setDescription(goal.get(&quot;text&quot;).getAsString());</span>
<span class="pc bpc" id="L1380" title="1 of 2 branches missed.">    } else if (goal.has(&quot;codes&quot;)) {</span>
<span class="nc" id="L1381">      JsonObject code = goal.get(&quot;codes&quot;).getAsJsonArray().get(0).getAsJsonObject();</span>

<span class="nc" id="L1383">      goalResource.setDescription(code.get(&quot;display&quot;).getAsString());</span>
<span class="pc bpc" id="L1384" title="1 of 2 branches missed.">    } else if (goal.has(&quot;observation&quot;)) {</span>
      // build up our own text from the observation condition, similar to the graphviz logic
<span class="fc" id="L1386">      JsonObject logic = goal.get(&quot;observation&quot;).getAsJsonObject();</span>

<span class="fc" id="L1388">      String[] text = {</span>
<span class="fc" id="L1389">          logic.get(&quot;codes&quot;).getAsJsonArray().get(0).getAsJsonObject().get(&quot;display&quot;).getAsString(),</span>
<span class="fc" id="L1390">          logic.get(&quot;operator&quot;).getAsString(), logic.get(&quot;value&quot;).getAsString() };</span>

<span class="fc" id="L1392">      goalResource.setDescription(String.join(&quot; &quot;, text));</span>
    }

<span class="pc bpc" id="L1395" title="1 of 2 branches missed.">    if (goal.has(&quot;addresses&quot;)) {</span>
<span class="fc bfc" id="L1396" title="All 2 branches covered.">      for (JsonElement reasonElement : goal.get(&quot;addresses&quot;).getAsJsonArray()) {</span>
<span class="pc bpc" id="L1397" title="1 of 2 branches missed.">        if (reasonElement instanceof JsonObject) {</span>
<span class="nc" id="L1398">          JsonObject reasonObject = reasonElement.getAsJsonObject();</span>
<span class="nc" id="L1399">          String reasonCode = reasonObject.get(&quot;codes&quot;).getAsJsonObject().get(&quot;SNOMED-CT&quot;)</span>
<span class="nc" id="L1400">              .getAsJsonArray().get(0).getAsString();</span>

<span class="nc bnc" id="L1402" title="All 2 branches missed.">          for (Entry entry : bundle.getEntry()) {</span>
<span class="nc bnc" id="L1403" title="All 2 branches missed.">            if (entry.getResource().getResourceName().equals(&quot;Condition&quot;)) {</span>
<span class="nc" id="L1404">              Condition condition = (Condition) entry.getResource();</span>
              // Only one element in list
<span class="nc" id="L1406">              CodingDt coding = condition.getCode().getCoding().get(0);</span>
<span class="nc bnc" id="L1407" title="All 2 branches missed.">              if (reasonCode.equals(coding.getCode())) {</span>
<span class="nc" id="L1408">                goalResource.addAddresses().setReference(entry.getFullUrl());</span>
              }
            }
<span class="nc" id="L1411">          }</span>
        }
<span class="fc" id="L1413">      }</span>
    }

<span class="fc" id="L1416">    return newEntry(bundle, goalResource);</span>
  }

  /**
   * Convert the unit into a UnitsOfTime.
   *
   * @param unit
   *          unit String
   * @return a UnitsOfTime representing the given unit
   */
  private static UnitsOfTimeEnum convertUcumCode(String unit) {
    // From: http://hl7.org/fhir/ValueSet/units-of-time
<span class="pc bpc" id="L1428" title="6 of 8 branches missed.">    switch (unit) {</span>
      case &quot;seconds&quot;:
<span class="nc" id="L1430">        return UnitsOfTimeEnum.S;</span>
      case &quot;minutes&quot;:
<span class="nc" id="L1432">        return UnitsOfTimeEnum.MIN;</span>
      case &quot;hours&quot;:
<span class="fc" id="L1434">        return UnitsOfTimeEnum.H;</span>
      case &quot;days&quot;:
<span class="fc" id="L1436">        return UnitsOfTimeEnum.D;</span>
      case &quot;weeks&quot;:
<span class="nc" id="L1438">        return UnitsOfTimeEnum.WK;</span>
      case &quot;months&quot;:
<span class="nc" id="L1440">        return UnitsOfTimeEnum.MO;</span>
      case &quot;years&quot;:
<span class="nc" id="L1442">        return UnitsOfTimeEnum.A;</span>
      default:
<span class="nc" id="L1444">        return null;</span>
    }
  }

  /**
   * Convert the timestamp into a FHIR DateType or DateTimeType.
   *
   * @param datetime
   *          Timestamp
   * @param time
   *          If true, return a DateTimeDt; if false, return a DateDt.
   * @return a DateDt or DateTimeDt representing the given timestamp
   */
  private static IDatatype convertFhirDateTime(long datetime, boolean time) {
<span class="fc" id="L1458">    Date date = new Date(datetime);</span>

<span class="pc bpc" id="L1460" title="1 of 2 branches missed.">    if (time) {</span>
<span class="fc" id="L1461">      return new DateTimeDt(date);</span>
    } else {
<span class="nc" id="L1463">      return new DateDt(date);</span>
    }
  }

  /**
   * Helper function to convert a Code into a CodeableConceptDt. Takes an optional system, which
   * replaces the Code.system in the resulting CodeableConceptDt if not null.
   *
   * @param from
   *          The Code to create a CodeableConcept from.
   * @param system
   *          The system identifier, such as a URI. Optional; may be null.
   * @return The converted CodeableConcept
   */
  private static CodeableConceptDt mapCodeToCodeableConcept(Code from, String system) {
<span class="fc" id="L1478">    CodeableConceptDt to = new CodeableConceptDt();</span>

<span class="pc bpc" id="L1480" title="1 of 2 branches missed.">    if (from.display != null) {</span>
<span class="fc" id="L1481">      to.setText(from.display);</span>
    }

<span class="fc" id="L1484">    CodingDt coding = new CodingDt();</span>
<span class="fc" id="L1485">    coding.setCode(from.code);</span>
<span class="fc" id="L1486">    coding.setDisplay(from.display);</span>
<span class="pc bpc" id="L1487" title="1 of 2 branches missed.">    if (system == null) {</span>
<span class="nc" id="L1488">      coding.setSystem(from.system);</span>
    } else {
<span class="fc" id="L1490">      coding.setSystem(system);</span>
    }

<span class="fc" id="L1493">    to.addCoding(coding);</span>

<span class="fc" id="L1495">    return to;</span>
  }

  /**
   * Helper function to create an Entry for the given Resource within the given Bundle. Sets the
   * resourceID to a random UUID, sets the entry's fullURL to that resourceID, and adds the entry to
   * the bundle.
   *
   * @param bundle The Bundle to add the Entry to
   * @param resource Resource the new Entry should contain
   * @return the created Entry
   */
  private static Entry newEntry(Bundle bundle, BaseResource resource) {
<span class="fc" id="L1508">    String resourceID = UUID.randomUUID().toString();</span>
<span class="fc" id="L1509">    return newEntry(bundle, resource, resourceID);</span>
  }

  /**
   * Helper function to create an Entry for the given Resource within the given Bundle. Sets the
   * resourceID to a random UUID, sets the entry's fullURL to that resourceID, and adds the entry to
   * the bundle.
   *
   * @param bundle The Bundle to add the Entry to
   * @param resource Resource the new Entry should contain
   * @param resourceID The resourceID to use.
   * @return the created Entry
   */
  private static Entry newEntry(Bundle bundle, BaseResource resource,
      String resourceID) {
<span class="fc" id="L1524">    Entry entry = bundle.addEntry();</span>

<span class="fc" id="L1526">    resource.setId(resourceID);</span>
<span class="fc" id="L1527">    entry.setFullUrl(&quot;urn:uuid:&quot; + resourceID);</span>
<span class="fc" id="L1528">    entry.setResource(resource);</span>

<span class="fc bfc" id="L1530" title="All 2 branches covered.">    if (TRANSACTION_BUNDLE) {</span>
<span class="fc" id="L1531">      EntryRequest request = entry.getRequest();</span>
<span class="fc" id="L1532">      request.setMethod(HTTPVerbEnum.POST);</span>
<span class="fc" id="L1533">      request.setUrl(resource.getResourceName());</span>
<span class="fc" id="L1534">      entry.setRequest(request);</span>
    }

<span class="fc" id="L1537">    return entry;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>