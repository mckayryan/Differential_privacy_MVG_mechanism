<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CDWExporter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">synthea</a> &gt; <a href="index.source.html" class="el_package">org.mitre.synthea.export</a> &gt; <span class="el_source">CDWExporter.java</span></div><h1>CDWExporter.java</h1><pre class="source lang-java linenums">package org.mitre.synthea.export;

import static org.mitre.synthea.export.ExportHelper.iso8601Timestamp;

import com.google.gson.JsonObject;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.nio.file.Path;
import java.util.HashMap;
import java.util.Locale;
import java.util.Map;
import java.util.Random;
import java.util.concurrent.atomic.AtomicInteger;

import org.apache.sis.geometry.DirectPosition2D;
import org.mitre.synthea.engine.Event;
import org.mitre.synthea.helpers.FactTable;
import org.mitre.synthea.helpers.Utilities;
import org.mitre.synthea.modules.DeathModule;
import org.mitre.synthea.modules.Immunizations;
import org.mitre.synthea.modules.LifecycleModule;
import org.mitre.synthea.world.agents.Person;
import org.mitre.synthea.world.agents.Provider;
import org.mitre.synthea.world.concepts.HealthRecord;
import org.mitre.synthea.world.concepts.HealthRecord.Code;
import org.mitre.synthea.world.concepts.HealthRecord.Encounter;
import org.mitre.synthea.world.concepts.HealthRecord.EncounterType;
import org.mitre.synthea.world.concepts.HealthRecord.Entry;
import org.mitre.synthea.world.concepts.HealthRecord.Immunization;
import org.mitre.synthea.world.concepts.HealthRecord.Medication;
import org.mitre.synthea.world.concepts.HealthRecord.Observation;
import org.mitre.synthea.world.concepts.HealthRecord.Procedure;
import org.mitre.synthea.world.concepts.HealthRecord.Report;
import org.mitre.synthea.world.geography.Location;

/**
 * This exporter attempts to export synthetic patient data into 
 * comma-separated value (CSV) files that align with the Veteran's 
 * Health Administration (VHA) Corporate Data Warehouse (CDW).
 * &lt;p/&gt;
 * https://www.data.va.gov/dataset/corporate-data-warehouse-cdw
 */
public class CDWExporter {
  /** Number of clinicians to generate. */
  private static final int CLINICIANS = 100;

  /** Temporary attribute to record clinician on a provider encounter. */
  private static final String CLINICIAN_SID = &quot;CLINICIAN_SID&quot;;

  /**
   * Table key sequence generators.
   */
  private Map&lt;FileWriter,AtomicInteger&gt; sids;
<span class="fc" id="L56">  private int sidStart = 1;</span>

<span class="fc" id="L58">  private FactTable sstaff = new FactTable();</span>
<span class="fc" id="L59">  private FactTable maritalStatus = new FactTable();</span>
<span class="fc" id="L60">  private FactTable sta3n = new FactTable();</span>
<span class="fc" id="L61">  private FactTable location = new FactTable();</span>
  // private FactTable appointmentStatus = new FactTable();
  // private FactTable appointmentType = new FactTable();
<span class="fc" id="L64">  private FactTable immunizationName = new FactTable();</span>
<span class="fc" id="L65">  private FactTable reaction = new FactTable();</span>
<span class="fc" id="L66">  private FactTable providerNarrative = new FactTable();</span>
<span class="fc" id="L67">  private FactTable localDrug = new FactTable();</span>
<span class="fc" id="L68">  private FactTable nationalDrug = new FactTable();</span>
<span class="fc" id="L69">  private FactTable dosageForm = new FactTable();</span>
<span class="fc" id="L70">  private FactTable pharmacyOrderableItem = new FactTable();</span>
<span class="fc" id="L71">  private FactTable orderableItem = new FactTable();</span>
<span class="fc" id="L72">  private FactTable orderStatus = new FactTable();</span>
<span class="fc" id="L73">  private FactTable vistaPackage = new FactTable();</span>
<span class="fc" id="L74">  private FactTable collectionsample = new FactTable();</span>
<span class="fc" id="L75">  private FactTable labchemtest = new FactTable();</span>
<span class="fc" id="L76">  private FactTable topography = new FactTable();</span>
<span class="fc" id="L77">  private FactTable institution = new FactTable();</span>
<span class="fc" id="L78">  private FactTable loinc = new FactTable();</span>
<span class="fc" id="L79">  private FactTable cpt = new FactTable();</span>
<span class="fc" id="L80">  private FactTable vitalType = new FactTable();</span>

  /**
   * Writers for patient data.
   */
  private FileWriter lookuppatient;
  private FileWriter spatient;
  private FileWriter spatientaddress;
  private FileWriter spatientphone;
  private FileWriter patientrace;
  private FileWriter patientethnicity;

  /**
   * Writers for encounter data.
   */
  private FileWriter consult;
  private FileWriter visit;
  private FileWriter appointment;
  private FileWriter inpatient;

  /**
   * Writers for immunization data.
   */
  private FileWriter immunization;

  /**
   * Writers for allergy data.
   */
  private FileWriter allergy;
  private FileWriter allergicreaction;
  private FileWriter allergycomment;

  /**
   * Writers for condition data.
   */
  private FileWriter problemlist;
  private FileWriter vdiagnosis;

  /**
   * Writers for medications data.
   */
  private FileWriter rxoutpatient;
  private FileWriter rxoutpatfill;
  private FileWriter nonvamed;
  private FileWriter cprsorder; // also required for labs
  private FileWriter ordereditem; // also required for labs

  /**
   * Writers for diagnostic report data (i.e. labs).
   */
  private FileWriter labchem;
  private FileWriter labpanel;
  private FileWriter patientlabchem;
  private FileWriter vprocedure;

  /**
   * Writers for procedure data.
   */
  private FileWriter surgeryProcedureDiagnosisCode;
  private FileWriter surgeryPRE;

  /**
   * Writers for vital sign Observation data.
   */
  private FileWriter vitalSign;

  /**
   * System-dependent string for a line break. (\n on Mac, *nix, \r\n on Windows)
   */
<span class="fc" id="L149">  private static final String NEWLINE = System.lineSeparator();</span>

  /**
   * Constructor for the CDWExporter -
   *  initialize the required files and associated writers.
   */
<span class="fc" id="L155">  private CDWExporter() {</span>
<span class="fc" id="L156">    sids = new HashMap&lt;FileWriter,AtomicInteger&gt;();</span>
    
    try {
<span class="fc" id="L159">      File output = Exporter.getOutputFolder(&quot;cdw&quot;, null);</span>
<span class="fc" id="L160">      output.mkdirs();</span>
<span class="fc" id="L161">      Path outputDirectory = output.toPath();</span>

      // Patient Data
<span class="fc" id="L164">      lookuppatient = openFileWriter(outputDirectory, &quot;lookuppatient.csv&quot;);</span>
<span class="fc" id="L165">      spatient = openFileWriter(outputDirectory, &quot;spatient.csv&quot;);</span>
<span class="fc" id="L166">      spatientaddress = openFileWriter(outputDirectory, &quot;spatientaddress.csv&quot;);</span>
<span class="fc" id="L167">      spatientphone = openFileWriter(outputDirectory, &quot;spatientphone.csv&quot;);</span>
<span class="fc" id="L168">      patientrace = openFileWriter(outputDirectory, &quot;patientrace.csv&quot;);</span>
<span class="fc" id="L169">      patientethnicity = openFileWriter(outputDirectory, &quot;patientethnicity.csv&quot;);</span>

      // Encounter Data
<span class="fc" id="L172">      consult = openFileWriter(outputDirectory, &quot;consult.csv&quot;);</span>
<span class="fc" id="L173">      visit = openFileWriter(outputDirectory, &quot;visit.csv&quot;);</span>
<span class="fc" id="L174">      appointment = openFileWriter(outputDirectory, &quot;appointment.csv&quot;);</span>
<span class="fc" id="L175">      inpatient = openFileWriter(outputDirectory, &quot;inpatient.csv&quot;);</span>

      // Immunization Data
<span class="fc" id="L178">      immunization = openFileWriter(outputDirectory, &quot;immunization.csv&quot;);</span>

      // Allergy Data
<span class="fc" id="L181">      allergy = openFileWriter(outputDirectory, &quot;allergy.csv&quot;);</span>
<span class="fc" id="L182">      allergicreaction = openFileWriter(outputDirectory, &quot;allergicreaction.csv&quot;);</span>
<span class="fc" id="L183">      allergycomment = openFileWriter(outputDirectory, &quot;allergycomment.csv&quot;);</span>

      // Condition Data
<span class="fc" id="L186">      problemlist = openFileWriter(outputDirectory, &quot;problemlist.csv&quot;);</span>
<span class="fc" id="L187">      vdiagnosis = openFileWriter(outputDirectory, &quot;vdiagnosis.csv&quot;);</span>

      // Medications Data
<span class="fc" id="L190">      rxoutpatient = openFileWriter(outputDirectory, &quot;rxoutpatient.csv&quot;);</span>
<span class="fc" id="L191">      rxoutpatfill = openFileWriter(outputDirectory, &quot;rxoutpatfill.csv&quot;);</span>
<span class="fc" id="L192">      nonvamed = openFileWriter(outputDirectory, &quot;nonvamed.csv&quot;);</span>
<span class="fc" id="L193">      cprsorder = openFileWriter(outputDirectory, &quot;cprsorder.csv&quot;);</span>
<span class="fc" id="L194">      ordereditem = openFileWriter(outputDirectory, &quot;ordereditem.csv&quot;);</span>

      // Diagnotic Report (i.e. Labs) Data
<span class="fc" id="L197">      labchem = openFileWriter(outputDirectory, &quot;labchem.csv&quot;);</span>
<span class="fc" id="L198">      labpanel = openFileWriter(outputDirectory, &quot;labpanel.csv&quot;);</span>
<span class="fc" id="L199">      patientlabchem = openFileWriter(outputDirectory, &quot;patientlabchem.csv&quot;);</span>
<span class="fc" id="L200">      vprocedure = openFileWriter(outputDirectory, &quot;vprocedure.csv&quot;);</span>

      // Procedure Data
<span class="fc" id="L203">      surgeryProcedureDiagnosisCode = openFileWriter(outputDirectory,</span>
          &quot;surgeryprocedurediagnosiscode.csv&quot;);
<span class="fc" id="L205">      surgeryPRE = openFileWriter(outputDirectory, &quot;surgerypre.csv&quot;);</span>

      // Vital Sign Observation Data
<span class="fc" id="L208">      vitalSign = openFileWriter(outputDirectory, &quot;vitalsign.csv&quot;);</span>

<span class="fc" id="L210">      writeCSVHeaders();</span>
<span class="nc" id="L211">    } catch (IOException e) {</span>
      // wrap the exception in a runtime exception.
      // the singleton pattern below doesn't work if the constructor can throw
      // and if these do throw ioexceptions there's nothing we can do anyway
<span class="nc" id="L215">      throw new RuntimeException(e);</span>
<span class="fc" id="L216">    }</span>
<span class="fc" id="L217">  }</span>

  private FileWriter openFileWriter(Path outputDirectory, String filename) throws IOException {
<span class="fc" id="L220">    File file = outputDirectory.resolve(filename).toFile();</span>
<span class="fc" id="L221">    return new FileWriter(file);</span>
  }

  /**
   * Write the headers to each of the CSV files.
   * @throws IOException if any IO error occurs
   */
  private void writeCSVHeaders() throws IOException {
    // Fact Tables
<span class="fc" id="L230">    sstaff.setHeader(&quot;StaffSID,StaffName&quot;);</span>
<span class="fc" id="L231">    maritalStatus.setHeader(&quot;MaritalStatusSID,MaritalStatusCode&quot;);</span>
<span class="fc" id="L232">    sta3n.setHeader(&quot;Sta3n,Sta3nName,TimeZone&quot;);</span>
<span class="fc" id="L233">    location.setHeader(&quot;LocationSID,LocationName&quot;);</span>
<span class="fc" id="L234">    immunizationName.setHeader(&quot;ImmunizationNameSID,ImmunizationName,CVXCode,MaxInSeries&quot;);</span>
<span class="fc" id="L235">    reaction.setHeader(&quot;ReactionSID,Reaction,VUID&quot;);</span>
<span class="fc" id="L236">    providerNarrative.setHeader(&quot;ProviderNarrativeSID,ProviderNarrative&quot;);</span>
<span class="fc" id="L237">    localDrug.setHeader(&quot;LocalDrugSID,LocalDrugIEN,Sta3n,LocalDrugNameWithDose,&quot;</span>
        + &quot;NationalDrugSID,NationalDrugNameWithDose,PharmacyOrderableItemSID&quot;);
<span class="fc" id="L239">    nationalDrug.setHeader(&quot;NationalDrugSID,DrugNameWithDose,DosageFormSID,&quot;</span>
        + &quot;InactivationDate,VUID&quot;);
<span class="fc" id="L241">    dosageForm.setHeader(&quot;DosageFormSID,DosageFormIEN,DosageForm&quot;);</span>
<span class="fc" id="L242">    dosageForm.addFact(&quot;1&quot;, &quot;1,Once per day.&quot;); // Default Dosage</span>
<span class="fc" id="L243">    pharmacyOrderableItem.setHeader(&quot;PharmacyOrderableItemSID,PharmacyOrderableItem,SupplyFlag&quot;);</span>
<span class="fc" id="L244">    orderableItem.setHeader(&quot;OrderableItemSID,OrderableItemName,IVBaseFlag,IVAdditiveFlag&quot;);</span>
<span class="fc" id="L245">    orderStatus.setHeader(&quot;OrderStatusSID,OrderStatus&quot;);</span>
<span class="fc" id="L246">    vistaPackage.setHeader(&quot;VistaPackageSID,VistaPackage&quot;);</span>
<span class="fc" id="L247">    collectionsample.setHeader(&quot;CollectionSampleSID,CollectionSample&quot;);</span>
<span class="fc" id="L248">    labchemtest.setHeader(&quot;LabChemTestSID,LabChemTestName,CollectionSampleSID&quot;);</span>
<span class="fc" id="L249">    topography.setHeader(&quot;TopographySID,Topography&quot;);</span>
<span class="fc" id="L250">    institution.setHeader(&quot;InstitutionSID,Sta3n,InstitutionName,InstitutionCode&quot;);</span>
<span class="fc" id="L251">    loinc.setHeader(&quot;LOINCSID,LOINC,Component&quot;);</span>
<span class="fc" id="L252">    cpt.setHeader(&quot;CPTSID,CPTCode,CPTName,CPTDescription&quot;);</span>
<span class="fc" id="L253">    vitalType.setHeader(&quot;VitalTypeSID,VitalType,VUID&quot;);</span>

    // Patient Tables
<span class="fc" id="L256">    lookuppatient.write(&quot;PatientSID,Sta3n,PatientIEN,PatientICN,PatientFullCN,&quot;</span>
        + &quot;PatientName,TestPatient&quot;);
<span class="fc" id="L258">    lookuppatient.write(NEWLINE);</span>
<span class="fc" id="L259">    spatient.write(&quot;PatientSID,PatientName,PatientLastName,PatientFirstName,PatientSSN,Age,&quot;</span>
        + &quot;BirthDateTime,DeceasedFlag,DeathDateTime,Gender,SelfIdentifiedGender,Religion,&quot;
        + &quot;MaritalStatus,MaritalStatusSID,PatientEnteredDateTime&quot;);
<span class="fc" id="L262">    spatient.write(NEWLINE);</span>
<span class="fc" id="L263">    spatientaddress.write(&quot;SPatientAddressSID,PatientSID,AddressType,NameOfContact,&quot;</span>
        + &quot;RelationshipToPatient,StreetAddress1,StreetAddress2,StreetAddress3,&quot;
        + &quot;City,State,Zip,PostalCode,Country,GISMatchScore,GISStreetSide,&quot;
        + &quot;GISPatientAddressLongitude,GISPatientAddressLatitude,GISFIPSCode&quot;);
<span class="fc" id="L267">    spatientaddress.write(NEWLINE);</span>
<span class="fc" id="L268">    spatientphone.write(&quot;SPatientPhoneSID,PatientSID,PatientContactType,NameOfContact,&quot;</span>
        + &quot;RelationshipToPatient,PhoneNumber,WorkPhoneNumber,EmailAddress&quot;);
<span class="fc" id="L270">    spatientphone.write(NEWLINE);</span>
<span class="fc" id="L271">    patientrace.write(&quot;PatientRaceSID,PatientSID,Race&quot;);</span>
<span class="fc" id="L272">    patientrace.write(NEWLINE);</span>
<span class="fc" id="L273">    patientethnicity.write(&quot;PatientEthnicitySID,PatientSID,Ethnicity&quot;);</span>
<span class="fc" id="L274">    patientethnicity.write(NEWLINE);</span>

    // Encounter Tables
<span class="fc" id="L277">    consult.write(&quot;ConsultSID,ToRequestServiceSID&quot;);</span>
<span class="fc" id="L278">    consult.write(NEWLINE);</span>
<span class="fc" id="L279">    visit.write(&quot;VisitSID,VisitDateTime,CreatedByStaffSID,LocationSID,PatientSID&quot;);</span>
<span class="fc" id="L280">    visit.write(NEWLINE);</span>
<span class="fc" id="L281">    appointment.write(&quot;AppointmentSID,Sta3n,PatientSID,AppointmentDateTime,AppointmentMadeDate,&quot;</span>
        + &quot;AppointmentTypeSID,AppointmentStatus,VisitSID,LocationSID,PurposeOfVisit,&quot;
        + &quot;SchedulingRequestType,FollowUpVisitFlag,LengthOfAppointment,ConsultSID,&quot;
        + &quot;CheckInDateTime,CheckOutDateTime&quot;);
<span class="fc" id="L285">    appointment.write(NEWLINE);</span>
<span class="fc" id="L286">    inpatient.write(&quot;InpatientSID,PatientSID,AdmitDateTime&quot;);</span>
<span class="fc" id="L287">    inpatient.write(NEWLINE);</span>

    // Immunization Table
<span class="fc" id="L290">    immunization.write(&quot;ImmunizationSID,ImmunizationIEN,Sta3n,PatientSID,ImmunizationNameSID,&quot;</span>
        + &quot;Series,Reaction,VisitDateTime,ImmunizationDateTime,OrderingStaffSID,ImmunizingStaffSID,&quot;
        + &quot;VisitSID,ImmunizationComments,ImmunizationRemarks&quot;);
<span class="fc" id="L293">    immunization.write(NEWLINE);</span>

    // Allergy Tables
<span class="fc" id="L296">    allergy.write(&quot;AllergySID,AllergyIEN,Sta3n,PatientSID,AllergyType,AllergicReactant,&quot;</span>
        + &quot;LocalDrugSID,DrugNameWithoutDoseSID,DrugClassSID,ReactantSID,DrugIngredientSID,&quot;
        + &quot;OriginationDateTime,OriginatingStaffSID,ObservedHistorical,Mechanism,VerifiedFlag,&quot;
        + &quot;VerificationDateTime,VerifyingStaffSID,EnteredInErrorFlag&quot;);
<span class="fc" id="L300">    allergy.write(NEWLINE);</span>
<span class="fc" id="L301">    allergicreaction.write(&quot;AllergicReactionSID,AllergySID,AllergyIEN,Sta3n,ReactionSID&quot;);</span>
<span class="fc" id="L302">    allergicreaction.write(NEWLINE);</span>
<span class="fc" id="L303">    allergycomment.write(&quot;AllergyCommentSID,AllergySID,AllergyIEN,Sta3n,PatientSID,&quot;</span>
        + &quot;OriginationDateTime,EnteringStaffSID,AllergyComment,CommentEnteredDateTime&quot;);
<span class="fc" id="L305">    allergycomment.write(NEWLINE);</span>

    // Condition Tables
<span class="fc" id="L308">    problemlist.write(&quot;ProblemListSID,Sta3n,ICD9SID,ICD10SID,PatientSID,ProviderNarrativeSID,&quot;</span>
        + &quot;EnteredDateTime,OnsetDateTime,ProblemListCondition,RecordingProviderSID,&quot;
        + &quot;ResolvedDateTime,SNOMEDCTConceptCode&quot;);
<span class="fc" id="L311">    problemlist.write(NEWLINE);</span>
<span class="fc" id="L312">    vdiagnosis.write(&quot;VDiagnosisSID,Sta3n,ICD9SID,ICD10SID,PatientSID,VisitSID,&quot;</span>
        + &quot;VisitDateTime,VDiagnosisDateTime,ProviderNarrativeSID,ProblemListSID,&quot;
        + &quot;OrderingProviderSID,EncounterProviderSID&quot;);
<span class="fc" id="L315">    vdiagnosis.write(NEWLINE);</span>

    // Medications Tables
<span class="fc" id="L318">    rxoutpatient.write(&quot;RxOutpatSID,Sta3n,RxNumber,IssueDate,CancelDate,FinishingDateTime,&quot;</span>
        + &quot;PatientSID,ProviderSID,EnteredByStaffSID,LocalDrugSID,NationalDrugSID,&quot;
        + &quot;PharmacyOrderableItemSID,MaxRefills,RxStatus,OrderedQuantity&quot;);
<span class="fc" id="L321">    rxoutpatient.write(NEWLINE);</span>
<span class="fc" id="L322">    rxoutpatfill.write(&quot;RxOutpatFillSID,RxOutpatSID,Qty,DaysSupply&quot;);</span>
<span class="fc" id="L323">    rxoutpatfill.write(NEWLINE);</span>
<span class="fc" id="L324">    nonvamed.write(&quot;NonVAMedSID,PatientSID,NonVAMedIEN,Sta3n,LocalDrugSID,Dosage,&quot;</span>
        + &quot;MedicationRoute,Schedule,NonVAMedStatus,CPRSOrderSID,StartDateTime,&quot;
        + &quot;DocumentedDateTime,NonVAMedComments&quot;);
<span class="fc" id="L327">    nonvamed.write(NEWLINE);</span>
<span class="fc" id="L328">    cprsorder.write(&quot;CPRSOrderID,Sta3n,PatientSID,OrderStaffSID,EnteredByStaffSID,&quot;</span>
        + &quot;EnteredDateTime,OrderStatusSID,VistaPackageSID,OrderStartDateTime,OrderStopDateTime,&quot;
        + &quot;PackageReference&quot;);
<span class="fc" id="L331">    cprsorder.write(NEWLINE);</span>
<span class="fc" id="L332">    ordereditem.write(&quot;OrderedItemSID,CPRSOrderSID,OrderableItemSID&quot;);</span>
<span class="fc" id="L333">    ordereditem.write(NEWLINE);</span>

    // Diagnostic Report Tables
<span class="fc" id="L336">    labchem.write(&quot;LabChemSID,Sta3n,LabPanelSID,LabChemTestSID,PatientSID,StaffSID,&quot;</span>
        + &quot;LabChemSpecimenDateTime,LabChemResultValue,LOINCSID,Units,Abnormal,RefHigh,RefLow&quot;);
<span class="fc" id="L338">    labchem.write(NEWLINE);</span>
<span class="fc" id="L339">    labpanel.write(&quot;LabPanelSID,LabPanelIEN,PatientSID&quot;);</span>
<span class="fc" id="L340">    labpanel.write(NEWLINE);</span>
<span class="fc" id="L341">    patientlabchem.write(&quot;LabChemSID,Sta3n,LabPanelSID,PatientSID,LabChemSpecimenDateTime,&quot;</span>
        + &quot;LabChemCompleteDateTime,TopographySID,AccessionInstitutionSID&quot;);
<span class="fc" id="L343">    patientlabchem.write(NEWLINE);</span>
<span class="fc" id="L344">    vprocedure.write(&quot;VProcedureSID,PatientSID,VisitSID,CPRSOrderSID&quot;);</span>
<span class="fc" id="L345">    vprocedure.write(NEWLINE);</span>

    // Procedure Tables
<span class="fc" id="L348">    surgeryProcedureDiagnosisCode.write(&quot;SurgeryProcedureDiagnosisCodeSID,SurgerySID,Sta3n,&quot;</span>
        + &quot;PrincipalCPTSID,PatientSID,SurgeryDateTime,PrincipalPostOpICD9SID,&quot;
        + &quot;PrincipalPostOpICD10SID,CodingCompleteFlag&quot;);
<span class="fc" id="L351">    surgeryProcedureDiagnosisCode.write(NEWLINE);</span>
<span class="fc" id="L352">    surgeryPRE.write(&quot;SurgerySID,VisitSID,NonORLocationSID,SurgeryCancelReasonSID,CPRSOrderSID&quot;);</span>
<span class="fc" id="L353">    surgeryPRE.write(NEWLINE);</span>

    // Vital Sign Observation Tables
<span class="fc" id="L356">    vitalSign.write(&quot;VitalSignSID,Sta3n,VitalSignTakenDateTime,PatientSID,VitalTypeSID,VitalResult,&quot;</span>
        + &quot;Systolic,Diastolic,SupplementalO2,LocationSID,StaffSID,EnteredInErrorFlag&quot;);
<span class="fc" id="L358">    vitalSign.write(NEWLINE);</span>
<span class="fc" id="L359">  }</span>

  /**
   * Generate a list of practicing Clinicians.
   * This is temporary until Provider organizations have associated
   * Clinician agents.
   */
  private void generateClinicians() {
<span class="fc" id="L367">    Random random = new Random(999L);</span>
<span class="fc bfc" id="L368" title="All 2 branches covered.">    for (int i = 0; i &lt; CLINICIANS; i++) {</span>
<span class="fc" id="L369">      Person clinician = new Person(random.nextLong());</span>
<span class="fc bfc" id="L370" title="All 2 branches covered.">      if (random.nextBoolean()) {</span>
<span class="fc" id="L371">        clinician.attributes.put(Person.GENDER, &quot;M&quot;);</span>
      } else {
<span class="fc" id="L373">        clinician.attributes.put(Person.GENDER, &quot;F&quot;);</span>
      }
<span class="fc" id="L375">      clinician.attributes.put(Person.RACE, &quot;unknown&quot;);</span>
<span class="fc" id="L376">      clinician.attributes.put(Person.ETHNICITY, &quot;unknown&quot;);</span>
<span class="fc" id="L377">      clinician.attributes.put(Person.FIRST_LANGUAGE, &quot;English&quot;);</span>
<span class="fc" id="L378">      LifecycleModule.birth(clinician, 0L);</span>
<span class="fc" id="L379">      String name = &quot;Dr. &quot; + clinician.attributes.get(Person.FIRST_NAME);</span>
<span class="fc" id="L380">      name += &quot; &quot; + clinician.attributes.get(Person.LAST_NAME);</span>
<span class="fc" id="L381">      sstaff.addFact(&quot;&quot; + i, clean(name));</span>
    }
<span class="fc" id="L383">  }</span>

  /**
   *  Thread safe singleton pattern adopted from
   *  https://stackoverflow.com/questions/7048198/thread-safe-singletons-in-java
   */
  private static class SingletonHolder {
    /**
     * Singleton instance of the CDWExporter.
     */
<span class="fc" id="L393">    private static final CDWExporter instance = new CDWExporter();</span>
  }

  /**
   * Get the current instance of the CDWExporter.
   * @return the current instance of the CDWExporter.
   */
  public static CDWExporter getInstance() {
<span class="fc" id="L401">    return SingletonHolder.instance;</span>
  }

  /**
   * Set the sequence generator key starting values.
   * Useful to ensure states do not generate
   * overlapping or colliding values.
   * @param id The start of the sequence generators.
   */
  public void setKeyStart(int id) {
<span class="fc" id="L411">    sidStart = id;</span>

    // Dim tables have smaller key ranges: only a 2 byte integer -- max of 32K
<span class="fc" id="L414">    id = (id / 2500); // this gives a range of 400 entries per state without collisions.</span>
<span class="pc bpc" id="L415" title="1 of 2 branches missed.">    if (id == 0) {</span>
      // We don't want to have any keys with zero, because certain queries ignore them.
<span class="nc" id="L417">      id = 1;</span>
    }

<span class="fc" id="L420">    sstaff.setNextId(id);</span>
<span class="fc" id="L421">    generateClinicians();</span>
<span class="fc" id="L422">    maritalStatus.setNextId(id);</span>
<span class="fc" id="L423">    sta3n.setNextId(id);</span>
<span class="fc" id="L424">    location.setNextId(id);</span>
    // appointmentStatus.setNextId(id);
    // appointmentType.setNextId(id);
<span class="fc" id="L427">    immunizationName.setNextId(id);</span>
<span class="fc" id="L428">    reaction.setNextId(id);</span>
<span class="fc" id="L429">    providerNarrative.setNextId(id);</span>
<span class="fc" id="L430">    localDrug.setNextId(id);</span>
<span class="fc" id="L431">    nationalDrug.setNextId(id);</span>
<span class="fc" id="L432">    dosageForm.setNextId(id);</span>
<span class="fc" id="L433">    pharmacyOrderableItem.setNextId(id);</span>
<span class="fc" id="L434">    orderableItem.setNextId(id);</span>
<span class="fc" id="L435">    orderStatus.setNextId(id);</span>
<span class="fc" id="L436">    vistaPackage.setNextId(id);</span>
<span class="fc" id="L437">    collectionsample.setNextId(id);</span>
<span class="fc" id="L438">    labchemtest.setNextId(id);</span>
<span class="fc" id="L439">    topography.setNextId(id);</span>
<span class="fc" id="L440">    institution.setNextId(id);</span>
<span class="fc" id="L441">    loinc.setNextId(id);</span>
<span class="fc" id="L442">    cpt.setNextId(id);</span>
<span class="fc" id="L443">    vitalType.setNextId(id);</span>
<span class="fc" id="L444">  }</span>

  /**
   * Add a single Person's health record info to the CSV records.
   * @param person Person to write record data for
   * @param time Time the simulation ended
   * @throws IOException if any IO error occurs
   */
  public void export(Person person, long time) throws IOException {
    // Ignore civilians, only consider the veteran population.
<span class="fc bfc" id="L454" title="All 2 branches covered.">    if (!person.attributes.containsKey(&quot;veteran&quot;)) {</span>
<span class="fc" id="L455">      return;</span>
    }
<span class="fc" id="L457">    int primarySta3n = -1;</span>
<span class="fc" id="L458">    Provider provider = person.getProvider(EncounterType.AMBULATORY, time);</span>
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">    if (provider != null) {</span>
<span class="fc" id="L460">      String state = Location.getStateName(provider.state);</span>
<span class="fc" id="L461">      String tz = Location.getTimezoneByState(state);</span>
<span class="fc" id="L462">      primarySta3n = sta3n.addFact(provider.id, clean(provider.name) + &quot;,&quot; + tz);</span>
<span class="fc" id="L463">      location.addFact(provider.id,  clean(provider.name));</span>
    }

<span class="fc" id="L466">    int personID = patient(person, primarySta3n, time);</span>

<span class="fc bfc" id="L468" title="All 2 branches covered.">    for (Encounter encounter : person.record.encounters) {</span>
<span class="fc" id="L469">      int encounterID = encounter(personID, person, encounter, primarySta3n);</span>

<span class="fc bfc" id="L471" title="All 2 branches covered.">      for (HealthRecord.Entry condition : encounter.conditions) {</span>
<span class="fc" id="L472">        condition(personID, encounterID, encounter, condition, primarySta3n);</span>
<span class="fc" id="L473">      }</span>

<span class="fc bfc" id="L475" title="All 2 branches covered.">      for (HealthRecord.Entry allergy : encounter.allergies) {</span>
<span class="fc" id="L476">        allergy(personID, person, encounterID, encounter, allergy, primarySta3n);</span>
<span class="fc" id="L477">      }</span>

<span class="fc bfc" id="L479" title="All 2 branches covered.">      for (HealthRecord.Report report : encounter.reports) {</span>
        // Ignore death certificates
<span class="fc bfc" id="L481" title="All 2 branches covered.">        if (!DeathModule.DEATH_CERTIFICATE.equals(report.codes.get(0))) {</span>
<span class="fc" id="L482">          report(personID, encounterID, encounter, primarySta3n, report);</span>
        }
<span class="fc" id="L484">      }</span>

<span class="fc bfc" id="L486" title="All 2 branches covered.">      for (Observation observation : encounter.observations) {</span>
<span class="fc" id="L487">        observation(personID, encounterID, encounter, primarySta3n, observation);</span>
<span class="fc" id="L488">      }</span>

<span class="fc bfc" id="L490" title="All 2 branches covered.">      for (Procedure procedure : encounter.procedures) {</span>
<span class="fc" id="L491">        procedure(personID, encounterID, encounter, procedure, primarySta3n);</span>
<span class="fc" id="L492">      }</span>

<span class="fc bfc" id="L494" title="All 2 branches covered.">      for (Medication medication : encounter.medications) {</span>
<span class="fc" id="L495">        medication(personID, encounterID, encounter, medication, primarySta3n);</span>
<span class="fc" id="L496">      }</span>

<span class="fc bfc" id="L498" title="All 2 branches covered.">      for (Immunization immunization : encounter.immunizations) {</span>
<span class="fc" id="L499">        immunization(personID, person, encounterID, encounter, immunization, primarySta3n);</span>
<span class="fc" id="L500">      }</span>
<span class="fc" id="L501">    }</span>

    // Patient Data
<span class="fc" id="L504">    lookuppatient.flush();</span>
<span class="fc" id="L505">    spatient.flush();</span>
<span class="fc" id="L506">    spatientaddress.flush();</span>
<span class="fc" id="L507">    spatientphone.flush();</span>
<span class="fc" id="L508">    patientrace.flush();</span>
<span class="fc" id="L509">    patientethnicity.flush();</span>

    // Encounter Data
<span class="fc" id="L512">    consult.flush();</span>
<span class="fc" id="L513">    visit.flush();</span>
<span class="fc" id="L514">    appointment.flush();</span>
<span class="fc" id="L515">    inpatient.flush();</span>

    // Immunization Data
<span class="fc" id="L518">    immunization.flush();</span>

    // Allergy Data
<span class="fc" id="L521">    allergy.flush();</span>
<span class="fc" id="L522">    allergicreaction.flush();</span>
<span class="fc" id="L523">    allergycomment.flush();</span>

    // Condition Data
<span class="fc" id="L526">    problemlist.flush();</span>
<span class="fc" id="L527">    vdiagnosis.flush();</span>

    // Medication Data
<span class="fc" id="L530">    rxoutpatient.flush();</span>
<span class="fc" id="L531">    rxoutpatfill.flush();</span>
<span class="fc" id="L532">    nonvamed.flush();</span>
<span class="fc" id="L533">    cprsorder.flush();</span>
<span class="fc" id="L534">    ordereditem.flush();</span>

    // Diagnostic Report Data
<span class="fc" id="L537">    labchem.flush();</span>
<span class="fc" id="L538">    labpanel.flush();</span>
<span class="fc" id="L539">    patientlabchem.flush();</span>
<span class="fc" id="L540">    vprocedure.flush();</span>

    // Procedure Data
<span class="fc" id="L543">    surgeryProcedureDiagnosisCode.flush();</span>
<span class="fc" id="L544">    surgeryPRE.flush();</span>

    // Vital Sign Observation Data
<span class="fc" id="L547">    vitalSign.flush();</span>
<span class="fc" id="L548">  }</span>
  
  /**
   * Fact Tables should only be written after all patients have completed export.
   */
  public void writeFactTables() {
    try {
<span class="fc" id="L555">      File output = Exporter.getOutputFolder(&quot;cdw&quot;, null);</span>
<span class="fc" id="L556">      output.mkdirs();</span>
<span class="fc" id="L557">      Path outputDirectory = output.toPath();</span>
<span class="fc" id="L558">      sstaff.write(openFileWriter(outputDirectory, &quot;sstaff.csv&quot;));</span>
<span class="fc" id="L559">      maritalStatus.write(openFileWriter(outputDirectory, &quot;maritalstatus.csv&quot;));</span>
<span class="fc" id="L560">      sta3n.write(openFileWriter(outputDirectory, &quot;sta3n.csv&quot;));</span>
<span class="fc" id="L561">      location.write(openFileWriter(outputDirectory, &quot;location.csv&quot;));</span>
<span class="fc" id="L562">      immunizationName.write(openFileWriter(outputDirectory, &quot;immunizationname.csv&quot;));</span>
<span class="fc" id="L563">      reaction.write(openFileWriter(outputDirectory, &quot;reaction.csv&quot;));</span>
<span class="fc" id="L564">      providerNarrative.write(openFileWriter(outputDirectory, &quot;providernarrative.csv&quot;));</span>
<span class="fc" id="L565">      localDrug.write(openFileWriter(outputDirectory, &quot;localdrug.csv&quot;));</span>
<span class="fc" id="L566">      nationalDrug.write(openFileWriter(outputDirectory, &quot;nationaldrug.csv&quot;));</span>
<span class="fc" id="L567">      dosageForm.write(openFileWriter(outputDirectory, &quot;dosageform.csv&quot;));</span>
<span class="fc" id="L568">      pharmacyOrderableItem.write(openFileWriter(outputDirectory, &quot;pharmacyorderableitem.csv&quot;));</span>
<span class="fc" id="L569">      orderableItem.write(openFileWriter(outputDirectory, &quot;orderableitem.csv&quot;));</span>
<span class="fc" id="L570">      orderStatus.write(openFileWriter(outputDirectory, &quot;orderstatus.csv&quot;));</span>
<span class="fc" id="L571">      vistaPackage.write(openFileWriter(outputDirectory, &quot;vistapackage.csv&quot;));</span>
<span class="fc" id="L572">      collectionsample.write(openFileWriter(outputDirectory, &quot;collectionsample.csv&quot;));</span>
<span class="fc" id="L573">      labchemtest.write(openFileWriter(outputDirectory, &quot;labchemtest.csv&quot;));</span>
<span class="fc" id="L574">      topography.write(openFileWriter(outputDirectory, &quot;topography.csv&quot;));</span>
<span class="fc" id="L575">      institution.write(openFileWriter(outputDirectory, &quot;institution.csv&quot;));</span>
<span class="fc" id="L576">      loinc.write(openFileWriter(outputDirectory, &quot;loinc.csv&quot;));</span>
<span class="fc" id="L577">      cpt.write(openFileWriter(outputDirectory, &quot;cpt.csv&quot;));</span>
<span class="fc" id="L578">      vitalType.write(openFileWriter(outputDirectory, &quot;vitaltype.csv&quot;));</span>
<span class="nc" id="L579">    } catch (IOException e) {</span>
      // wrap the exception in a runtime exception.
      // the singleton pattern below doesn't work if the constructor can throw
      // and if these do throw ioexceptions there's nothing we can do anyway
<span class="nc" id="L583">      throw new RuntimeException(e);</span>
<span class="fc" id="L584">    }</span>
<span class="fc" id="L585">  }</span>

  /**
   * Record a Patient.
   *
   * @param person Person to write data for
   * @param sta3n The primary station ID for this patient
   * @param time Time the simulation ended, to calculate age/deceased status
   * @return the patient's ID, to be referenced as a &quot;foreign key&quot; if necessary
   * @throws IOException if any IO error occurs
   */
  private int patient(Person person, int sta3n, long time) throws IOException {
    // Generate full name and ID
<span class="fc" id="L598">    StringBuilder s = new StringBuilder();</span>
<span class="pc bpc" id="L599" title="1 of 2 branches missed.">    if (person.attributes.containsKey(Person.NAME_PREFIX)) {</span>
<span class="fc" id="L600">      s.append(person.attributes.get(Person.NAME_PREFIX)).append(' ');</span>
    }
<span class="fc" id="L602">    s.append(person.attributes.get(Person.FIRST_NAME)).append(' ');</span>
<span class="fc" id="L603">    s.append(person.attributes.get(Person.LAST_NAME));</span>
<span class="pc bpc" id="L604" title="1 of 2 branches missed.">    if (person.attributes.containsKey(Person.NAME_SUFFIX)) {</span>
<span class="nc" id="L605">      s.append(' ').append(person.attributes.get(Person.NAME_SUFFIX));</span>
    }
<span class="fc" id="L607">    String patientName = s.toString();</span>
<span class="fc" id="L608">    int personID = getNextKey(spatient);</span>

    // lookuppatient.write(&quot;PatientSID,Sta3n,PatientIEN,PatientICN,PatientFullCN,&quot;
    //     + &quot;PatientName,TestPatient&quot;);
<span class="fc" id="L612">    s.setLength(0);</span>
<span class="fc" id="L613">    s.append(personID).append(',');</span>
<span class="fc" id="L614">    s.append(sta3n).append(',');</span>
<span class="fc" id="L615">    s.append(personID).append(',');</span>
<span class="fc" id="L616">    s.append(personID).append(',');</span>
<span class="fc" id="L617">    s.append(personID).append(',');</span>
<span class="fc" id="L618">    s.append(patientName).append(&quot;,1&quot;);</span>
<span class="fc" id="L619">    s.append(NEWLINE);</span>
<span class="fc" id="L620">    write(s.toString(), lookuppatient);</span>

    // spatient.write(&quot;PatientSID,PatientName,PatientLastName,PatientFirstName,PatientSSN,Age,&quot;
    //     + &quot;BirthDateTime,DeceasedFlag,DeathDateTime,Gender,SelfIdentifiedGender,Religion,&quot;
    //     + &quot;MaritalStatus,MaritalStatusSID,PatientEnteredDateTime&quot;);
<span class="fc" id="L625">    s.setLength(0);</span>
<span class="fc" id="L626">    s.append(personID).append(',');</span>
<span class="fc" id="L627">    s.append(patientName);</span>
<span class="fc" id="L628">    s.append(',').append(clean((String) person.attributes.getOrDefault(Person.LAST_NAME, &quot;&quot;)));</span>
<span class="fc" id="L629">    s.append(',').append(clean((String) person.attributes.getOrDefault(Person.FIRST_NAME, &quot;&quot;)));</span>
<span class="fc" id="L630">    s.append(',').append(clean((String) person.attributes.getOrDefault(Person.IDENTIFIER_SSN, &quot;&quot;)));</span>

<span class="fc" id="L632">    boolean alive = person.alive(time);</span>
<span class="fc" id="L633">    int age = 0;</span>
<span class="fc bfc" id="L634" title="All 2 branches covered.">    if (alive) {</span>
<span class="fc" id="L635">      age = person.ageInYears(time);</span>
    } else {
<span class="fc" id="L637">      age = person.ageInYears(person.events.event(Event.DEATH).time);</span>
    }
<span class="fc" id="L639">    s.append(',').append(age);</span>
<span class="fc" id="L640">    s.append(',').append(iso8601Timestamp((long) person.attributes.get(Person.BIRTHDATE)));</span>

<span class="fc bfc" id="L642" title="All 2 branches covered.">    if (alive) {</span>
<span class="fc" id="L643">      s.append(',').append('N').append(',');</span>
    } else {
<span class="fc" id="L645">      s.append(',').append('Y');</span>
<span class="fc" id="L646">      s.append(',').append(iso8601Timestamp(person.events.event(Event.DEATH).time));</span>
    }
<span class="fc bfc" id="L648" title="All 2 branches covered.">    if (person.attributes.get(Person.GENDER).equals(&quot;M&quot;)) {</span>
<span class="fc" id="L649">      s.append(&quot;,M,Male&quot;);</span>
    } else {
<span class="fc" id="L651">      s.append(&quot;,F,Female&quot;);      </span>
    }
    
<span class="fc" id="L654">    s.append(&quot;,None&quot;); // Religion</span>
    
    // Currently there are no divorces or widows
    // Legal codes: (D)ivorced, (N)ever Married, (S)eperated, (W)idowed, (M)arried, (U)nknown
<span class="fc" id="L658">    String marital = ((String) person.attributes.get(Person.MARITAL_STATUS));</span>
<span class="pc bpc" id="L659" title="1 of 2 branches missed.">    if (marital != null) {</span>
<span class="pc bpc" id="L660" title="1 of 2 branches missed.">      if (marital.equals(&quot;M&quot;)) {</span>
<span class="fc" id="L661">        s.append(&quot;,Married&quot;);</span>
      } else {
<span class="nc" id="L663">        marital = &quot;N&quot;;</span>
<span class="nc" id="L664">        s.append(&quot;,Never Married&quot;);</span>
      }
    } else {
<span class="nc" id="L667">      marital = &quot;U&quot;;</span>
<span class="nc" id="L668">      s.append(&quot;,Unknown&quot;);</span>
    }
<span class="fc" id="L670">    s.append(',').append(maritalStatus.addFact(marital, marital));</span>
    
    // TODO Need an enlistment date or date they became a veteran.
<span class="fc" id="L673">    s.append(',').append(iso8601Timestamp(time - Utilities.convertTime(&quot;years&quot;, 10)));</span>
<span class="fc" id="L674">    s.append(NEWLINE);</span>
<span class="fc" id="L675">    write(s.toString(), spatient);</span>
    
    //  spatientaddress.write(&quot;SPatientAddressSID,PatientSID,AddressType,NameOfContact,&quot;
    //  + &quot;RelationshipToPatient,StreetAddress1,StreetAddress2,StreetAddress3,&quot;
    //  + &quot;City,State,Zip,PostalCode,Country,GISMatchScore,GISStreetSide,&quot;
    //  + &quot;GISPatientAddressLongitude,GISPatientAddressLatitude,GISFIPSCode&quot;);
<span class="fc" id="L681">    s.setLength(0);</span>
<span class="fc" id="L682">    s.append(getNextKey(spatientaddress)).append(',');</span>
<span class="fc" id="L683">    s.append(personID).append(',');</span>
<span class="fc" id="L684">    s.append(&quot;Legal Residence&quot;).append(',');</span>
<span class="fc" id="L685">    s.append(person.attributes.get(Person.FIRST_NAME)).append(' ');</span>
<span class="fc" id="L686">    s.append(person.attributes.get(Person.LAST_NAME)).append(',');</span>
<span class="fc" id="L687">    s.append(&quot;Self&quot;).append(',');</span>
<span class="fc" id="L688">    s.append(person.attributes.get(Person.ADDRESS)).append(&quot;,,,&quot;);</span>
<span class="fc" id="L689">    s.append(person.attributes.get(Person.CITY)).append(',');</span>
<span class="fc" id="L690">    s.append(person.attributes.get(Person.STATE)).append(',');</span>
<span class="fc" id="L691">    s.append(person.attributes.get(Person.ZIP)).append(',');</span>
<span class="fc" id="L692">    s.append(person.attributes.get(Person.ZIP)).append(&quot;,USA,,,&quot;);</span>

<span class="fc" id="L694">    DirectPosition2D coord = (DirectPosition2D) person.attributes.get(Person.COORDINATE);</span>
<span class="pc bpc" id="L695" title="1 of 2 branches missed.">    if (coord != null) {</span>
<span class="fc" id="L696">      s.append(coord.x).append(',').append(coord.y).append(',');</span>
    } else {
<span class="nc" id="L698">      s.append(&quot;,,&quot;);</span>
    }
<span class="fc" id="L700">    s.append(NEWLINE);</span>
<span class="fc" id="L701">    write(s.toString(), spatientaddress);</span>
    
    //spatientphone.write(&quot;SPatientPhoneSID,PatientSID,PatientContactType,NameOfContact,&quot;
    //  + &quot;RelationshipToPatient,PhoneNumber,WorkPhoneNumber,EmailAddress&quot;);
<span class="fc" id="L705">    s.setLength(0);</span>
<span class="fc" id="L706">    s.append(getNextKey(spatientphone)).append(',');</span>
<span class="fc" id="L707">    s.append(personID).append(',');</span>
<span class="fc" id="L708">    s.append(&quot;Patient Cell Phone&quot;).append(',');</span>
<span class="fc" id="L709">    s.append(person.attributes.get(Person.FIRST_NAME)).append(' ');</span>
<span class="fc" id="L710">    s.append(person.attributes.get(Person.LAST_NAME)).append(',');</span>
<span class="fc" id="L711">    s.append(&quot;Self&quot;).append(',');</span>
<span class="fc" id="L712">    s.append(person.attributes.get(Person.TELECOM)).append(&quot;,,&quot;);</span>
<span class="fc" id="L713">    s.append(NEWLINE);</span>
<span class="fc" id="L714">    write(s.toString(), spatientphone);</span>

<span class="fc bfc" id="L716" title="All 2 branches covered.">    if (person.random.nextBoolean()) {</span>
      // Add an email address
<span class="fc" id="L718">      s.setLength(0);</span>
<span class="fc" id="L719">      s.append(getNextKey(spatientphone)).append(',');</span>
<span class="fc" id="L720">      s.append(personID).append(',');</span>
<span class="fc" id="L721">      s.append(&quot;Patient Email&quot;).append(',');</span>
<span class="fc" id="L722">      s.append(person.attributes.get(Person.FIRST_NAME)).append(' ');</span>
<span class="fc" id="L723">      s.append(person.attributes.get(Person.LAST_NAME)).append(',');</span>
<span class="fc" id="L724">      s.append(&quot;Self&quot;).append(',');</span>
<span class="fc" id="L725">      s.append(&quot;,,&quot;);</span>
<span class="fc" id="L726">      s.append(person.attributes.get(Person.FIRST_NAME)).append('.');</span>
<span class="fc" id="L727">      s.append(person.attributes.get(Person.LAST_NAME)).append(&quot;@email.example&quot;);</span>
<span class="fc" id="L728">      s.append(NEWLINE);</span>
<span class="fc" id="L729">      write(s.toString(), spatientphone);</span>
    }

    //patientrace.write(&quot;PatientRaceSID,PatientSID,Race&quot;);
<span class="fc" id="L733">    String race = (String) person.attributes.get(Person.RACE);</span>
<span class="fc bfc" id="L734" title="All 2 branches covered.">    if (race.equals(&quot;white&quot;)) {</span>
<span class="fc" id="L735">      race = &quot;WHITE NOT OF HISP ORIG&quot;;</span>
<span class="pc bpc" id="L736" title="1 of 2 branches missed.">    } else if (race.equals(&quot;hispanic&quot;)) {</span>
<span class="nc" id="L737">      race = &quot;WHITE&quot;;</span>
<span class="pc bpc" id="L738" title="1 of 2 branches missed.">    } else if (race.equals(&quot;black&quot;)) {</span>
<span class="nc" id="L739">      race = &quot;BLACK OR AFRICAN AMERICAN&quot;;</span>
<span class="pc bpc" id="L740" title="1 of 2 branches missed.">    } else if (race.equals(&quot;asian&quot;)) {</span>
<span class="fc" id="L741">      race = &quot;ASIAN&quot;;</span>
<span class="nc bnc" id="L742" title="All 2 branches missed.">    } else if (race.equals(&quot;native&quot;)) {</span>
<span class="nc bnc" id="L743" title="All 2 branches missed.">      if (person.attributes.get(Person.STATE).equals(&quot;Hawaii&quot;)) {</span>
<span class="nc" id="L744">        race = &quot;NATIVE HAWAIIAN OR OTHER PACIFIC ISLANDER&quot;;</span>
      } else {
<span class="nc" id="L746">        race = &quot;AMERICAN INDIAN OR ALASKA NATIVE&quot;;</span>
      }
    } else { // race.equals(&quot;other&quot;)
<span class="nc" id="L749">      race = &quot;ASIAN&quot;;</span>
    }
<span class="fc" id="L751">    s.setLength(0);</span>
<span class="fc" id="L752">    s.append(getNextKey(patientrace)).append(',');</span>
<span class="fc" id="L753">    s.append(personID).append(',');</span>
<span class="fc" id="L754">    s.append(race);</span>
<span class="fc" id="L755">    s.append(NEWLINE);</span>
<span class="fc" id="L756">    write(s.toString(), patientrace);</span>

    //patientethnicity.write(&quot;PatientEthnicitySID,PatientSID,Ethnicity&quot;);
<span class="fc" id="L759">    s.setLength(0);</span>
<span class="fc" id="L760">    s.append(getNextKey(patientethnicity)).append(',');</span>
<span class="fc" id="L761">    s.append(personID).append(',');</span>
<span class="fc" id="L762">    race = (String) person.attributes.get(Person.RACE);</span>
<span class="pc bpc" id="L763" title="1 of 2 branches missed.">    if (race.equals(&quot;hispanic&quot;)) {</span>
<span class="nc" id="L764">      s.append(&quot;HISPANIC OR LATINO&quot;);</span>
    } else {
<span class="fc" id="L766">      s.append(&quot;NOT HISPANIC OR LATINO&quot;);</span>
    }
<span class="fc" id="L768">    s.append(NEWLINE);</span>
<span class="fc" id="L769">    write(s.toString(), patientethnicity);</span>

<span class="fc" id="L771">    return personID;</span>
  }

  /**
   * Write a single Encounter to the tables.
   *
   * @param personID The ID of the person that had this encounter
   * @param person The person attending the encounter
   * @param encounter The encounter itself
   * @param primarySta3n The primary home sta3n for the patient
   * @return The encounter ID, to be referenced as a &quot;foreign key&quot; if necessary
   * @throws IOException if any IO error occurs
   */
  private int encounter(int personID, Person person, Encounter encounter, int primarySta3n)
      throws IOException {
<span class="fc" id="L786">    StringBuilder s = new StringBuilder();</span>

    // consult.write(&quot;ConsultSID,ToRequestServiceSID&quot;);
<span class="fc" id="L789">    int consultSid = getNextKey(consult);</span>
<span class="fc" id="L790">    s.append(consultSid).append(',').append(consultSid).append(NEWLINE);</span>
<span class="fc" id="L791">    write(s.toString(), consult);</span>

    // visit.write(&quot;VisitSID,VisitDateTime,CreatedByStaffSID,LocationSID,PatientSID&quot;);
<span class="fc" id="L794">    int visitSid = getNextKey(visit);</span>
<span class="fc" id="L795">    int staffSid = person.randInt(CLINICIANS) + (sidStart / 10_000);</span>
<span class="fc bfc" id="L796" title="All 2 branches covered.">    if (encounter.provider != null) {</span>
<span class="fc" id="L797">      encounter.provider.attributes.put(CLINICIAN_SID, staffSid);</span>
    }

<span class="fc" id="L800">    s.setLength(0);</span>
<span class="fc" id="L801">    s.append(visitSid).append(',');</span>
<span class="fc" id="L802">    s.append(iso8601Timestamp(encounter.start)).append(',');</span>
<span class="fc" id="L803">    s.append(staffSid).append(','); // CreatedByStaffID</span>
<span class="fc" id="L804">    Integer locationSid = null;</span>
<span class="fc bfc" id="L805" title="All 2 branches covered.">    if (encounter.provider != null) {</span>
<span class="fc" id="L806">      locationSid = location.addFact(encounter.provider.id, clean(encounter.provider.name));</span>
<span class="fc" id="L807">      s.append(locationSid).append(',');</span>
    } else {
<span class="fc" id="L809">      s.append(primarySta3n).append(',');</span>
    }
<span class="fc" id="L811">    s.append(personID);</span>
<span class="fc" id="L812">    s.append(NEWLINE);</span>
<span class="fc" id="L813">    write(s.toString(), visit);</span>

    // appointment.write(&quot;AppointmentSID,Sta3n,PatientSID,AppointmentDateTime,AppointmentMadeDate,&quot;
    //    + &quot;AppointmentTypeSID,AppointmentStatus,VisitSID,LocationSID,PurposeOfVisit,&quot;
    //    + &quot;SchedulingRequestType,FollowUpVisitFlag,LengthOfAppointment,ConsultSID,&quot;
    //    + &quot;CheckInDateTime,CheckOutDateTime&quot;);
<span class="fc" id="L819">    s.setLength(0);</span>
<span class="fc" id="L820">    s.append(getNextKey(appointment)).append(',');</span>
<span class="fc bfc" id="L821" title="All 2 branches covered.">    if (encounter.provider != null) {</span>
<span class="fc" id="L822">      String state = Location.getStateName(encounter.provider.state);</span>
<span class="fc" id="L823">      String tz = Location.getTimezoneByState(state);</span>
<span class="fc" id="L824">      s.append(sta3n.addFact(encounter.provider.id, clean(encounter.provider.name) + &quot;,&quot; + tz));</span>
<span class="fc" id="L825">    } else {</span>
<span class="fc" id="L826">      s.append(primarySta3n);</span>
    }
<span class="fc" id="L828">    s.append(',');</span>
<span class="fc" id="L829">    s.append(personID).append(',');</span>
<span class="fc" id="L830">    s.append(iso8601Timestamp(encounter.start)).append(',');</span>
<span class="fc" id="L831">    s.append(iso8601Timestamp(encounter.start)).append(',');</span>
<span class="fc" id="L832">    s.append(&quot;,,&quot;); // skip: AppointmentTypeSID, AppointmentStatus</span>
<span class="fc" id="L833">    s.append(visitSid).append(',');</span>
<span class="fc bfc" id="L834" title="All 2 branches covered.">    if (locationSid != null) {</span>
<span class="fc" id="L835">      s.append(locationSid).append(',');</span>
    } else {
<span class="fc" id="L837">      s.append(primarySta3n).append(&quot;,&quot;);</span>
    }
<span class="fc" id="L839">    s.append(&quot;3,&quot;); // 3:SCHEDULED VISIT</span>
<span class="fc" id="L840">    s.append(person.rand(new String[] {&quot;N&quot;, &quot;C&quot;, &quot;P&quot;, &quot;W&quot;, &quot;M&quot;, &quot;A&quot;, &quot;O&quot;})).append(',');</span>
<span class="fc" id="L841">    s.append(person.randInt(1)).append(',');</span>
<span class="fc" id="L842">    s.append((encounter.stop - encounter.start) / (60 * 1000)).append(',');</span>
<span class="fc" id="L843">    s.append(consultSid).append(',');</span>
<span class="fc" id="L844">    s.append(iso8601Timestamp(encounter.start)).append(',');</span>
<span class="fc" id="L845">    s.append(iso8601Timestamp(encounter.stop)).append(NEWLINE);</span>
<span class="fc" id="L846">    write(s.toString(), appointment);</span>

<span class="fc bfc" id="L848" title="All 2 branches covered.">    if (encounter.type.equalsIgnoreCase(EncounterType.INPATIENT.toString())) {</span>
      // inpatient.write(&quot;InpatientSID,PatientSID,AdmitDateTime&quot;);
<span class="fc" id="L850">      s.setLength(0);</span>
<span class="fc" id="L851">      s.append(getNextKey(inpatient)).append(',');</span>
<span class="fc" id="L852">      s.append(personID).append(',');</span>
<span class="fc" id="L853">      s.append(iso8601Timestamp(encounter.start)).append(NEWLINE);</span>
<span class="fc" id="L854">      write(s.toString(), inpatient);</span>
    }

<span class="fc" id="L857">    return visitSid;</span>
  }

  /**
   * Write a single Condition to the tables.
   *
   * @param personID ID of the person that has the condition.
   * @param encounterID ID of the encounter where the condition was diagnosed
   * @param encounter The encounter
   * @param condition The condition itself
   * @param primarySta3n The primary home sta3n for the patient
   * @throws IOException if any IO error occurs
   */
  private void condition(int personID, int encounterID, Encounter encounter,
      Entry condition, int primarySta3n) throws IOException {
<span class="fc" id="L872">    StringBuilder s = new StringBuilder();</span>
<span class="fc" id="L873">    Integer sta3nValue = null;</span>
<span class="fc" id="L874">    Integer providerSID = (sidStart / 10_000);</span>
<span class="pc bpc" id="L875" title="1 of 2 branches missed.">    if (encounter.provider != null) {</span>
<span class="fc" id="L876">      String state = Location.getStateName(encounter.provider.state);</span>
<span class="fc" id="L877">      String tz = Location.getTimezoneByState(state);</span>
<span class="fc" id="L878">      sta3nValue = sta3n.addFact(encounter.provider.id, clean(encounter.provider.name) + &quot;,&quot; + tz);</span>
<span class="fc" id="L879">      providerSID = (Integer) encounter.provider.attributes.get(CLINICIAN_SID);</span>
    }

<span class="fc" id="L882">    Code code = condition.codes.get(0);</span>
<span class="fc" id="L883">    int snomedSID = providerNarrative.addFact(code.code, clean(code.display));</span>

    // problemlist.write(&quot;ProblemListSID,Sta3n,ICD9SID,ICD10SID,PatientSID,ProviderNarrativeSID,&quot;
    //    + &quot;EnteredDateTime,OnsetDateTime,ProblemListCondition,RecordingProviderSID,&quot;
    //    + &quot;ResolvedDateTime,SNOMEDCTConceptCode&quot;);
<span class="fc" id="L888">    int problemListSid = getNextKey(problemlist);</span>
<span class="fc" id="L889">    s.append(problemListSid).append(',');</span>
<span class="pc bpc" id="L890" title="1 of 2 branches missed.">    if (sta3nValue != null) {</span>
<span class="fc" id="L891">      s.append(sta3nValue);</span>
    } else {
<span class="nc" id="L893">      s.append(primarySta3n);</span>
    }
<span class="fc" id="L895">    s.append(',');</span>
<span class="fc" id="L896">    s.append(&quot;,,&quot;); // skip icd 9 and icd 10</span>
<span class="fc" id="L897">    s.append(personID).append(',');</span>
<span class="fc" id="L898">    s.append(snomedSID).append(','); // snomed display is jammed into narrative.</span>
<span class="fc" id="L899">    s.append(iso8601Timestamp(encounter.start)).append(',');</span>
<span class="fc" id="L900">    s.append(iso8601Timestamp(condition.start)).append(',');</span>
<span class="fc" id="L901">    s.append(&quot;P,&quot;);</span>
<span class="fc" id="L902">    s.append(providerSID).append(','); // RecordingProviderSID</span>
<span class="fc bfc" id="L903" title="All 2 branches covered.">    if (condition.stop != 0L) {</span>
<span class="fc" id="L904">      s.append(iso8601Timestamp(condition.stop));</span>
    }
<span class="fc" id="L906">    s.append(',');</span>
<span class="fc" id="L907">    s.append(code.code);</span>
<span class="fc" id="L908">    s.append(NEWLINE);</span>
<span class="fc" id="L909">    write(s.toString(), problemlist);</span>

    // vdiagnosis.write(&quot;VDiagnosisSID,Sta3n,ICD9SID,ICD10SID,PatientSID,VisitSID,&quot;
    //    + &quot;VisitDateTime,VDiagnosisDateTime,ProviderNarrativeSID,ProblemListSID,&quot;
    //    + &quot;OrderingProviderSID,EncounterProviderSID&quot;);
<span class="fc" id="L914">    s.setLength(0);</span>
<span class="fc" id="L915">    s.append(getNextKey(vdiagnosis));</span>
<span class="fc" id="L916">    s.append(',');</span>
<span class="pc bpc" id="L917" title="1 of 2 branches missed.">    if (sta3nValue != null) {</span>
<span class="fc" id="L918">      s.append(sta3nValue);</span>
    } else {
<span class="nc" id="L920">      s.append(primarySta3n);</span>
    }
<span class="fc" id="L922">    s.append(',');</span>
<span class="fc" id="L923">    s.append(&quot;,,&quot;); // skip icd 9 and icd 10</span>
<span class="fc" id="L924">    s.append(personID).append(',');</span>
<span class="fc" id="L925">    s.append(encounterID).append(',');</span>
<span class="fc" id="L926">    s.append(iso8601Timestamp(encounter.start)).append(',');</span>
<span class="fc" id="L927">    s.append(iso8601Timestamp(condition.start)).append(',');</span>
<span class="fc" id="L928">    s.append(snomedSID).append(','); // snomed display is jammed into narrative.</span>
<span class="fc" id="L929">    s.append(problemListSid).append(',');</span>
<span class="fc" id="L930">    s.append(providerSID).append(','); // OrderingProviderSID</span>
<span class="fc" id="L931">    s.append(providerSID).append(','); // EncounterProviderSID</span>
<span class="fc" id="L932">    s.append(NEWLINE);</span>
<span class="fc" id="L933">    write(s.toString(), vdiagnosis);</span>
<span class="fc" id="L934">  }</span>

  /**
   * Write a single Allergy to the tables.
   *
   * @param personID ID of the person that has the allergy.
   * @param person The person
   * @param encounterID ID of the encounter where the allergy was diagnosed
   * @param encounter The encounter
   * @param allergyEntry The allergy itself
   * @param primarySta3n The primary home sta3n for the patient
   * @throws IOException if any IO error occurs
   */
  private void allergy(int personID, Person person, int encounterID, Encounter encounter,
      Entry allergyEntry, int primarySta3n) throws IOException {
<span class="fc" id="L949">    StringBuilder s = new StringBuilder();</span>

<span class="fc" id="L951">    Integer sta3nValue = null;</span>
<span class="fc" id="L952">    Integer providerSID = (sidStart / 10_000);</span>
<span class="pc bpc" id="L953" title="1 of 2 branches missed.">    if (encounter.provider != null) {</span>
<span class="fc" id="L954">      String state = Location.getStateName(encounter.provider.state);</span>
<span class="fc" id="L955">      String tz = Location.getTimezoneByState(state);</span>
<span class="fc" id="L956">      sta3nValue = sta3n.addFact(encounter.provider.id, clean(encounter.provider.name) + &quot;,&quot; + tz);</span>
<span class="fc" id="L957">      providerSID = (Integer) encounter.provider.attributes.get(CLINICIAN_SID);</span>
    }
<span class="fc" id="L959">    Code code = allergyEntry.codes.get(0);</span>
<span class="fc" id="L960">    boolean food = code.display.matches(&quot;.*(nut|peanut|milk|dairy|eggs|shellfish|wheat).*&quot;);</span>

    // allergy.write(&quot;AllergySID,AllergyIEN,Sta3n,PatientSID,AllergyType,AllergicReactant,&quot;
    //     + &quot;LocalDrugSID,DrugNameWithoutDoseSID,DrugClassSID,ReactantSID,DrugIngredientSID,&quot;
    //     + &quot;OriginationDateTime,OriginatingStaffSID,ObservedHistorical,Mechanism,VerifiedFlag,&quot;
    //     + &quot;VerificatiionDateTime,VerifyingStaffSID,EnteredInErrorFlag&quot;);
<span class="fc" id="L966">    int allergySID = getNextKey(allergy);</span>
<span class="fc" id="L967">    s.append(allergySID).append(',');</span>
<span class="fc" id="L968">    s.append(allergySID).append(',');</span>
<span class="pc bpc" id="L969" title="1 of 2 branches missed.">    if (encounter.provider != null) {</span>
<span class="fc" id="L970">      s.append(sta3nValue);</span>
    } else {
<span class="nc" id="L972">      s.append(primarySta3n);</span>
    }
<span class="fc" id="L974">    s.append(',');</span>
<span class="fc" id="L975">    s.append(personID).append(',');</span>
<span class="fc bfc" id="L976" title="All 2 branches covered.">    if (food) {</span>
<span class="fc" id="L977">      s.append('F').append(','); // F: Food allergy</span>
    } else {
<span class="fc" id="L979">      s.append('O').append(','); // O: Other</span>
    }
<span class="fc" id="L981">    s.append(clean(code.display)).append(','); // AllergicReactant</span>
<span class="fc" id="L982">    s.append(','); // LocalDrugSID</span>
<span class="fc" id="L983">    s.append(','); // DrugNameWithoutDoseSID</span>
<span class="fc" id="L984">    s.append(','); // DrugClassSID</span>
<span class="fc" id="L985">    s.append(','); // ReactantSID</span>
<span class="fc" id="L986">    s.append(','); // DrugIngredientSID</span>
<span class="fc" id="L987">    s.append(iso8601Timestamp(allergyEntry.start)).append(',');</span>
<span class="fc" id="L988">    s.append(providerSID).append(','); // OriginatingStaffSID</span>
<span class="fc" id="L989">    s.append(person.rand(new String[] {&quot;o&quot;, &quot;h&quot;})).append(',');</span>
<span class="fc" id="L990">    s.append(&quot;A,&quot;);</span>
<span class="fc" id="L991">    s.append(&quot;1,&quot;); // Verified</span>
<span class="fc" id="L992">    s.append(iso8601Timestamp(allergyEntry.start)).append(',');</span>
<span class="fc" id="L993">    s.append(providerSID).append(','); // VerifyingStaffSID</span>
<span class="fc" id="L994">    s.append(',');</span>
<span class="fc" id="L995">    s.append(NEWLINE);</span>
<span class="fc" id="L996">    write(s.toString(), allergy);</span>

    // allergyreaction.write(&quot;AllergicReactionSID,AllergySID,AllergyIEN,Sta3n,ReactionSID&quot;);
<span class="fc" id="L999">    String reactionDisplay = person.rand(</span>
        new String[] {&quot;Sneezing and Coughing&quot;, &quot;Inflammation of Skin&quot;,
            &quot;Itchy Watery Eyes&quot;, &quot;Difficulty Breathing&quot;});
<span class="fc" id="L1002">    s.setLength(0);</span>
<span class="fc" id="L1003">    int allergyreactionSID = getNextKey(allergicreaction);</span>
<span class="fc" id="L1004">    s.append(allergyreactionSID).append(',');</span>
<span class="fc" id="L1005">    s.append(allergySID).append(',');</span>
<span class="fc" id="L1006">    s.append(allergySID).append(',');</span>
<span class="pc bpc" id="L1007" title="1 of 2 branches missed.">    if (encounter.provider != null) {</span>
<span class="fc" id="L1008">      s.append(sta3nValue);</span>
    } else {
<span class="nc" id="L1010">      s.append(primarySta3n);</span>
    }
<span class="fc" id="L1012">    s.append(',');</span>
<span class="fc" id="L1013">    s.append(reaction.addFact(reactionDisplay, reactionDisplay + &quot;,&quot; + allergyreactionSID));</span>
<span class="fc" id="L1014">    s.append(NEWLINE);</span>
<span class="fc" id="L1015">    write(s.toString(), allergicreaction);</span>

    // allergycomment.write(&quot;AllergyCommentSID,AllergySID,AllergyIEN,Sta3n,PatientSID,&quot;
    //    + &quot;OriginationDateTime,EnteringStaffSID,AllergyComment,CommentEnteredDateTime&quot;);
<span class="fc" id="L1019">    s.setLength(0);</span>
<span class="fc" id="L1020">    int allergyCommentSid = getNextKey(allergycomment);</span>
<span class="fc" id="L1021">    s.append(allergyCommentSid).append(',');</span>
<span class="fc" id="L1022">    s.append(allergySID).append(',');</span>
<span class="fc" id="L1023">    s.append(allergySID).append(',');</span>
<span class="pc bpc" id="L1024" title="1 of 2 branches missed.">    if (encounter.provider != null) {</span>
<span class="fc" id="L1025">      s.append(sta3nValue);</span>
    } else {
<span class="nc" id="L1027">      s.append(primarySta3n);</span>
    }
<span class="fc" id="L1029">    s.append(',');</span>
<span class="fc" id="L1030">    s.append(personID).append(',');</span>
<span class="fc" id="L1031">    s.append(iso8601Timestamp(allergyEntry.start)).append(',');</span>
<span class="fc" id="L1032">    s.append(providerSID).append(','); // EnteringStaffSID</span>
<span class="fc" id="L1033">    s.append(clean(code.display)).append(',');</span>
<span class="fc" id="L1034">    s.append(iso8601Timestamp(allergyEntry.start));</span>
<span class="fc" id="L1035">    s.append(NEWLINE);</span>
<span class="fc" id="L1036">    write(s.toString(), allergycomment);</span>
<span class="fc" id="L1037">  }</span>

  /**
   * Write a DiagnosticReport to the tables.
   *
   * @param personID The ID of the person that had this encounter
   * @param encounterID The ID of the encounter
   * @param encounter The encounter
   * @param primarySta3n The primary home sta3n for the patient
   * @param report The diagnostic lab report
   * @throws IOException if any IO error occurs
   */
  private void report(int personID, int encounterID, Encounter encounter,
      int primarySta3n, Report report) throws IOException {
<span class="fc" id="L1051">    StringBuilder s = new StringBuilder();</span>

<span class="fc" id="L1053">    Integer sta3nValue = null;</span>
<span class="fc" id="L1054">    Integer providerSID = (sidStart / 10_000);</span>
<span class="pc bpc" id="L1055" title="1 of 2 branches missed.">    if (encounter.provider != null) {</span>
<span class="fc" id="L1056">      String state = Location.getStateName(encounter.provider.state);</span>
<span class="fc" id="L1057">      String tz = Location.getTimezoneByState(state);</span>
<span class="fc" id="L1058">      sta3nValue = sta3n.addFact(encounter.provider.id, clean(encounter.provider.name) + &quot;,&quot; + tz);</span>
<span class="fc" id="L1059">      providerSID = (Integer) encounter.provider.attributes.get(CLINICIAN_SID);</span>
    }

    // cprsorder.write(&quot;CPRSOrderID,Sta3n,PatientSID,OrderStaffSID,EnteredByStaffSID,&quot;
    //   + &quot;EnteredDateTime,OrderStatusSID,VistaPackageSID,OrderStartDateTime,OrderStopDateTime,&quot;
    //   + &quot;PackageReference&quot;);
<span class="fc" id="L1065">    int cprsSID = getNextKey(cprsorder);</span>
<span class="fc" id="L1066">    s.setLength(0);</span>
<span class="fc" id="L1067">    s.append(cprsSID).append(',');</span>
<span class="pc bpc" id="L1068" title="1 of 2 branches missed.">    if (sta3nValue != null) {</span>
<span class="fc" id="L1069">      s.append(sta3nValue);</span>
    } else {
<span class="nc" id="L1071">      s.append(primarySta3n);</span>
    }
<span class="fc" id="L1073">    s.append(',');</span>
<span class="fc" id="L1074">    s.append(personID).append(',');</span>
<span class="fc" id="L1075">    s.append(providerSID).append(&quot;,&quot;); // OrderStaffSID</span>
<span class="fc" id="L1076">    s.append(providerSID).append(&quot;,&quot;); // EnteredByStaffSID</span>
<span class="fc" id="L1077">    s.append(iso8601Timestamp(report.start)).append(',');</span>
<span class="fc" id="L1078">    int orderStatusSID = orderStatus.addFact(&quot;COMPLETED&quot;, &quot;COMPLETED&quot;);</span>
<span class="fc" id="L1079">    s.append(orderStatusSID).append(',');</span>
<span class="fc" id="L1080">    int vistaPackageSID = vistaPackage.addFact(&quot;DIAGNOSTIC LABORATORY&quot;, &quot;DIAGNOSTIC LABORATORY&quot;);</span>
<span class="fc" id="L1081">    s.append(vistaPackageSID).append(',');</span>
<span class="fc" id="L1082">    s.append(iso8601Timestamp(report.start)).append(',');</span>
<span class="pc bpc" id="L1083" title="1 of 2 branches missed.">    if (report.stop != 0L) {</span>
<span class="nc" id="L1084">      s.append(iso8601Timestamp(report.stop));</span>
    }
<span class="fc" id="L1086">    s.append(',');</span>
<span class="fc" id="L1087">    s.append(&quot;LAB_&quot; + cprsSID); // PackageReference joins to LabPanel.LabPanelIEN</span>
<span class="fc" id="L1088">    s.append(NEWLINE);</span>
<span class="fc" id="L1089">    write(s.toString(), cprsorder);</span>

    // orderableItem.setHeader(&quot;OrderableItemSID,OrderableItemName,IVBaseFlag,IVAdditiveFlag&quot;);
<span class="fc" id="L1092">    Code code = report.codes.get(0);</span>
<span class="fc" id="L1093">    int orderableItemSID = orderableItem.addFact(code.code, clean(code.display) + &quot;,0,0&quot;);</span>

    // ordereditem.write(&quot;OrderedItemSID,CPRSOrderSID,OrderableItemSID&quot;);
<span class="fc" id="L1096">    s.setLength(0);</span>
<span class="fc" id="L1097">    s.append(cprsSID).append(&quot;,&quot;);</span>
<span class="fc" id="L1098">    s.append(cprsSID).append(&quot;,&quot;);</span>
<span class="fc" id="L1099">    s.append(orderableItemSID).append(NEWLINE);</span>
<span class="fc" id="L1100">    write(s.toString(), ordereditem);</span>

    // vprocedure.write(&quot;VProcedureSID,PatientSID,VisitSID,CPRSOrderSID&quot;);
<span class="fc" id="L1103">    s.setLength(0);</span>
<span class="fc" id="L1104">    s.append(getNextKey(vprocedure)).append(',');</span>
<span class="fc" id="L1105">    s.append(personID).append(',');</span>
<span class="fc" id="L1106">    s.append(encounterID).append(',');</span>
<span class="fc" id="L1107">    s.append(cprsSID);</span>
<span class="fc" id="L1108">    s.append(NEWLINE);</span>
<span class="fc" id="L1109">    write(s.toString(), vprocedure);</span>

    // loinc.setHeader(&quot;LOINCSID,LOINC,Component&quot;);
<span class="fc" id="L1112">    loinc.addFact(code.code, code.code + &quot;,&quot; + clean(code.display));</span>

    // labpanel.write(&quot;LabPanelSID,LabPanelIEN,PatientSID&quot;);
<span class="fc" id="L1115">    s.setLength(0);</span>
<span class="fc" id="L1116">    int labpanelSID = getNextKey(labpanel);</span>
<span class="fc" id="L1117">    s.append(labpanelSID).append(',');</span>
<span class="fc" id="L1118">    s.append(&quot;LAB_&quot; + cprsSID).append(','); // LabPanelIEN joins to CPRSOrder.PackageReference</span>
<span class="fc" id="L1119">    s.append(personID);</span>
<span class="fc" id="L1120">    s.append(NEWLINE);</span>
<span class="fc" id="L1121">    write(s.toString(), labpanel);</span>

    // collectionsample.setHeader(&quot;CollectionSampleSID,CollectionSample&quot;);
<span class="fc" id="L1124">    int sampleSID = collectionsample.addFact(code.code, clean(code.display) + &quot; Sample&quot;);</span>

    // labchem.write(&quot;LabChemSID,Sta3n,LabPanelSID,LabChemTestSID,PatientSID,StaffSID,&quot;
    // + &quot;LabChemSpecimenDateTime,LabChemResultValue,LOINCSID,Units,Abnormal,RefHigh,RefLow&quot;);
<span class="fc bfc" id="L1128" title="All 2 branches covered.">    for (Observation observation : report.observations) {</span>
<span class="fc" id="L1129">      Code obscode = observation.codes.get(0);</span>
      // labchemtest.setHeader(&quot;LabChemTestSID,LabChemTestName,CollectionSampleSID&quot;);
<span class="fc" id="L1131">      int labchemtestSID = labchemtest.addFact(obscode.code,</span>
<span class="fc" id="L1132">          clean(obscode.display) + &quot;,&quot; + sampleSID);</span>
<span class="fc" id="L1133">      int labchemSID = getNextKey(labchem);</span>
<span class="fc" id="L1134">      s.setLength(0);</span>
<span class="fc" id="L1135">      s.append(labchemSID).append(',');</span>
<span class="pc bpc" id="L1136" title="1 of 2 branches missed.">      if (sta3nValue != null) {</span>
<span class="fc" id="L1137">        s.append(sta3nValue);</span>
      } else {
<span class="nc" id="L1139">        s.append(primarySta3n);</span>
      }
<span class="fc" id="L1141">      s.append(',');</span>
<span class="fc" id="L1142">      s.append(labpanelSID).append(',');</span>
<span class="fc" id="L1143">      s.append(labchemtestSID).append(',');</span>
<span class="fc" id="L1144">      s.append(personID).append(',');</span>
<span class="fc" id="L1145">      s.append(providerSID).append(&quot;,&quot;); // StaffSID</span>
<span class="fc" id="L1146">      s.append(iso8601Timestamp(observation.start)).append(',');</span>
<span class="fc" id="L1147">      s.append(observation.value).append(',');</span>
<span class="fc" id="L1148">      int loincSID = loinc.addFact(obscode.code, obscode.code + &quot;,&quot; + clean(obscode.display));</span>
<span class="fc" id="L1149">      s.append(loincSID).append(',');</span>
<span class="fc" id="L1150">      s.append(observation.unit).append(',');</span>
<span class="fc" id="L1151">      s.append(','); // Abnormal</span>
<span class="fc" id="L1152">      s.append(','); // RefHigh, RefLow</span>
<span class="fc" id="L1153">      s.append(NEWLINE);</span>
<span class="fc" id="L1154">      write(s.toString(), labchem);</span>
<span class="fc" id="L1155">    }</span>

    // institution.setHeader(&quot;InstitutionSID,Sta3n,InstitutionName,InstitutionCode&quot;);
<span class="fc" id="L1158">    int institutionSID = 0;</span>
<span class="fc" id="L1159">    s.setLength(0);</span>
<span class="pc bpc" id="L1160" title="1 of 2 branches missed.">    if (sta3nValue != null) {</span>
<span class="fc" id="L1161">      s.append(sta3nValue).append(',');</span>
<span class="fc" id="L1162">      s.append(&quot;Diagnostic Laboratory&quot;).append(',');</span>
<span class="fc" id="L1163">      s.append(sta3nValue);</span>
<span class="fc" id="L1164">      institutionSID = institution.addFact(&quot;&quot; + sta3nValue, s.toString());</span>
    } else {
<span class="nc" id="L1166">      s.append(primarySta3n).append(',');</span>
<span class="nc" id="L1167">      s.append(&quot;Diagnostic Laboratory&quot;).append(',');</span>
<span class="nc" id="L1168">      s.append(primarySta3n);</span>
<span class="nc" id="L1169">      institutionSID = institution.addFact(&quot;&quot; + primarySta3n, s.toString());</span>
    }

    // topography.setHeader(&quot;TopographySID,Topography&quot;);
<span class="fc" id="L1173">    int topographySID = topography.addFact(code.code, clean(code.display) + &quot; Specimen&quot;);</span>

    // patientlabchem.write(&quot;LabChemSID,Sta3n,LabPanelSID,PatientSID,LabChemSpecimenDateTime,&quot;
    // + &quot;LabChemCompleteDateTime,TopographySID,AccessionInstitutionSID&quot;);
<span class="fc" id="L1177">    s.setLength(0);</span>
<span class="fc" id="L1178">    int patientlabchemSID = getNextKey(patientlabchem);</span>
<span class="fc" id="L1179">    s.append(patientlabchemSID).append(',');</span>
<span class="pc bpc" id="L1180" title="1 of 2 branches missed.">    if (sta3nValue != null) {</span>
<span class="fc" id="L1181">      s.append(sta3nValue);</span>
    } else {
<span class="nc" id="L1183">      s.append(primarySta3n);</span>
    }
<span class="fc" id="L1185">    s.append(',');</span>
<span class="fc" id="L1186">    s.append(labpanelSID).append(',');</span>
<span class="fc" id="L1187">    s.append(personID).append(',');</span>
<span class="fc" id="L1188">    s.append(iso8601Timestamp(report.start)).append(','); // LabChemSpecimenDateTime</span>
<span class="fc" id="L1189">    s.append(iso8601Timestamp(report.start)).append(','); // LabChemCompleteDateTime</span>
<span class="fc" id="L1190">    s.append(topographySID).append(',');</span>
<span class="fc" id="L1191">    s.append(institutionSID);</span>
<span class="fc" id="L1192">    s.append(NEWLINE);</span>
<span class="fc" id="L1193">    write(s.toString(), patientlabchem);</span>
<span class="fc" id="L1194">  }</span>

<span class="fc" id="L1196">  private static final Map&lt;String,String&gt; VITALS = vitalSignCodes();</span>

  private static Map&lt;String,String&gt; vitalSignCodes() {
<span class="fc" id="L1199">    Map&lt;String,String&gt; codes = new HashMap&lt;String,String&gt;();</span>
<span class="fc" id="L1200">    codes.put(&quot;29463-7&quot;, &quot;4500639&quot;);</span>
<span class="fc" id="L1201">    codes.put(&quot;55284-4&quot;, &quot;4500634&quot;);</span>
<span class="fc" id="L1202">    codes.put(&quot;72514-3&quot;, &quot;4500635&quot;);</span>
<span class="fc" id="L1203">    codes.put(&quot;8302-2&quot;, &quot;4688724&quot;);</span>
<span class="fc" id="L1204">    return codes;</span>
  }

  /**
   * Write a single Observation to the tables.
   *
   * @param personID ID of the person to whom the observation applies.
   * @param encounterID The ID of the encounter
   * @param encounter The encounter
   * @param primarySta3n The primary home sta3n for the patient
   * @param observation The observation itself
   * @throws IOException if any IO error occurs
   */
  private void observation(int personID, int encounterID, Encounter encounter,
      int primarySta3n, Observation observation) throws IOException {
<span class="fc" id="L1219">    String code = observation.codes.get(0).code;</span>

<span class="fc bfc" id="L1221" title="All 2 branches covered.">    if (!VITALS.containsKey(code)) {</span>
<span class="fc" id="L1222">      return;</span>
    }

<span class="fc" id="L1225">    Integer sta3nValue = primarySta3n;</span>
<span class="fc" id="L1226">    Integer providerSID = (sidStart / 10_000);</span>
<span class="fc" id="L1227">    Integer locationSID = null;</span>
<span class="pc bpc" id="L1228" title="1 of 2 branches missed.">    if (encounter.provider != null) {</span>
<span class="fc" id="L1229">      String state = Location.getStateName(encounter.provider.state);</span>
<span class="fc" id="L1230">      String tz = Location.getTimezoneByState(state);</span>
<span class="fc" id="L1231">      sta3nValue = sta3n.addFact(encounter.provider.id, clean(encounter.provider.name) + &quot;,&quot; + tz);</span>
<span class="fc" id="L1232">      locationSID = location.addFact(encounter.provider.id, clean(encounter.provider.name));</span>
<span class="fc" id="L1233">      providerSID = (Integer) encounter.provider.attributes.get(CLINICIAN_SID);</span>
    }

    // vitalType.setHeader(&quot;VitalTypeSID,VitalType,VUID&quot;);
<span class="fc" id="L1237">    int vitalTypeSID = vitalType.addFact(code, code + &quot;,&quot; + VITALS.get(code));</span>

    // &quot;VitalSignSID,Sta3n,VitalSignTakenDateTime,PatientSID,VitalTypeSID,VitalResult&quot;
    // &quot;Systolic,Diastolic,SupplementalO2,LocationSID,StaffSID,EnteredInErrorFlag&quot;
<span class="fc" id="L1241">    StringBuilder s = new StringBuilder();</span>
<span class="fc" id="L1242">    s.append(getNextKey(vitalSign)).append(',');</span>
<span class="fc" id="L1243">    s.append(sta3nValue).append(',');</span>
<span class="fc" id="L1244">    s.append(iso8601Timestamp(observation.start)).append(',');</span>
<span class="fc" id="L1245">    s.append(personID).append(',');</span>
<span class="fc" id="L1246">    s.append(vitalTypeSID).append(',');</span>
<span class="fc" id="L1247">    String value = null;</span>
<span class="pc bpc" id="L1248" title="1 of 5 branches missed.">    switch (code) {</span>
      case &quot;55284-4&quot;: // blood pressure
<span class="fc" id="L1250">        s.append(',');</span>
<span class="fc" id="L1251">        value = ExportHelper.getObservationValue(observation, &quot;8480-6&quot;); // systolic</span>
<span class="pc bpc" id="L1252" title="2 of 4 branches missed.">        if (value != null &amp;&amp; value.indexOf('.') &gt;= 0) {</span>
<span class="fc" id="L1253">          value = value.substring(0, value.indexOf('.'));</span>
<span class="fc" id="L1254">          s.append(value);</span>
        }
<span class="fc" id="L1256">        s.append(',');</span>
<span class="fc" id="L1257">        value = ExportHelper.getObservationValue(observation, &quot;8462-4&quot;); // diastolic</span>
<span class="pc bpc" id="L1258" title="2 of 4 branches missed.">        if (value != null &amp;&amp; value.indexOf('.') &gt;= 0) {</span>
<span class="fc" id="L1259">          value = value.substring(0, value.indexOf('.'));</span>
<span class="fc" id="L1260">          s.append(value);</span>
        }
<span class="fc" id="L1262">        s.append(',');</span>
<span class="fc" id="L1263">        break;</span>
      case &quot;29463-7&quot;: // weight
        // convert from kg to lbs
<span class="fc" id="L1266">        value = String.format(Locale.US, &quot;%.1f&quot;, ((Double) observation.value * 2.20462));</span>
<span class="fc" id="L1267">        s.append(value).append(&quot;,,,&quot;);</span>
<span class="fc" id="L1268">        break;</span>
      case &quot;8302-2&quot;: // height
        // convert from cm to inches
<span class="fc" id="L1271">        value = String.format(Locale.US, &quot;%.1f&quot;, ((Double) observation.value * 0.393701));</span>
<span class="fc" id="L1272">        s.append(value).append(&quot;,,,&quot;);</span>
<span class="fc" id="L1273">        break;</span>
      case &quot;72514-3&quot;: // pain
<span class="fc" id="L1275">        value = String.format(&quot;%d&quot;, StrictMath.round((Double) observation.value));</span>
<span class="fc" id="L1276">        s.append(value).append(&quot;,,,&quot;);</span>
<span class="fc" id="L1277">        break;</span>
      default:
<span class="nc" id="L1279">        s.append(&quot;,,,&quot;);</span>
    }
<span class="fc" id="L1281">    s.append(','); // SupplementalO2</span>
<span class="fc" id="L1282">    s.append(locationSID).append(&quot;,&quot;);</span>
<span class="fc" id="L1283">    s.append(providerSID).append(&quot;,&quot;);</span>
<span class="fc" id="L1284">    s.append(&quot;,&quot;); // EnteredInErrorFlag</span>
<span class="fc" id="L1285">    s.append(NEWLINE);</span>
<span class="fc" id="L1286">    write(s.toString(), vitalSign);</span>
<span class="fc" id="L1287">  }</span>

  /**
   * Write a Procedure to the tables.
   *
   * @param personID ID of the person on whom the procedure was performed.
   * @param encounterID ID of the encounter where the procedure was performed
   * @param encounter The encounter
   * @param procedure The procedure itself
   * @param primarySta3n The primary home sta3n for the patient
   * @throws IOException if any IO error occurs
   */
  private void procedure(int personID, int encounterID, Encounter encounter,
      Procedure procedure, int primarySta3n) throws IOException {
<span class="fc" id="L1301">    StringBuilder s = new StringBuilder();</span>

<span class="fc" id="L1303">    Integer sta3nValue = primarySta3n;</span>
<span class="fc" id="L1304">    Integer providerSID = (sidStart / 10_000);</span>
<span class="pc bpc" id="L1305" title="1 of 2 branches missed.">    if (encounter.provider != null) {</span>
<span class="fc" id="L1306">      String state = Location.getStateName(encounter.provider.state);</span>
<span class="fc" id="L1307">      String tz = Location.getTimezoneByState(state);</span>
<span class="fc" id="L1308">      sta3nValue = sta3n.addFact(encounter.provider.id, clean(encounter.provider.name) + &quot;,&quot; + tz);</span>
<span class="fc" id="L1309">      providerSID = (Integer) encounter.provider.attributes.get(CLINICIAN_SID);</span>
    }

    // cprsorder.write(&quot;CPRSOrderID,Sta3n,PatientSID,OrderStaffSID,EnteredByStaffSID,&quot;
    //   + &quot;EnteredDateTime,OrderStatusSID,VistaPackageSID,OrderStartDateTime,OrderStopDateTime,&quot;
    //   + &quot;PackageReference&quot;);
<span class="fc" id="L1315">    int cprsSID = getNextKey(cprsorder);</span>
<span class="fc" id="L1316">    s.setLength(0);</span>
<span class="fc" id="L1317">    s.append(cprsSID).append(',');</span>
<span class="fc" id="L1318">    s.append(sta3nValue).append(',');</span>
<span class="fc" id="L1319">    s.append(personID).append(',');</span>
<span class="fc" id="L1320">    s.append(providerSID).append(&quot;,&quot;); // OrderStaffSID</span>
<span class="fc" id="L1321">    s.append(providerSID).append(&quot;,&quot;); // EnteredByStaffSID</span>
<span class="fc" id="L1322">    s.append(iso8601Timestamp(procedure.start)).append(',');</span>
<span class="fc" id="L1323">    int orderStatusSID = orderStatus.addFact(&quot;COMPLETED&quot;, &quot;COMPLETED&quot;);</span>
<span class="fc" id="L1324">    s.append(orderStatusSID).append(',');</span>
<span class="fc" id="L1325">    int vistaPackageSID = vistaPackage.addFact(&quot;PROCEDURE&quot;, &quot;PROCEDURE&quot;);</span>
<span class="fc" id="L1326">    s.append(vistaPackageSID).append(',');</span>
<span class="fc" id="L1327">    s.append(iso8601Timestamp(procedure.start)).append(',');</span>
<span class="pc bpc" id="L1328" title="1 of 2 branches missed.">    if (procedure.stop != 0L) {</span>
<span class="fc" id="L1329">      s.append(iso8601Timestamp(procedure.stop));</span>
    }
<span class="fc" id="L1331">    s.append(',');</span>
<span class="fc" id="L1332">    s.append(&quot;PROCEDURE&quot;);</span>
<span class="fc" id="L1333">    s.append(NEWLINE);</span>
<span class="fc" id="L1334">    write(s.toString(), cprsorder);</span>

    //surgeryPRE.write(&quot;SurgerySID,VisitSID,NonORLocationSID,SurgeryCancelReasonSID,CPRSOrderSID&quot;)
<span class="fc" id="L1337">    int surgerySID = getNextKey(surgeryPRE);</span>
<span class="fc" id="L1338">    s.setLength(0);</span>
<span class="fc" id="L1339">    s.append(surgerySID).append(',');</span>
<span class="fc" id="L1340">    s.append(encounterID).append(',');</span>
<span class="fc" id="L1341">    s.append(sta3nValue).append(',');</span>
<span class="fc" id="L1342">    s.append(','); // SurgeryCancelReasonSID</span>
<span class="fc" id="L1343">    s.append(cprsSID);</span>
<span class="fc" id="L1344">    s.append(NEWLINE);</span>
<span class="fc" id="L1345">    write(s.toString(), surgeryPRE);</span>

<span class="fc" id="L1347">    Code code = procedure.codes.get(0);</span>
    //Code reason = procedure.reasons.get(0);
    //cpt.setHeader(&quot;CPTSID,CPTCode,CPTName,CPTDescription&quot;);
<span class="fc" id="L1350">    int cptSID = cpt.addFact(code.code, &quot;XXXXX,&quot; + clean(code.display) + &quot;,&quot; + clean(code.display));</span>

    //surgeryProcedureDiagnosisCode.write(&quot;SurgeryProcedureDiagnosisCodeSID,SurgerySID,Sta3n,&quot;
    //    + &quot;PrincipalCPTSID,PatientSID,SurgeryDateTime,PrincipalPostOpICD9SID,&quot;
    //    + &quot;PrincipalPostOpICD10SID,CodingCompleteFlag&quot;);
<span class="fc" id="L1355">    int spdcSID = getNextKey(surgeryProcedureDiagnosisCode);</span>
<span class="fc" id="L1356">    s.setLength(0);</span>
<span class="fc" id="L1357">    s.append(spdcSID).append(',');</span>
<span class="fc" id="L1358">    s.append(surgerySID).append(',');</span>
<span class="fc" id="L1359">    s.append(sta3nValue).append(',');</span>
<span class="fc" id="L1360">    s.append(cptSID).append(',');</span>
<span class="fc" id="L1361">    s.append(personID).append(',');</span>
<span class="fc" id="L1362">    s.append(iso8601Timestamp(procedure.start)).append(',');</span>
<span class="fc" id="L1363">    s.append(','); // PrincipalPostOpICD9SID</span>
<span class="fc" id="L1364">    s.append(','); // PrincipalPostOpICD10SID</span>
<span class="fc" id="L1365">    s.append('1'); // CodingCompleteFlag</span>
<span class="fc" id="L1366">    s.append(NEWLINE);</span>
<span class="fc" id="L1367">    write(s.toString(), surgeryProcedureDiagnosisCode);</span>
<span class="fc" id="L1368">  }</span>

  /**
   * Write a single Medication to the tables.
   *
   * @param personID ID of the person prescribed the medication.
   * @param encounterID ID of the encounter where the medication was prescribed
   * @param encounter The encounter
   * @param medication The medication itself
   * @param primarySta3n The primary home sta3n for the patient
   * @throws IOException if any IO error occurs
   */
  private void medication(int personID, int encounterID, Encounter encounter,
      Medication medication, int primarySta3n) throws IOException {
<span class="fc" id="L1382">    StringBuilder s = new StringBuilder();</span>

<span class="fc" id="L1384">    Integer sta3nValue = primarySta3n;</span>
<span class="fc" id="L1385">    Integer providerSID = (sidStart / 10_000);</span>
<span class="pc bpc" id="L1386" title="1 of 2 branches missed.">    if (encounter.provider != null) {</span>
<span class="fc" id="L1387">      String state = Location.getStateName(encounter.provider.state);</span>
<span class="fc" id="L1388">      String tz = Location.getTimezoneByState(state);</span>
<span class="fc" id="L1389">      sta3nValue = sta3n.addFact(encounter.provider.id, clean(encounter.provider.name) + &quot;,&quot; + tz);</span>
<span class="fc" id="L1390">      providerSID = (Integer) encounter.provider.attributes.get(CLINICIAN_SID);</span>
    }
<span class="fc" id="L1392">    Code code = medication.codes.get(0);</span>

    // pharmacyOrderableItem (&quot;PharmacyOrderableItemSID,PharmacyOrderableItem,SupplyFlag&quot;);
<span class="fc" id="L1395">    int pharmSID = pharmacyOrderableItem.addFact(code.code, clean(code.display) + &quot;,1&quot;);</span>

    // dosageForm.setHeader(&quot;DosageFormSID,DosageFormIEN,DosageForm&quot;);
<span class="fc" id="L1398">    Integer dosageSID = 1; // Default Dosage SID</span>
<span class="fc bfc" id="L1399" title="All 2 branches covered.">    if (medication.prescriptionDetails != null</span>
<span class="fc bfc" id="L1400" title="All 2 branches covered.">        &amp;&amp; medication.prescriptionDetails.has(&quot;dosage&quot;)) {</span>
<span class="fc" id="L1401">      JsonObject dosage = medication.prescriptionDetails.get(&quot;dosage&quot;).getAsJsonObject();</span>
<span class="fc" id="L1402">      s.setLength(0);</span>
<span class="fc" id="L1403">      s.append(dosage.get(&quot;amount&quot;).getAsInt());</span>
<span class="fc" id="L1404">      s.append(&quot; dose(s) &quot;);</span>
<span class="fc" id="L1405">      s.append(dosage.get(&quot;frequency&quot;).getAsInt());</span>
<span class="fc" id="L1406">      s.append(&quot; time(s) per &quot;);</span>
<span class="fc" id="L1407">      s.append(dosage.get(&quot;period&quot;).getAsInt());</span>
<span class="fc" id="L1408">      s.append(&quot; &quot;);</span>
<span class="fc" id="L1409">      s.append(dosage.get(&quot;unit&quot;).getAsString());</span>
<span class="fc" id="L1410">      dosageSID = dosageForm.addFact(code.code, pharmSID + &quot;,&quot; + s.toString());</span>
    }

    // nationalDrug.setHeader(&quot;NationalDrugSID,DrugNameWithDose,DosageFormSID,&quot;
    //    + &quot;InactivationDate,VUID&quot;);
<span class="fc" id="L1415">    s.setLength(0);</span>
<span class="fc" id="L1416">    s.append(clean(code.display));</span>
<span class="fc" id="L1417">    s.append(',');</span>
<span class="fc" id="L1418">    s.append(dosageSID);</span>
<span class="fc" id="L1419">    s.append(&quot;,,&quot;);</span>
<span class="fc" id="L1420">    s.append(code.code);</span>
<span class="fc" id="L1421">    int ndrugSID = nationalDrug.addFact(code.code, s.toString());</span>

    // localDrug.setHeader(&quot;LocalDrugSID,LocalDrugIEN,Sta3n,LocalDrugNameWithDose,&quot;
    //    + &quot;NationalDrugSID,NationalDrugNameWithDose,PharmacyOrderableItemSID&quot;);
<span class="fc" id="L1425">    s.setLength(0);</span>
<span class="fc" id="L1426">    s.append(ndrugSID).append(',');</span>
<span class="fc" id="L1427">    s.append(sta3nValue).append(',');</span>
<span class="fc" id="L1428">    s.append(clean(code.display)).append(',');</span>
<span class="fc" id="L1429">    s.append(ndrugSID).append(',');</span>
<span class="fc" id="L1430">    s.append(clean(code.display)).append(',');</span>
<span class="fc" id="L1431">    s.append(pharmSID);</span>
<span class="fc" id="L1432">    final int ldrugSID = localDrug.addFact(code.code, s.toString());</span>

    // rxoutpatient.write(&quot;RxOutpatSID,Sta3n,RxNumber,IssueDate,CancelDate,FinishingDateTime,&quot;
    //    + &quot;PatientSID,ProviderSID,EnteredByStaffSID,LocalDrugSID,NationalDrugSID,&quot;
    //    + &quot;PharmacyOrderableItemSID,MaxRefills,RxStatus,OrderedQuantity&quot;);
<span class="fc" id="L1437">    s.setLength(0);</span>
<span class="fc" id="L1438">    int rxNum = getNextKey(rxoutpatient);</span>
<span class="fc" id="L1439">    s.append(rxNum).append(',');</span>
<span class="fc" id="L1440">    s.append(sta3nValue).append(',');</span>
<span class="fc" id="L1441">    s.append(rxNum).append(',');</span>
<span class="fc" id="L1442">    s.append(iso8601Timestamp(medication.start)).append(',');</span>
<span class="fc bfc" id="L1443" title="All 2 branches covered.">    if (medication.stop != 0L) {</span>
<span class="fc" id="L1444">      s.append(iso8601Timestamp(medication.stop));</span>
    }
<span class="fc" id="L1446">    s.append(',');</span>
<span class="fc bfc" id="L1447" title="All 2 branches covered.">    if (medication.prescriptionDetails != null</span>
<span class="fc bfc" id="L1448" title="All 2 branches covered.">        &amp;&amp; medication.prescriptionDetails.has(&quot;duration&quot;)) {</span>
<span class="fc" id="L1449">      JsonObject duration = medication.prescriptionDetails.get(&quot;duration&quot;).getAsJsonObject();</span>
<span class="fc" id="L1450">      long time = Utilities.convertTime(</span>
<span class="fc" id="L1451">          duration.get(&quot;unit&quot;).getAsString(), duration.get(&quot;quantity&quot;).getAsLong());</span>
<span class="fc" id="L1452">      s.append(iso8601Timestamp(medication.start + time));</span>
    }
<span class="fc" id="L1454">    s.append(',');</span>
<span class="fc" id="L1455">    s.append(personID).append(',');</span>
<span class="fc" id="L1456">    s.append(providerSID).append(&quot;,&quot;); // Provider</span>
<span class="fc" id="L1457">    s.append(providerSID).append(&quot;,&quot;); // Entered by staff</span>
<span class="fc" id="L1458">    s.append(ldrugSID).append(',');</span>
<span class="fc" id="L1459">    s.append(ndrugSID).append(',');</span>
<span class="fc" id="L1460">    s.append(pharmSID).append(',');</span>
<span class="fc bfc" id="L1461" title="All 2 branches covered.">    if (medication.prescriptionDetails != null</span>
<span class="fc bfc" id="L1462" title="All 2 branches covered.">        &amp;&amp; medication.prescriptionDetails.has(&quot;refills&quot;)) {</span>
<span class="fc" id="L1463">      s.append(medication.prescriptionDetails.get(&quot;refills&quot;).getAsInt());</span>
    }
<span class="fc" id="L1465">    s.append(',');</span>
<span class="fc bfc" id="L1466" title="All 2 branches covered.">    if (medication.stop == 0L) {</span>
<span class="fc" id="L1467">      s.append(&quot;ACTIVE,&quot;);</span>
    } else {
<span class="fc" id="L1469">      s.append(&quot;EXPIRED,&quot;);</span>
    }
<span class="fc" id="L1471">    s.append(NEWLINE);</span>
<span class="fc" id="L1472">    write(s.toString(), rxoutpatient);</span>

    // rxoutpatfill.write(&quot;RxOutpatFillSID,RxOutpatSID,Qty,DaysSupply&quot;);
<span class="fc" id="L1475">    s.setLength(0);</span>
<span class="fc" id="L1476">    s.append(rxNum).append(',');</span>
<span class="fc" id="L1477">    s.append(rxNum).append(',');</span>
<span class="fc" id="L1478">    s.append(&quot;1,30&quot;);</span>
<span class="fc" id="L1479">    s.append(NEWLINE);</span>
<span class="fc" id="L1480">    write(s.toString(), rxoutpatfill);</span>

    // cprsorder.write(&quot;CPRSOrderID,Sta3n,PatientSID,OrderStaffSID,EnteredByStaffSID,&quot;
    //    + &quot;EnteredDateTime,OrderStatusSID,VistaPackageSID,OrderStartDateTime,OrderStopDateTime,&quot;
    //    + &quot;PackageReference&quot;);
<span class="fc" id="L1485">    int cprsSID = getNextKey(cprsorder);</span>
<span class="fc" id="L1486">    s.setLength(0);</span>
<span class="fc" id="L1487">    s.append(cprsSID).append(',');</span>
<span class="fc" id="L1488">    s.append(sta3nValue).append(',');</span>
<span class="fc" id="L1489">    s.append(personID).append(',');</span>
<span class="fc" id="L1490">    s.append(providerSID).append(&quot;,&quot;); // OrderStaffSID</span>
<span class="fc" id="L1491">    s.append(providerSID).append(&quot;,&quot;); // EnteredByStaffSID</span>
<span class="fc" id="L1492">    s.append(iso8601Timestamp(medication.start)).append(',');</span>
<span class="fc" id="L1493">    int orderStatusSID = -1;</span>
<span class="fc bfc" id="L1494" title="All 2 branches covered.">    if (medication.stop != 0L) {</span>
<span class="fc" id="L1495">      orderStatusSID = orderStatus.addFact(&quot;EXPIRED&quot;, &quot;EXPIRED&quot;);</span>
    } else {
<span class="fc" id="L1497">      orderStatusSID = orderStatus.addFact(&quot;ACTIVE&quot;, &quot;ACTIVE&quot;);</span>
    }
<span class="fc" id="L1499">    s.append(orderStatusSID).append(',');</span>
<span class="fc" id="L1500">    s.append(vistaPackage.addFact(&quot;OUTPATIENT PHARMACY&quot;, &quot;OUTPATIENT PHARMACY&quot;)).append(',');</span>
<span class="fc" id="L1501">    s.append(iso8601Timestamp(medication.start)).append(',');</span>
<span class="fc bfc" id="L1502" title="All 2 branches covered.">    if (medication.stop != 0L) {</span>
<span class="fc" id="L1503">      s.append(iso8601Timestamp(medication.stop));</span>
    }
<span class="fc" id="L1505">    s.append(',');</span>
<span class="fc" id="L1506">    s.append(&quot;OUTPATIENT PHARMACY&quot;);</span>
<span class="fc" id="L1507">    s.append(NEWLINE);</span>
<span class="fc" id="L1508">    write(s.toString(), cprsorder);</span>

    // orderableItem (&quot;OrderableItemSID,OrderableItemName,IVBaseFlag,IVAdditiveFlag&quot;);
<span class="fc" id="L1511">    int orderSID = orderableItem.addFact(code.code, clean(code.display) + &quot;,0,0&quot;);</span>

    // ordereditem.write(&quot;OrderedItemSID,CPRSOrderSID,OrderableItemSID&quot;);
<span class="fc" id="L1514">    s.setLength(0);</span>
<span class="fc" id="L1515">    s.append(cprsSID).append(&quot;,&quot;);</span>
<span class="fc" id="L1516">    s.append(cprsSID).append(&quot;,&quot;);</span>
<span class="fc" id="L1517">    s.append(orderSID).append(NEWLINE);</span>
<span class="fc" id="L1518">    write(s.toString(), ordereditem);</span>

    // nonvamed.write(&quot;NonVAMedSID,PatientSID,NonVAMedIEN,Sta3n,LocalDrugSID,Dosage,&quot;
    //    + &quot;MedicationRoute,Schedule,NonVAMedStatus,CPRSOrderSID,StartDateTime,&quot;
    //    + &quot;DocumentedDateTime,NonVAMedComments&quot;);
<span class="fc" id="L1523">    s.setLength(0);</span>
<span class="fc" id="L1524">    int nonvamedSID = getNextKey(nonvamed);</span>
<span class="fc" id="L1525">    s.append(nonvamedSID).append(',');</span>
<span class="fc" id="L1526">    s.append(personID).append(',');</span>
<span class="fc" id="L1527">    s.append(nonvamedSID).append(',');</span>
<span class="fc" id="L1528">    s.append(sta3nValue).append(',');</span>
<span class="fc" id="L1529">    s.append(ldrugSID).append(',');</span>
<span class="pc bpc" id="L1530" title="1 of 2 branches missed.">    if (dosageSID != null) {</span>
<span class="fc" id="L1531">      String fact = dosageForm.getFactById(dosageSID);</span>
<span class="fc" id="L1532">      s.append(fact.substring(fact.indexOf(',') + 1));</span>
    }
<span class="fc" id="L1534">    s.append(',');</span>
<span class="fc" id="L1535">    s.append(&quot;As directed by physician.,&quot;); // MedicationRoute</span>
<span class="fc" id="L1536">    s.append(&quot;As directed by physician.,&quot;); // Schedule</span>
<span class="fc" id="L1537">    s.append(orderStatus.getFactById(orderStatusSID)).append(',');</span>
<span class="fc" id="L1538">    s.append(cprsSID).append(',');</span>
<span class="fc" id="L1539">    s.append(iso8601Timestamp(medication.start)).append(',');</span>
<span class="fc" id="L1540">    s.append(iso8601Timestamp(medication.start)).append(',');</span>
<span class="fc" id="L1541">    s.append(clean(code.display));</span>
<span class="fc" id="L1542">    s.append(NEWLINE);</span>
<span class="fc" id="L1543">    write(s.toString(), nonvamed);</span>
<span class="fc" id="L1544">  }</span>

  /**
   * Write a single Immunization to the tables.
   *
   * @param personID ID of the person on whom the immunization was performed.
   * @param person The person
   * @param encounterID ID of the encounter where the immunization was performed
   * @param encounter The encounter itself
   * @param immunization The immunization itself
   * @param primarySta3n The primary home sta3n for the patient
   * @throws IOException if any IO error occurs
   */
  private void immunization(int personID, Person person, int encounterID, Encounter encounter,
      Immunization immunizationEntry, int primarySta3n) throws IOException  {
<span class="fc" id="L1559">    StringBuilder s = new StringBuilder();</span>

    // immunization.write(&quot;ImmunizationSID,ImmunizationIEN,Sta3n,PatientSID,ImmunizationNameSID,&quot;
    // + &quot;Series,Reaction,VisitDateTime,ImmunizationDateTime,OrderingStaffSID,ImmunizingStaffSID,&quot;
    // + &quot;VisitSID,ImmunizationComments,ImmunizationRemarks&quot;);
<span class="fc" id="L1564">    int immunizationSid = getNextKey(immunization);</span>
<span class="fc" id="L1565">    s.append(immunizationSid).append(',');</span>
<span class="fc" id="L1566">    s.append(immunizationSid).append(','); // ImmunizationIEN</span>
<span class="fc" id="L1567">    Integer providerSID = (sidStart / 10_000);</span>
<span class="pc bpc" id="L1568" title="1 of 2 branches missed.">    if (encounter.provider != null) {</span>
<span class="fc" id="L1569">      String state = Location.getStateName(encounter.provider.state);</span>
<span class="fc" id="L1570">      String tz = Location.getTimezoneByState(state);</span>
<span class="fc" id="L1571">      s.append(sta3n.addFact(encounter.provider.id, clean(encounter.provider.name) + &quot;,&quot; + tz));</span>
<span class="fc" id="L1572">      providerSID = (Integer) encounter.provider.attributes.get(CLINICIAN_SID);</span>
<span class="fc" id="L1573">    } else {</span>
<span class="nc" id="L1574">      s.append(primarySta3n);</span>
    }
<span class="fc" id="L1576">    s.append(',');</span>
<span class="fc" id="L1577">    s.append(personID).append(',');</span>
<span class="fc" id="L1578">    Code cvx = immunizationEntry.codes.get(0);</span>
<span class="fc" id="L1579">    int maxInSeries = Immunizations.getMaximumDoses(cvx.code);</span>
<span class="fc" id="L1580">    s.append(</span>
<span class="fc" id="L1581">        immunizationName.addFact(</span>
<span class="fc" id="L1582">            cvx.code, clean(cvx.display) + &quot;,&quot; + cvx.code + &quot;,&quot; + maxInSeries));</span>
<span class="fc" id="L1583">    int series = immunizationEntry.series;</span>
<span class="fc bfc" id="L1584" title="All 2 branches covered.">    if (series == maxInSeries) {</span>
<span class="fc" id="L1585">      s.append(&quot;,C,&quot;);</span>
    } else {
<span class="fc" id="L1587">      s.append(&quot;,B,&quot;);</span>
    }
<span class="fc" id="L1589">    s.append(person.randInt(12)).append(','); // Reaction</span>
<span class="fc" id="L1590">    s.append(iso8601Timestamp(immunizationEntry.start)).append(',');</span>
<span class="fc" id="L1591">    s.append(iso8601Timestamp(immunizationEntry.start)).append(',');</span>
<span class="fc" id="L1592">    s.append(providerSID).append(&quot;,&quot;); // OrderingStaffSID</span>
<span class="fc" id="L1593">    s.append(providerSID).append(&quot;,&quot;); // ImmunizingStaffSID</span>
<span class="fc" id="L1594">    s.append(encounterID).append(',');</span>
    // Comment
<span class="fc" id="L1596">    s.append(&quot;Dose #&quot; + series + &quot; of &quot; + maxInSeries + &quot; of &quot;</span>
<span class="fc" id="L1597">        + clean(cvx.display) + &quot; vaccine administered.,&quot;);</span>
    // Remark
<span class="fc" id="L1599">    s.append(&quot;Dose #&quot; + series + &quot; of &quot; + maxInSeries + &quot; of &quot;</span>
<span class="fc" id="L1600">        + clean(cvx.display) + &quot; vaccine administered.&quot;);</span>
<span class="fc" id="L1601">    s.append(NEWLINE);</span>
<span class="fc" id="L1602">    write(s.toString(), immunization);</span>
<span class="fc" id="L1603">  }</span>

  private int getNextKey(FileWriter table) {
<span class="fc" id="L1606">    synchronized (sids) {</span>
<span class="fc" id="L1607">      return sids.computeIfAbsent(table, k -&gt; new AtomicInteger(sidStart)).getAndIncrement();</span>
    }
  }
  
  /**
   * Replaces commas and line breaks in the source string with a single space.
   * Null is replaced with the empty string.
   */
  private static String clean(String src) {
<span class="pc bpc" id="L1616" title="1 of 2 branches missed.">    if (src == null) {</span>
<span class="nc" id="L1617">      return &quot;&quot;;</span>
    } else {
<span class="fc" id="L1619">      return src.replaceAll(&quot;\\r\\n|\\r|\\n|,&quot;, &quot; &quot;).trim();</span>
    }
  }

  /**
   * Helper method to write a line to a File.
   * Extracted to a separate method here to make it a little easier to replace implementations.
   *
   * @param line The line to write
   * @param writer The place to write it
   * @throws IOException if an I/O error occurs
   */
  private static void write(String line, FileWriter writer) throws IOException {
<span class="fc" id="L1632">    synchronized (writer) {</span>
<span class="fc" id="L1633">      writer.write(line);</span>
<span class="fc" id="L1634">      writer.flush();</span>
<span class="fc" id="L1635">    }</span>
<span class="fc" id="L1636">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>